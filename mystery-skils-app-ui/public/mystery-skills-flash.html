<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYSTERY SKILLS | Agentic Brutalism</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --obsidian: #010101;
            --neon-teal: #00ffcc;
            --neon-green: #39ff14;
            --neon-blue: #00f0ff;
            --neon-amber: #ffaa00;
            --neon-red: #ff3131;
            --glass-border: rgba(0, 255, 204, 0.3);
            --glass-bg: rgba(1, 1, 1, 0.75);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: crosshair;
        }

        body {
            background-color: var(--obsidian);
            color: var(--neon-teal);
            font-family: 'JetBrains Mono', monospace;
            overflow-x: hidden;
            scrollbar-width: none;
        }

        ::-webkit-scrollbar { display: none; }

        /* Scanline Overlay */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 100;
            opacity: 0.3;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 255, 204, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: perspective(1000px) rotateX(2deg) rotateY(-2deg);
            box-shadow: 0 12px 48px 0 rgba(0, 255, 204, 0.2);
        }

        .glitch-text {
            text-shadow: 2px 0 var(--neon-red), -2px 0 var(--neon-blue);
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0% { text-shadow: 2px 0 var(--neon-red), -2px 0 var(--neon-blue); }
            50% { text-shadow: -2px 0 var(--neon-red), 2px 0 var(--neon-blue); }
            100% { text-shadow: 2px 0 var(--neon-red), -2px 0 var(--neon-blue); }
        }

        .laser-btn {
            position: relative;
            overflow: hidden;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 1rem 2rem;
            background: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 800;
            transition: 0.3s;
        }

        .laser-btn::after {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 10px;
            background: var(--neon-green);
            box-shadow: 0 0 15px var(--neon-green);
            animation: scan 3s infinite linear;
            opacity: 0.5;
        }

        @keyframes scan {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--neon-teal);
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 11px;
            max-width: 350px;
            pointer-events: auto;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.3);
        }
        .toast.success { border-color: var(--neon-green); }
        .toast.error { border-color: var(--neon-red); }
        .toast.info { border-color: var(--neon-blue); }
        .toast-title { font-weight: bold; margin-bottom: 4px; }
        .toast.success .toast-title { color: var(--neon-green); }
        .toast.error .toast-title { color: var(--neon-red); }
        .toast.info .toast-title { color: var(--neon-blue); }
        .toast-message { color: white; font-size: 10px; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .skill-node {
            width: 40px;
            height: 40px;
            border: 1px solid var(--neon-teal);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 255, 204, 0.1);
        }

        .data-packet {
            width: 6px;
            height: 6px;
            background: var(--neon-teal);
            border-radius: 50%;
            position: absolute;
            filter: blur(1px);
            box-shadow: 0 0 8px var(--neon-teal);
        }

        .page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            padding: 2rem;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            overflow-y: auto;
            z-index: 10;
        }

        .page.active {
            display: block;
            opacity: 1;
            z-index: 20;
        }

        /* Dashboard HUD elements */
        .hud-ring {
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 2s ease-out;
            transform: rotate(-90deg);
            transform-origin: center;
        }

        .terminal-scroll {
            font-size: 0.75rem;
            color: var(--neon-green);
            height: 200px;
            overflow-y: auto;
        }

        .struggle-alert {
            animation: alert-pulse 1s infinite;
        }

        @keyframes alert-pulse {
            0%, 100% { background: rgba(255, 170, 0, 0.1); border-color: var(--neon-amber); }
            50% { background: rgba(255, 49, 49, 0.3); border-color: var(--neon-red); transform: scale(1.02); }
        }

        .heartbeat {
            animation: heart 1.5s ease-in-out infinite;
        }

        @keyframes heart {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.5; }
        }

        #three-hero-container, #three-dashboard-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
    </style>
</head>
<body>

<div class="scanlines"></div>

<!-- Toast Notifications Container -->
<div id="toast-container" class="toast-container"></div>

<!-- PAGE 1: HERO LANDING -->
<section id="landing" class="page active relative flex flex-col items-center justify-center">
    <div id="three-hero-container"></div>

    <div class="z-10 text-center space-y-8 max-w-5xl">
        <div class="inline-block px-4 py-1 border border-teal-500 text-xs tracking-widest mb-4 opacity-70">
            SECURE ACCESS PROTOCOL // SYEDA ALISHBA FATIMA
        </div>
        <h1 class="text-6xl md:text-8xl font-black leading-none uppercase glitch-text">
            Initializing<br>The Learning<br>Revolution
        </h1>

        <div class="flex justify-center items-center gap-12 py-12">
            <div class="skill-node" title="Claude Code">C</div>
            <div class="relative w-48 h-1 bg-teal-900/30">
                <div class="data-packet" style="animation: packetMove 2s infinite linear;"></div>
            </div>
            <div class="skill-node" title="Goose">G</div>
            <div class="relative w-48 h-1 bg-teal-900/30">
                <div class="data-packet" style="animation: packetMove 2s infinite linear 0.5s;"></div>
            </div>
            <div class="skill-node" title="K8s">K</div>
        </div>

        <button onclick="showPage('auth')" class="laser-btn text-xl px-12 mt-8">
            Verify Clearance
        </button>
    </div>

    <div class="absolute bottom-8 left-8 text-[10px] opacity-40 uppercase tracking-tighter">
        Aesthetic: Agentic Brutalism 2025<br>
        Backend: LearnFlow (Triage + Concepts + Progress)<br>
        Status: <span id="backend-status">Checking...</span><br>
        <span style="color: #39ff14;">Build: v1.5.0-bigger-tasks</span>
    </div>
</section>

<!-- PAGE 2: SECURITY HANDSHAKE -->
<section id="auth" class="page flex items-center justify-center bg-[#010101]">
    <div class="glass-card p-12 w-full max-w-2xl">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-2xl font-bold tracking-widest text-white uppercase" id="authModeTitle">Identity Check</h2>
            <div class="flex items-center gap-4">
                <span class="text-[10px] opacity-50">STUDENT</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="roleToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div>
                </label>
                <span class="text-[10px] opacity-50">TEACHER</span>
            </div>
        </div>

        <div class="space-y-6">
            <!-- Name field (only for register) -->
            <div id="nameField" class="border-b border-teal-900 focus-within:border-teal-400 transition">
                <label class="block text-[10px] mb-1 opacity-50">USER_NAME</label>
                <input type="text" id="authName" placeholder="Alishba Fatima" class="w-full bg-transparent border-none outline-none text-teal-400 font-mono py-2">
            </div>

            <!-- Email field -->
            <div class="border-b border-teal-900 focus-within:border-teal-400 transition">
                <label class="block text-[10px] mb-1 opacity-50">EMAIL_ADDRESS</label>
                <input type="email" id="authEmail" placeholder="alishbafatima25@gmail.com" class="w-full bg-transparent border-none outline-none text-teal-400 font-mono py-2">
            </div>

            <!-- Password field -->
            <div class="border-b border-teal-900 focus-within:border-teal-400 transition">
                <label class="block text-[10px] mb-1 opacity-50">ACCESS_KEY</label>
                <div class="flex items-center">
                    <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="flex-1 bg-transparent border-none outline-none text-teal-400 font-mono py-2">
                    <button type="button" onclick="togglePasswordVisibility()" id="passwordToggle" class="text-teal-400 hover:text-white transition px-2">
                        <span id="eyeIcon">üëÅ</span>
                    </button>
                </div>
            </div>

            <!-- Error message -->
            <div id="authError" class="text-red-500 text-xs hidden"></div>

            <!-- Handshake logs -->
            <div id="handshakeLogs" class="terminal-scroll p-4 bg-black/40 border border-teal-950 rounded hidden">
                <!-- Log entries injected here -->
            </div>

            <!-- Main button -->
            <button id="authButton" onclick="startHandshake()" class="w-full py-4 border border-teal-500 hover:bg-teal-500/10 transition text-sm tracking-[0.5em] font-bold">
                ESTABLISH_CONNECTION
            </button>

            <!-- Mode toggle button -->
            <div class="text-center space-y-2">
                <button id="toggleAuthMode" onclick="toggleAuthMode()" class="text-[10px] opacity-50 hover:opacity-100 transition">
                    EXISTING USER? RETURN_TO_LOGIN
                </button>
                <div>
                    <button onclick="clearSession()" class="text-[8px] text-red-400 opacity-50 hover:opacity-100 transition">
                        [CLEAR SESSION]
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- PAGE 3: COMMAND & CONTROL DASHBOARD -->
<section id="dashboard" class="page">
    <!-- FIXED HEADER BAR (hidden initially) -->
    <div id="dashboard-header" class="fixed top-0 left-0 right-0 z-50 bg-black/90 backdrop-blur border-b border-teal-900/50 px-6 py-3 flex justify-between items-center" style="display: none;">
        <div class="flex items-center gap-4">
            <span class="text-teal-400 font-bold text-sm tracking-widest">LEARNFLOW</span>
            <span id="user-role-badge" class="text-[10px] px-2 py-1 bg-teal-900/50 rounded text-white"></span>
        </div>
        <div class="flex items-center gap-4">
            <!-- Notification Bell with Dropdown Container -->
            <div class="relative">
                <button onclick="toggleNotifications()" class="relative text-white hover:text-teal-400 transition p-2" title="Notifications">
                    <span class="text-xl">üîî</span>
                    <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] rounded-full w-5 h-5 flex items-center justify-center font-bold" style="display:none;">0</span>
                </button>
                <!-- Notification Panel Dropdown -->
                <div id="notification-panel" class="hidden absolute top-12 right-0 w-80 bg-black/95 backdrop-blur border border-teal-900 rounded shadow-lg shadow-teal-900/50 max-h-96 overflow-y-auto z-[100]">
                    <div class="p-3 border-b border-teal-900">
                        <div class="text-xs font-bold text-teal-400">NOTIFICATIONS</div>
                        <div id="notification-user-id" class="text-[8px] text-gray-500 mt-1">Loading...</div>
                    </div>
                    <div id="notification-list"></div>
                </div>
            </div>
            <!-- Logout Button -->
            <button onclick="logout()" class="bg-red-600 hover:bg-red-500 text-white text-[10px] font-bold px-4 py-2 rounded transition" title="Logout">
                LOGOUT
            </button>
        </div>
    </div>
    <!-- Main Dashboard Content (with top padding for fixed header) -->
    <div class="pt-16 grid grid-cols-12 gap-6 h-[calc(100vh-4rem)]">

        <!-- Left: Skill Vault OR Teacher Student List -->
        <div class="col-span-3 flex flex-col gap-6">
            <!-- STUDENT VIEW: Learning Progress & Stats -->
            <div id="studentAgentPanel" class="glass-card p-6 flex-1">
                <h3 class="text-xs font-bold mb-4 tracking-widest border-b border-teal-900 pb-2">üìä MY_PROGRESS</h3>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-gradient-to-br from-green-900/40 to-green-800/20 p-3 rounded-lg border border-green-700/30 text-center">
                        <div class="text-2xl font-bold text-green-400" id="student-completed-count">0</div>
                        <div class="text-[9px] text-green-300/70 uppercase tracking-wider">Completed</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-900/40 to-yellow-800/20 p-3 rounded-lg border border-yellow-700/30 text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="student-streak-count">üî• 0</div>
                        <div class="text-[9px] text-yellow-300/70 uppercase tracking-wider">Day Streak</div>
                    </div>
                </div>

                <!-- Current Level -->
                <div class="bg-gradient-to-r from-purple-900/30 to-pink-900/30 p-3 rounded-lg border border-purple-700/30 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] text-purple-300 uppercase tracking-wider">Current Level</span>
                        <span class="text-xs font-bold text-purple-400" id="student-level">Beginner</span>
                    </div>
                    <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-500" id="student-level-progress" style="width: 20%"></div>
                    </div>
                    <div class="text-[8px] text-gray-400 mt-1 text-right" id="student-xp-text">200/1000 XP</div>
                </div>

                <!-- Recent Achievements -->
                <div class="space-y-2">
                    <div class="text-[10px] text-teal-400 uppercase tracking-wider mb-2">üèÜ Achievements</div>
                    <div id="student-achievements" class="space-y-1">
                        <div class="flex items-center gap-2 p-2 bg-gray-800/50 rounded border border-gray-700/50">
                            <span class="text-lg">üåü</span>
                            <div>
                                <div class="text-[10px] font-bold text-white">First Steps</div>
                                <div class="text-[8px] text-gray-400">Complete your first practice</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Tip -->
                <div class="mt-4 p-3 bg-gradient-to-r from-cyan-900/20 to-teal-900/20 rounded-lg border border-cyan-800/30">
                    <div class="text-[10px] text-cyan-400 uppercase tracking-wider mb-1">üí° Tip of the Day</div>
                    <div class="text-[10px] text-gray-300" id="daily-tip">Practice coding daily to build muscle memory!</div>
                </div>
            </div>

            <!-- TEACHER VIEW: Student List -->
            <div id="teacherStudentPanel" class="glass-card p-6 flex-1 overflow-y-auto hidden" style="position: relative; z-index: 50;">
                <div class="flex justify-between items-center mb-6 border-b border-teal-900 pb-2">
                    <h3 class="text-xs font-bold tracking-widest">ALL_STUDENTS</h3>
                    <button onclick="refreshTeacherData()" class="text-[8px] bg-teal-900 px-2 py-1 hover:bg-teal-700 transition">‚Üª REFRESH</button>
                </div>
                <div id="student-list" class="space-y-3" style="position: relative; z-index: 51;">
                    <div class="text-xs text-gray-500">Loading students...</div>
                </div>
            </div>
        </div>

        <!-- Center: Neural Sphere HUD (STUDENT VIEW) -->
        <div id="studentCenterPanel" class="col-span-6 glass-card relative overflow-hidden">
            <!-- Default View: Mastery Overview -->
            <div id="student-overview-view" class="absolute inset-0 flex items-center justify-center">
                <div id="three-dashboard-container"></div>
                <div class="absolute inset-0 pointer-events-none p-8 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div class="text-[10px] leading-tight">
                            NODE: ALISHBA_MAIN<br>
                            ARCH: LEARNFLOW_v1<br>
                            OS: MYSTERY_SKILLS
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black" id="global-mastery">0%</div>
                            <div class="text-[8px] opacity-50 tracking-widest uppercase">Global Mastery</div>
                        </div>
                    </div>
                    <div class="flex justify-center gap-2" id="mastery-bars">
                        <div class="h-1 w-8 bg-gray-700"></div>
                        <div class="h-1 w-8 bg-gray-700"></div>
                        <div class="h-1 w-8 bg-gray-700"></div>
                        <div class="h-1 w-8 bg-gray-700"></div>
                    </div>
                </div>
            </div>

            <!-- Topics List View: Browse & Select Topics -->
            <div id="student-topics-view" class="absolute inset-0 p-6 hidden flex-col bg-black/95">
                <div class="flex justify-between items-center mb-4 border-b border-teal-900 pb-3">
                    <div>
                        <div class="text-teal-400 font-bold text-lg tracking-widest">PRACTICE_TOPICS</div>
                        <div class="text-xs text-gray-400 mt-1">Select a topic to start practicing</div>
                    </div>
                    <button onclick="closeTopicsView()" class="text-xs bg-gray-800 px-4 py-2 text-gray-400 hover:bg-red-900 hover:text-white transition rounded">CLOSE</button>
                </div>
                <input type="text" id="center-topic-search" placeholder="Search topics..." class="bg-gray-900 border border-teal-900 text-white text-sm px-4 py-3 mb-4 rounded-lg w-full">
                <div id="center-topics-list" class="flex-1 overflow-y-auto grid grid-cols-2 gap-3 pr-2">
                    <div class="text-gray-400 text-sm col-span-2 text-center py-8">Loading topics...</div>
                </div>
            </div>

            <!-- Code Lab View: Challenges List (same style as Practice Topics) -->
            <div id="student-codelab-view" class="absolute inset-0 p-6 hidden flex-col bg-black/95">
                <div class="flex justify-between items-center mb-4 border-b border-purple-900 pb-3">
                    <div>
                        <div class="text-purple-400 font-bold text-lg tracking-widest">CODE_LAB</div>
                        <div class="text-xs text-gray-400 mt-1">Select a challenge or generate your own!</div>
                    </div>
                    <button onclick="closeCodeLab()" class="text-xs bg-gray-800 px-4 py-2 text-gray-400 hover:bg-red-900 hover:text-white transition rounded">CLOSE</button>
                </div>

                <!-- Generate Custom Problem Section -->
                <div class="bg-gradient-to-r from-purple-900/30 to-pink-900/30 p-4 rounded-lg border border-purple-700/50 mb-4">
                    <div class="text-purple-300 font-bold text-xs mb-3 tracking-widest">‚ú® GENERATE CUSTOM PROBLEM</div>
                    <div class="flex gap-2">
                        <input type="text" id="custom-topic-input" placeholder="Type any topic: loops, strings, math, games..." class="flex-1 bg-gray-900 border border-purple-900 text-white text-sm px-3 py-2 rounded-lg" onkeypress="if(event.key==='Enter')generateCustomProblem()">
                        <select id="custom-difficulty-select" class="bg-gray-900 border border-purple-900 text-white text-sm px-2 py-2 rounded-lg">
                            <option value="Beginner">üå± Beginner</option>
                            <option value="Easy">üìò Easy</option>
                            <option value="Medium" selected>üî• Medium</option>
                            <option value="Hard">üíé Hard</option>
                        </select>
                        <button onclick="generateCustomProblem()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold px-4 py-2 rounded-lg hover:from-purple-500 hover:to-pink-500 transition text-sm">GENERATE</button>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2">Examples: "calculator", "password checker", "number guessing", "shopping cart"</div>
                </div>

                <!-- Search existing challenges -->
                <input type="text" id="codelab-search" placeholder="üîç Search existing challenges..." class="bg-gray-900 border border-purple-900 text-white text-sm px-4 py-3 mb-4 rounded-lg w-full" oninput="filterCodingChallenges()">
                <div id="codelab-challenges-list" class="flex-1 overflow-y-auto grid grid-cols-2 gap-3 pr-2">
                    <!-- Challenges will be loaded here -->
                </div>
            </div>

            <!-- Code Challenge View: Problem + Editor -->
            <div id="student-code-challenge-view" class="absolute inset-0 p-4 hidden flex-col bg-black/95">
                <div class="flex justify-between items-center mb-3 border-b border-purple-900 pb-3">
                    <div>
                        <div class="text-purple-400 font-bold text-sm tracking-widest" id="challenge-title">CHALLENGE</div>
                        <div class="text-xs text-gray-400 mt-1" id="challenge-difficulty">Difficulty: Beginner</div>
                    </div>
                    <button onclick="backToChallengesList()" class="text-xs bg-gray-800 px-4 py-2 text-gray-400 hover:bg-purple-900 hover:text-white transition rounded">‚Üê BACK</button>
                </div>

                <div class="flex-1 flex gap-3 overflow-hidden">
                    <!-- Left: Problem Description -->
                    <div class="w-2/5 flex flex-col gap-3 overflow-y-auto pr-2">
                        <!-- Task Description -->
                        <div class="bg-gray-900/80 rounded-lg border border-purple-900/30 p-4">
                            <div class="text-purple-400 font-bold text-xs mb-2 tracking-widest">üìã TASK</div>
                            <div id="challenge-description" class="text-sm text-gray-300 leading-relaxed"></div>
                        </div>
                        <!-- Expected Output -->
                        <div class="bg-gray-900/80 rounded-lg border border-green-900/30 p-4">
                            <div class="text-green-400 font-bold text-xs mb-2 tracking-widest">‚úÖ EXPECTED OUTPUT</div>
                            <pre id="challenge-expected" class="text-sm text-green-300 font-mono bg-black/50 p-2 rounded"></pre>
                        </div>
                        <!-- Hint -->
                        <div class="bg-gray-900/80 rounded-lg border border-yellow-900/30 p-4">
                            <div class="text-yellow-400 font-bold text-xs mb-2 tracking-widest">üí° HINT</div>
                            <div id="challenge-hint" class="text-sm text-yellow-200/80"></div>
                        </div>
                    </div>

                    <!-- Right: Code Editor + Feedback -->
                    <div class="w-3/5 flex flex-col gap-3">
                        <!-- Code Editor -->
                        <div class="flex-1 flex flex-col bg-gray-900 rounded-lg border border-purple-900/50 overflow-hidden">
                            <div class="flex items-center justify-between px-3 py-2 bg-gray-800 border-b border-purple-900/30">
                                <div class="flex items-center gap-2">
                                    <span class="text-purple-400 text-xs">üìÑ</span>
                                    <span class="text-xs text-gray-400">solution.py</span>
                                </div>
                                <span class="text-xs text-gray-500">Python 3</span>
                            </div>
                            <textarea id="code-editor" class="flex-1 bg-gray-900 text-green-400 font-mono text-sm p-4 resize-none focus:outline-none" placeholder="# Write your code here..."></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button onclick="runPythonCode()" class="flex-1 bg-gradient-to-r from-green-600 to-green-800 text-white font-bold py-2 px-3 rounded-lg hover:from-green-500 hover:to-green-700 transition flex items-center justify-center gap-2 text-sm">
                                <span>‚ñ∂Ô∏è</span> RUN CODE
                            </button>
                            <button onclick="submitCodeForReview()" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-800 text-white font-bold py-2 px-3 rounded-lg hover:from-blue-500 hover:to-blue-700 transition flex items-center justify-center gap-2 text-sm">
                                <span>üîç</span> REVIEW
                            </button>
                        </div>

                        <!-- Console Output -->
                        <div class="bg-black rounded-lg border border-green-900/50 p-3 h-24 overflow-y-auto">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-green-400 font-bold text-xs tracking-widest">CONSOLE OUTPUT</span>
                                <button onclick="clearConsole()" class="text-[10px] text-gray-500 hover:text-white">Clear</button>
                            </div>
                            <pre id="code-console-output" class="text-sm text-green-300 font-mono whitespace-pre-wrap">>>> Ready to run your code...</pre>
                        </div>

                        <!-- Feedback Panel -->
                        <div id="code-feedback-panel" class="bg-gray-900/80 rounded-lg border border-purple-900/30 p-3 max-h-24 overflow-y-auto hidden">
                            <div class="text-purple-400 font-bold text-xs mb-2 tracking-widest">AI_FEEDBACK</div>
                            <div id="code-feedback-content" class="text-sm text-gray-300"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Practice View: Questions Display -->
            <div id="student-practice-view" class="absolute inset-0 p-4 hidden flex-col bg-black/90">
                <div class="flex justify-between items-center mb-4 border-b border-teal-900 pb-3">
                    <div>
                        <div class="text-teal-400 font-bold text-xs tracking-widest" id="center-practice-topic">PRACTICE_SESSION</div>
                        <div class="text-[8px] text-gray-400 mt-1" id="center-practice-subtitle">Answer all questions below</div>
                    </div>
                    <button onclick="closeCenterPractice()" class="text-[8px] bg-gray-800 px-3 py-1 text-gray-400 hover:bg-red-900 hover:text-white transition">CLOSE</button>
                </div>
                <div id="center-practice-questions" class="flex-1 overflow-y-auto pr-2 space-y-4">
                    <!-- Questions will be inserted here -->
                </div>
                <div class="mt-4 pt-3 border-t border-teal-900">
                    <button onclick="submitCenterAnswers()" class="w-full bg-green-500 text-black text-sm font-bold py-3 hover:bg-green-400 transition tracking-wider">SUBMIT ANSWERS</button>
                </div>
            </div>
        </div>

        <!-- Center: Teacher Dashboard (TEACHER VIEW) -->
        <div id="teacherCenterPanel" class="col-span-6 glass-card p-4 hidden flex flex-col">
            <!-- STATIC HEADER: Student info, stats, badge - DOES NOT SCROLL -->
            <div id="center-panel-header" class="mb-4 p-4 border border-teal-900/50 bg-teal-900/10 flex-shrink-0">
                <div class="flex justify-between items-center mb-3 border-b border-teal-900 pb-2">
                    <h3 id="center-panel-title" class="text-sm font-bold tracking-widest text-teal-400">CLASS_PROGRESS_OVERVIEW</h3>
                    <button id="back-to-class-btn" onclick="showClassOverview()" class="text-[10px] bg-gray-800 px-3 py-1.5 text-gray-400 hover:bg-teal-900 hover:text-white transition hidden">‚Üê BACK TO CLASS</button>
                </div>
                <div id="center-stats-grid" class="grid grid-cols-4 gap-3 text-center">
                    <div class="p-3 bg-black/50 border border-teal-900/30">
                        <div class="text-2xl font-black text-teal-400" id="stat-tasks-assigned">0</div>
                        <div class="text-[10px] text-gray-400 uppercase">Assigned</div>
                    </div>
                    <div class="p-3 bg-black/50 border border-green-900/30">
                        <div class="text-2xl font-black text-green-400" id="stat-tasks-completed">0</div>
                        <div class="text-[10px] text-gray-400 uppercase">Completed</div>
                    </div>
                    <div class="p-3 bg-black/50 border border-amber-900/30">
                        <div class="text-2xl font-black text-amber-400" id="stat-pending-students">0</div>
                        <div class="text-[10px] text-gray-400 uppercase">Pending</div>
                    </div>
                    <div class="p-3 bg-black/50 border border-blue-900/30">
                        <div class="text-2xl font-black text-blue-400" id="stat-avg-score">0%</div>
                        <div class="text-[10px] text-gray-400 uppercase">Avg Score</div>
                    </div>
                </div>
                <!-- Performance Badge (shown for individual student) -->
                <div id="performance-badge" class="hidden mt-3 p-3 text-center"></div>
            </div>

            <!-- SCROLLABLE CONTENT: Task details - THIS PART SCROLLS -->
            <div class="flex-1 p-4 border border-teal-900/50 bg-teal-900/10 overflow-y-auto">
                <h3 id="content-section-title" class="text-sm font-bold mb-4 tracking-widest text-teal-400 border-b border-teal-900 pb-2">RECENT_SUBMISSIONS</h3>
                <div id="recent-submissions-list" class="space-y-3">
                    <div class="text-xs text-gray-500">Loading submissions...</div>
                </div>
            </div>
        </div>

        <!-- Right: Agent Bridge (STUDENT) OR Teacher Actions (TEACHER) -->
        <div class="col-span-3 flex flex-col gap-6">
            <!-- STUDENT VIEW: Agent Chat -->
            <div id="studentChatPanel" class="glass-card p-4 flex-1 flex flex-col">
                <h3 class="text-xs font-bold mb-4 tracking-widest">AGENT_BRIDGE_TRIAGE</h3>
                <div id="agent-logs" class="flex-1 overflow-y-auto font-mono text-[10px] space-y-2 pr-2">
                    <div class="text-teal-500">triage@alishba-k:~$ <span class="text-white">initializing...</span></div>
                </div>
                <div class="mt-4 flex gap-2">
                    <span class="text-teal-500">></span>
                    <input type="text" id="agent-input" class="bg-transparent border-none outline-none w-full text-[10px] text-white" placeholder="Ask Triage Agent...">
                </div>
            </div>

            <!-- TEACHER VIEW: Teacher Actions -->
            <div id="teacherActionsPanel" class="glass-card p-4 flex-1 flex-col hidden">
                <h3 class="text-xs font-bold mb-4 tracking-widest border-b border-teal-900 pb-2">TEACHER_ACTIONS</h3>

                <!-- Create Practice Test -->
                <div class="mb-4 p-3 border border-teal-900/50 bg-teal-900/10">
                    <div class="text-[10px] font-bold mb-2 text-teal-400">CREATE PRACTICE TEST</div>
                    <select id="practice-topic" class="w-full bg-black border border-teal-900 text-white text-[9px] p-1 mb-2">
                        <option value="python-basics">Python Basics</option>
                        <option value="variables-and-data-types">Variables & Data Types</option>
                        <option value="control-flow">Control Flow</option>
                        <option value="data-structures">Data Structures</option>
                        <option value="functions">Functions</option>
                    </select>
                    <select id="practice-difficulty" class="w-full bg-black border border-teal-900 text-white text-[9px] p-1 mb-2">
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                    <input type="number" id="practice-count" value="3" min="1" max="10" class="w-full bg-black border border-teal-900 text-white text-[9px] p-1 mb-2" placeholder="Number of questions">
                    <button onclick="teacherGeneratePractice()" class="w-full bg-blue-500 text-black text-[9px] font-bold py-2 hover:bg-white transition">GENERATE TEST</button>
                </div>

                <!-- Assign MCQ Test (with student selection) -->
                <div class="mb-3 p-3 border border-teal-900/50 bg-teal-900/10">
                    <div class="text-[10px] font-bold mb-2 text-teal-400">üìù ASSIGN MCQ TEST</div>
                    <div class="text-[9px] text-gray-400 mb-2">Select students:</div>
                    <div id="assign-student-list" class="max-h-20 overflow-y-auto mb-2 text-[9px] bg-black/30 p-2 rounded">
                        <div class="text-gray-500">Loading students...</div>
                    </div>
                    <button onclick="assignPracticeToSelected()" class="w-full bg-amber-500 text-black text-[9px] font-bold py-2 hover:bg-white transition">ASSIGN MCQ</button>
                </div>

                <!-- Assign Coding Challenge (with student selection) -->
                <div class="mb-3 p-3 border border-purple-900/50 bg-purple-900/10">
                    <div class="text-[10px] font-bold mb-2 text-purple-400">üíª ASSIGN CODE TASK</div>
                    <div class="text-[9px] text-gray-400 mb-2">1. Select students:</div>
                    <div id="code-assign-student-list" class="max-h-20 overflow-y-auto mb-2 text-[9px] bg-black/30 p-2 rounded">
                        <div class="text-gray-500">Loading students...</div>
                    </div>
                    <div class="text-[9px] text-gray-400 mb-2">2. Select challenge:</div>
                    <select id="coding-challenge-select" class="w-full bg-black border border-purple-900 text-white text-[9px] p-1 mb-2">
                        <option value="">Select challenge...</option>
                        <optgroup label="üå± Beginner">
                            <option value="print-hello">Print Hello World</option>
                            <option value="add-numbers">Add Two Numbers</option>
                            <option value="string-length">Find String Length</option>
                            <option value="list-access">Access List Item</option>
                            <option value="for-loop">Loop Through List</option>
                            <option value="if-statement">Check Number</option>
                        </optgroup>
                        <optgroup label="üìò Easy">
                            <option value="reverse-string">Reverse a String</option>
                            <option value="sum-list">Sum of List</option>
                            <option value="max-value">Find Maximum</option>
                            <option value="sort-list">Sort a List</option>
                        </optgroup>
                        <optgroup label="üî• Medium">
                            <option value="count-vowels">Count Vowels</option>
                            <option value="even-numbers">Filter Even Numbers</option>
                            <option value="factorial">Calculate Factorial</option>
                            <option value="palindrome">Check Palindrome</option>
                            <option value="fizzbuzz">FizzBuzz</option>
                            <option value="list-comprehension">List Comprehension</option>
                        </optgroup>
                        <optgroup label="üíé Hard">
                            <option value="word-frequency">Word Frequency</option>
                            <option value="prime-check">Check Prime Number</option>
                            <option value="fibonacci">Fibonacci Sequence</option>
                            <option value="class-create">Create a Class</option>
                        </optgroup>
                    </select>
                    <button onclick="assignCodingChallenge()" class="w-full bg-purple-500 text-black text-[9px] font-bold py-2 hover:bg-white transition">ASSIGN CODE</button>
                </div>

                <!-- Struggle Alert -->
                <div id="struggle-alert" class="p-3 border border-red-900/50 bg-red-900/10 hidden">
                    <div class="text-[10px] font-bold mb-2 text-red-400">‚ö† STRUGGLING STUDENTS</div>
                    <div id="struggle-students" class="text-[9px] text-white mb-2"></div>
                    <button onclick="autoAssignPractice()" class="w-full bg-red-500 text-black text-[9px] font-bold py-2 hover:bg-white transition">AUTO-ASSIGN PRACTICE</button>
                </div>
            </div>
        </div>

        <!-- Bottom: Code Editor + Practice Panel - BIGGER HEIGHT -->
        <div class="col-span-12 glass-card p-4 h-[220px] flex gap-4">
            <div class="flex-1 flex flex-col">
                <div class="flex justify-between items-center mb-2 px-2">
                    <span class="text-xs opacity-50">main.py - LearnFlow Agent Integration</span>
                    <button onclick="testAllAgents()" class="bg-teal-500 text-black px-4 py-2 text-xs font-bold hover:bg-white transition rounded">TEST AGENTS</button>
                </div>
                <div class="flex-1 bg-black/60 p-4 rounded border border-teal-900/30 font-mono text-xs overflow-hidden">
                    <div class="text-blue-400">import</div> <div class="inline text-white">requests</div><br>
                    <br>
                    <div class="text-gray-500"># LearnFlow Agent Endpoints</div><br>
                    <div class="text-white">triage = <span class="text-green-400">"http://localhost:8001"</span></div><br>
                    <div class="text-white">concepts = <span class="text-green-400">"http://localhost:8002"</span></div><br>
                    <div class="text-white">progress = <span class="text-green-400">"http://localhost:8006"</span></div><br>
                    <br>
                    <div class="text-gray-500"># Fetch student mastery</div><br>
                    <div class="text-white">r = requests.get(<span class="text-green-400">f"{progress}/progress/demo-student-001"</span>)</div><br>
                    <div class="text-white">print(<span class="text-green-400">f"Mastery: {r.json()}"</span>)</div>
                </div>
            </div>
            <!-- STUDENT VIEW: Practice Topics & Code Lab Buttons -->
            <div id="studentConsole" class="flex flex-col items-center justify-center gap-3 p-2">
                <button onclick="openPracticeTopicsInCenter()" class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-500 hover:to-cyan-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-teal-900/50 transition transform hover:scale-105 flex items-center gap-3">
                    <span class="text-xl">üìö</span>
                    <div class="text-left">
                        <div class="text-xs font-bold tracking-wider">PRACTICE TOPICS</div>
                        <div class="text-[9px] opacity-80">MCQ questions</div>
                    </div>
                </button>
                <button onclick="openCodeLabInCenter()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-purple-900/50 transition transform hover:scale-105 flex items-center gap-3">
                    <span class="text-xl">üíª</span>
                    <div class="text-left">
                        <div class="text-xs font-bold tracking-wider">CODE LAB</div>
                        <div class="text-[9px] opacity-80">Write Python code</div>
                    </div>
                </button>
            </div>

            <!-- TEACHER VIEW: Console Output -->
            <div id="teacherConsole" class="w-2/5 bg-black/90 p-4 font-mono text-white overflow-y-auto border-2 border-teal-900 rounded flex-col hidden">
                <div class="text-teal-400 text-sm font-bold mb-3 tracking-wider">STUDENT_DETAILS</div>
                <div class="flex-1 overflow-y-auto" id="console-content">
                    <div class="text-gray-400 text-sm">Select a student to view details...</div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIGURATION - EDIT THIS FOR DEPLOYMENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const API_CONFIG = {
        // For local development: use localhost with ports
        // For production: use Render backend (all agents on one service)
        IS_LOCAL: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1',

        LOCAL_URL: 'http://localhost',
        PROD_URL: 'https://reusable-intelligence.onrender.com',

        TRIAGE_PORT: '8001',
        CONCEPTS_PORT: '8002',
        CODE_REVIEW_PORT: '8003',
        DEBUG_PORT: '8004',
        EXERCISE_PORT: '8005',
        PROGRESS_PORT: '8006'
    };

    // Helper to build agent URLs - handles both local (ports) and production (paths)
    function getAgentURL(port, path = '') {
        if (API_CONFIG.IS_LOCAL) {
            return `${API_CONFIG.LOCAL_URL}:${port}${path}`;
        }

        // Production: all agents on one service
        // Health check goes to main endpoint
        if (path === '/health') {
            return `${API_CONFIG.PROD_URL}/health`;
        }

        // Production: map port to API path, remove /api/v1 prefix from path since it's in the base
        const portToPath = {
            '8001': '/api/v1/triage',
            '8002': '/api/v1/concepts',
            '8003': '/api/v1/code-review',
            '8004': '/diagnose',
            '8005': '/api/v1/exercise',
            '8006': '/api/v1/progress'
        };

        // Clean up path - remove /api/v1 prefix if present since portToPath already has it
        let cleanPath = path.replace(/^\/api\/v1/, '');
        return `${API_CONFIG.PROD_URL}${portToPath[port] || ''}${cleanPath}`;
    }

    // CRITICAL: Global session user - declared early to be available in all functions
    // This caches the logged-in user for THIS browser tab to prevent cross-tab pollution
    let currentSessionUser = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TOAST NOTIFICATION SYSTEM (replaces browser alerts)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showToast(title, message, type = 'info', duration = 4000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div class="toast-title">${type === 'success' ? '‚úÖ ' : type === 'error' ? '‚ùå ' : '‚ÑπÔ∏è '}${title}</div>
            <div class="toast-message">${message}</div>
        `;
        container.appendChild(toast);

        // Auto remove after duration
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-in forwards';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // Navigation Logic
    function showPage(pageId) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(p => {
            p.classList.remove('active');
            p.scrollTop = 0;  // Reset scroll position
        });

        // Show target page
        const targetPage = document.getElementById(pageId);
        targetPage.classList.add('active');
        targetPage.scrollTop = 0;  // Ensure starts at top

        // Also scroll window to top
        window.scrollTo(0, 0);

        // Show/hide dashboard header
        const header = document.getElementById('dashboard-header');
        if (header) {
            header.style.display = pageId === 'dashboard' ? 'flex' : 'none';
        }

        if (pageId === 'dashboard') {
            initDashboardThree();
            fetchMasteryData();
            startAgentLogStream();
            updateHeaderBadge();
            loadNotifications();

            // CRITICAL: Use cached session user - NOT localStorage (prevents cross-tab pollution)
            const user = currentSessionUser;
            if (user) {
                console.log(`[Dashboard] Initializing for ${user.role}`);
                if (user.role === 'student') {
                    loadStudentAssignments();
                } else if (user.role === 'teacher') {
                    // For teachers: ensure student panel is removed
                    const studentPanel = document.getElementById('student-assignments-panel');
                    if (studentPanel) {
                        console.log('[Dashboard] Removing student panel for teacher');
                        studentPanel.remove();
                    }
                }
            }
            startNotificationPolling();  // Start auto-refresh for notifications
        } else {
            stopNotificationPolling();  // Stop polling when leaving dashboard
        }
    }
    // Make showPage globally accessible for onclick handlers
    window.showPage = showPage;

    // Backend Health Check
    async function checkBackendHealth() {
        try {
            const response = await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, '/health'));
            if (response.ok) {
                document.getElementById('backend-status').textContent = 'OPERATIONAL';
                document.getElementById('backend-status').style.color = 'var(--neon-green)';
                return true;
            }
        } catch (error) {
            document.getElementById('backend-status').textContent = 'OFFLINE';
            document.getElementById('backend-status').style.color = 'var(--neon-red)';
        }
        return false;
    }

    // Global variable to store selected student for teacher view
    let selectedStudentId = null;

    // Fetch Mastery Data from Progress Agent (role-aware)
    async function fetchMasteryData() {
        try {
            // CRITICAL: Use cached session user - NOT localStorage
            if (!currentSessionUser) {
                const userStr = localStorage.getItem('learnflow_user');
                if (!userStr) {
                    document.getElementById('console-output').innerHTML = '<div class="text-yellow-400">No user logged in</div>';
                    return;
                }
                currentSessionUser = JSON.parse(userStr);
            }

            const user = currentSessionUser;

            // STUDENT VIEW: Fetch only their own data
            if (user.role === 'student') {
                console.log('LOADING STUDENT DASHBOARD for', user.email);
                const studentId = user.studentId || 'demo-student-001';

                // Show student panels FIRST, hide teacher panels
                const studentAgentPanel = document.getElementById('studentAgentPanel');
                const studentChatPanel = document.getElementById('studentChatPanel');
                const studentConsole = document.getElementById('studentConsole');
                const studentCenterPanel = document.getElementById('studentCenterPanel');
                const teacherStudentPanel = document.getElementById('teacherStudentPanel');
                const teacherActionsPanel = document.getElementById('teacherActionsPanel');
                const teacherConsole = document.getElementById('teacherConsole');
                const teacherCenterPanel = document.getElementById('teacherCenterPanel');

                if (studentAgentPanel) studentAgentPanel.classList.remove('hidden');
                if (studentChatPanel) studentChatPanel.classList.remove('hidden');
                if (studentConsole) studentConsole.classList.remove('hidden');
                if (studentCenterPanel) studentCenterPanel.classList.remove('hidden');
                if (teacherStudentPanel) teacherStudentPanel.classList.add('hidden');
                if (teacherCenterPanel) teacherCenterPanel.classList.add('hidden');
                if (teacherActionsPanel) {
                    teacherActionsPanel.classList.add('hidden');
                    teacherActionsPanel.style.display = 'none';
                }
                if (teacherConsole) {
                    teacherConsole.classList.add('hidden');
                    teacherConsole.style.display = 'none';
                }

                // Then load data
                await displayStudentMastery(studentId, user);

                // Load student assignments from database
                loadStudentAssignments();
            }
            // TEACHER VIEW: Fetch all students
            else if (user.role === 'teacher') {
                console.log('LOADING TEACHER DASHBOARD for', user.email);

                // Show teacher panels FIRST, hide student panels
                const studentAgentPanel = document.getElementById('studentAgentPanel');
                const studentChatPanel = document.getElementById('studentChatPanel');
                const studentConsole = document.getElementById('studentConsole');
                const studentCenterPanel = document.getElementById('studentCenterPanel');
                const teacherStudentPanel = document.getElementById('teacherStudentPanel');
                const teacherActionsPanel = document.getElementById('teacherActionsPanel');
                const teacherConsole = document.getElementById('teacherConsole');
                const teacherCenterPanel = document.getElementById('teacherCenterPanel');

                if (studentAgentPanel) {
                    studentAgentPanel.classList.add('hidden');
                    studentAgentPanel.style.display = 'none';
                }
                if (studentChatPanel) {
                    studentChatPanel.classList.add('hidden');
                    studentChatPanel.style.display = 'none';
                }
                if (studentCenterPanel) {
                    studentCenterPanel.classList.add('hidden');
                    studentCenterPanel.style.display = 'none';
                }
                if (studentConsole) {
                    studentConsole.classList.add('hidden');
                    studentConsole.style.display = 'none';
                }
                // REMOVE student assignments panel entirely for teachers (dynamically created)
                const studentAssignmentsPanel = document.getElementById('student-assignments-panel');
                if (studentAssignmentsPanel) {
                    studentAssignmentsPanel.remove();  // Remove completely, not just hide
                }
                if (teacherStudentPanel) teacherStudentPanel.classList.remove('hidden');
                if (teacherCenterPanel) teacherCenterPanel.classList.remove('hidden');
                if (teacherActionsPanel) {
                    teacherActionsPanel.classList.remove('hidden');
                    teacherActionsPanel.style.display = 'flex';
                }
                if (teacherConsole) {
                    teacherConsole.classList.remove('hidden');
                    teacherConsole.style.display = 'flex';
                }

                // Then load data
                await loadTeacherDashboard(user);

                // Load teacher stats and recent submissions
                loadTeacherStats();

                // Load student lists for MCQ and Coding assignment sections (with delay for DOM)
                setTimeout(() => {
                    loadStudentsForAssignment();
                }, 500);
            }

        } catch (error) {
            console.error('Failed to fetch mastery data:', error);
            document.getElementById('console-output').innerHTML = '<div class="text-red-500">Backend connection failed</div>';
        }
    }

    // Display mastery data for a single student
    async function displayStudentMastery(studentId, user) {
        // Note: getAgentURL already adds /api/v1/progress, so just use /mastery/{id}
        const response = await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${studentId}`));
        const data = await response.json();
        console.log(`[MASTERY FETCH] Student ${studentId}:`, data);

        // Update global mastery (CAP AT 100%)
        const overall = Math.min(100, Math.round(data.overall_mastery * 100));
        document.getElementById('global-mastery').textContent = overall + '%';

        // Update mastery bars
        const barsContainer = document.getElementById('mastery-bars');
        barsContainer.innerHTML = '';

        if (data.topic_mastery && data.topic_mastery.length > 0) {
            data.topic_mastery.slice(0, 4).forEach(topic => {
                const percent = topic.mastery_percentage;
                const color = percent >= 70 ? '#39ff14' : percent >= 40 ? '#ffaa00' : '#ff3131';
                const bar = document.createElement('div');
                bar.className = 'h-1 w-8';
                bar.style.backgroundColor = color;
                barsContainer.appendChild(bar);
            });
        }

        // Populate topics list for student (clickable topics in sequence)
        const topicsList = document.getElementById('topics-list');
        if (!topicsList) return;

        topicsList.innerHTML = '';

        // Define topic sequence (learning path)
        const topicSequence = [
            { id: 'python-basics', name: 'Python Basics', level: 1 },
            { id: 'variables-and-data-types', name: 'Variables & Data Types', level: 2 },
            { id: 'control-flow', name: 'Control Flow (if/else, loops)', level: 3 },
            { id: 'functions', name: 'Functions', level: 4 },
            { id: 'data-structures', name: 'Data Structures (lists, dicts)', level: 5 }
        ];

        if (data.topic_mastery && data.topic_mastery.length > 0) {
            // Create a map of actual mastery data
            const masteryMap = {};
            data.topic_mastery.forEach(topic => {
                masteryMap[topic.topic_name] = topic.mastery_percentage;
            });

            topicSequence.forEach(topic => {
                // Backend returns mastery_percentage as 0-100, no need to multiply
                const percent = Math.min(100, Math.round(masteryMap[topic.id] || 0));
                const color = percent >= 70 ? '#39ff14' : percent >= 40 ? '#ffaa00' : '#ff3131';
                const status = percent >= 70 ? '‚úì' : percent >= 40 ? '‚ö†' : '‚óã';

                const topicDiv = document.createElement('div');
                topicDiv.className = 'mb-3 p-2 border border-teal-900/50 hover:bg-teal-900/20 cursor-pointer transition';
                topicDiv.onclick = () => startPractice(topic.id, topic.name);
                topicDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <span style="color: ${color}">${status}</span>
                            <span class="text-white text-[9px]">Level ${topic.level}</span>
                        </div>
                        <span style="color: ${color}" class="font-bold text-[10px]">${percent}%</span>
                    </div>
                    <div class="text-teal-400 text-[9px] font-bold mb-1">${topic.name}</div>
                    <div class="w-full bg-gray-800 h-1">
                        <div style="width: ${percent}%; background-color: ${color}" class="h-1"></div>
                    </div>
                    <div class="text-[7px] text-gray-500 mt-1">Click to practice ‚Üí</div>
                `;
                topicsList.appendChild(topicDiv);
            });
        } else {
            topicsList.innerHTML = `<div class="text-yellow-400 text-[8px]">No mastery data yet. Start by clicking a topic!</div>`;
            // Show default topics even without data
            topicSequence.forEach(topic => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'mb-3 p-2 border border-teal-900/50 hover:bg-teal-900/20 cursor-pointer transition';
                topicDiv.onclick = () => startPractice(topic.id, topic.name);
                topicDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">‚óã</span>
                            <span class="text-white text-[9px]">Level ${topic.level}</span>
                        </div>
                        <span class="text-gray-500 font-bold text-[10px]">0%</span>
                    </div>
                    <div class="text-teal-400 text-[9px] font-bold mb-1">${topic.name}</div>
                    <div class="w-full bg-gray-800 h-1">
                        <div style="width: 0%; background-color: #gray" class="h-1"></div>
                    </div>
                    <div class="text-[7px] text-gray-500 mt-1">Click to start learning ‚Üí</div>
                `;
                topicsList.appendChild(topicDiv);
            });
        }
    }

    // Manual refresh for teacher
    async function refreshTeacherData() {
        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) return;
        const user = JSON.parse(userStr);

        showToast('Refreshing', 'Loading latest student data...', 'info', 2000);

        try {
            await loadTeacherDashboard(user);
            await loadTeacherStats();
            loadStudentsForAssignment();
            showToast('Updated', 'Student list refreshed!', 'success', 2000);
        } catch (err) {
            console.error('Refresh error:', err);
            showToast('Error', 'Failed to refresh: ' + err.message, 'error');
        }
    }

    // Load teacher dashboard with all students
    async function loadTeacherDashboard(user) {
        // Fetch all students
        const studentsResponse = await fetch('/api/auth/students');
        const studentsData = await studentsResponse.json();

        if (!studentsData.success || !studentsData.students) {
            document.getElementById('student-list').innerHTML = '<div class="text-red-500 text-xs">Failed to load students</div>';
            return;
        }

        const students = studentsData.students;

        // Fetch mastery data for each student
        const studentListContainer = document.getElementById('student-list');
        studentListContainer.innerHTML = '';

        if (students.length === 0) {
            studentListContainer.innerHTML = '<div class="text-gray-500 text-xs">No students registered yet</div>';
            document.getElementById('console-output').innerHTML = '<div class="text-gray-500 text-xs">No students to display</div>';
            return;
        }

        // Fetch mastery for all students in parallel
        const masteryPromises = students.map(student =>
            fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${student.studentId}`))
                .then(res => res.json())
                .catch(() => ({ overall_mastery: 0, topic_mastery: [] }))
        );

        const masteryResults = await Promise.all(masteryPromises);

        // Create student cards with color coding
        students.forEach((student, index) => {
            const mastery = masteryResults[index];
            const overall = Math.min(100, Math.round(mastery.overall_mastery * 100));

            // Color coding: Green (>70%), Yellow (40-70%), Red (<40%)
            let borderColor, bgColor, textColor;
            if (overall >= 70) {
                borderColor = '#39ff14';
                bgColor = 'rgba(57, 255, 20, 0.1)';
                textColor = '#39ff14';
            } else if (overall >= 40) {
                borderColor = '#ffaa00';
                bgColor = 'rgba(255, 170, 0, 0.1)';
                textColor = '#ffaa00';
            } else {
                borderColor = '#ff3131';
                bgColor = 'rgba(255, 49, 49, 0.1)';
                textColor = '#ff3131';
            }

            // Find struggling topics
            const strugglingTopics = mastery.topic_mastery
                ? mastery.topic_mastery.filter(t => t.mastery_percentage < 40).map(t => t.topic_name)
                : [];

            // Store mastery data globally for click handler
            window.studentMasteryData = window.studentMasteryData || {};
            window.studentMasteryData[student.studentId] = mastery;

            const card = document.createElement('div');
            card.className = 'student-card w-full text-left p-3 border cursor-pointer transition hover:scale-105 hover:border-white';
            card.style.cssText = `border-color: ${borderColor}; background-color: ${bgColor}; position: relative; z-index: 10;`;
            card.setAttribute('data-student-id', student.studentId);
            card.setAttribute('data-student-name', student.name);

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-bold text-white">${student.name}</span>
                    <span class="text-sm font-black" style="color: ${textColor}">${overall}%</span>
                </div>
                <div class="text-[9px] opacity-70 mb-1">${student.studentId}</div>
                ${strugglingTopics.length > 0
                    ? `<div class="text-[8px] text-red-400 mt-1">Struggling: ${strugglingTopics.slice(0, 2).join(', ')}</div>`
                    : '<div class="text-[8px] text-green-400 mt-1">On track</div>'}
                <div class="text-[7px] text-teal-400 mt-2 text-center border-t border-teal-900 pt-1">[ CLICK TO VIEW DETAILS ]</div>
            `;

            // Add click handler directly to element
            card.onclick = function(e) {
                e.stopPropagation();
                const sid = this.getAttribute('data-student-id');
                const sname = this.getAttribute('data-student-name');
                const mdata = window.studentMasteryData[sid] || { overall_mastery: 0, topic_mastery: [] };
                selectStudent(sid, sname, mdata);
            };

            studentListContainer.appendChild(card);
        });

        // Detect struggling students (<40% overall mastery)
        const strugglingStudents = students.filter((student, index) => {
            const overall = Math.min(100, Math.round(masteryResults[index].overall_mastery * 100));
            return overall < 40;
        });

        // Show struggle alert if struggling students detected
        const struggleAlert = document.getElementById('struggle-alert');
        if (strugglingStudents.length > 0) {
            struggleAlert.classList.remove('hidden');
            const struggleStudentsDiv = document.getElementById('struggle-students');
            struggleStudentsDiv.innerHTML = '';
            strugglingStudents.forEach(student => {
                const div = document.createElement('div');
                div.className = 'mb-1';
                div.textContent = `‚Ä¢ ${student.name}`;
                struggleStudentsDiv.appendChild(div);
            });
        } else {
            struggleAlert.classList.add('hidden');
        }

        // Don't auto-select - let teacher click to view individual student
    }

    // Handle student card click - wrapper for selectStudent (must be global)
    window.handleStudentClick = function(studentId, studentName) {
        console.log('handleStudentClick:', studentId, studentName);
        const masteryData = window.studentMasteryData[studentId] || { overall_mastery: 0, topic_mastery: [] };
        selectStudent(studentId, studentName, masteryData);
    };

    // Select a student to view details (teacher view)
    async function selectStudent(studentId, studentName, masteryData) {
        console.log('selectStudent called:', studentId, studentName);

        try {
            selectedStudentId = studentId;

            // Update side panel elements (if they exist)
            const globalMastery = document.getElementById('global-mastery');
            if (globalMastery) {
                const overall = Math.min(100, Math.round(masteryData.overall_mastery * 100));
                globalMastery.textContent = overall + '%';
            }

            const barsContainer = document.getElementById('mastery-bars');
            if (barsContainer) {
                barsContainer.innerHTML = '';
                if (masteryData.topic_mastery && masteryData.topic_mastery.length > 0) {
                    masteryData.topic_mastery.slice(0, 4).forEach(topic => {
                        const percent = topic.mastery_percentage;
                        const color = percent >= 70 ? '#39ff14' : percent >= 40 ? '#ffaa00' : '#ff3131';
                        const bar = document.createElement('div');
                        bar.className = 'h-1 w-8';
                        bar.style.backgroundColor = color;
                        barsContainer.appendChild(bar);
                    });
                }
            }

            // Update console output (if exists)
            const consoleOutput = document.getElementById('console-output');
            if (consoleOutput) {
                consoleOutput.innerHTML = `<div class="opacity-50 mb-2">CONSOLE: [TEACHER_VIEW - ${studentName.toUpperCase()}]</div>`;
                if (masteryData.topic_mastery && masteryData.topic_mastery.length > 0) {
                    masteryData.topic_mastery.forEach(topic => {
                        const percent = Math.min(100, Math.round(topic.mastery_percentage));
                        const color = percent >= 70 ? '#39ff14' : percent >= 40 ? '#ffaa00' : '#ff3131';
                        const line = document.createElement('div');
                        line.className = 'mb-1';
                        line.innerHTML = `
                            <div class="flex items-center justify-between">
                                <span class="text-teal-400">${topic.topic_name.toUpperCase().replace(/-/g, ' ')}</span>
                                <span style="color: ${color}" class="font-bold">${percent}%</span>
                            </div>
                            <div class="w-full bg-gray-800 h-1 mt-1">
                                <div style="width: ${percent}%; background-color: ${color}" class="h-1"></div>
                            </div>
                        `;
                        consoleOutput.appendChild(line);
                    });
                } else {
                    consoleOutput.innerHTML += `<div class="text-yellow-400 text-xs">No mastery data yet</div>`;
                }
            }

            // Show struggling topics alert (if element exists)
            const struggleConsole = document.getElementById('struggleConsole');
            if (struggleConsole) {
                if (masteryData.struggling_topics && masteryData.struggling_topics.length > 0) {
                    struggleConsole.classList.remove('hidden');
                    const struggleMsg = document.getElementById('struggle-message');
                    if (struggleMsg) struggleMsg.textContent = `${studentName} struggling with: ${masteryData.struggling_topics.join(', ')}`;
                } else {
                    struggleConsole.classList.add('hidden');
                }
            }

            // CRITICAL: Update center panel to show selected student's assignments
            console.log('Calling loadSelectedStudentData...');
            await loadSelectedStudentData(studentId, studentName, masteryData);
            console.log('loadSelectedStudentData completed');

        } catch (err) {
            console.error('selectStudent error:', err);
            alert('Error in selectStudent: ' + err.message);
        }
    }

    // Load selected student's data in center panel
    // Show class overview (back from individual student view)
    window.showClassOverview = function() {
        selectedStudentId = null;  // Clear selected student
        document.getElementById('center-panel-title').textContent = 'CLASS_PROGRESS_OVERVIEW';
        document.getElementById('content-section-title').textContent = 'RECENT_SUBMISSIONS';
        document.getElementById('back-to-class-btn').classList.add('hidden');
        document.getElementById('performance-badge').classList.add('hidden');
        loadTeacherStats();
    };

    // Get performance analysis based on scores
    function getPerformanceAnalysis(avgScore, completionRate) {
        if (avgScore >= 90 && completionRate >= 80) {
            return { label: 'EXCELLENT', color: '#39ff14', bg: 'bg-green-900/30', border: 'border-green-500', emoji: 'üèÜ', message: 'Outstanding performance! Keep it up!' };
        } else if (avgScore >= 70 && completionRate >= 60) {
            return { label: 'GOOD', color: '#00ffcc', bg: 'bg-teal-900/30', border: 'border-teal-500', emoji: '‚≠ê', message: 'Good progress. Room for improvement.' };
        } else if (avgScore >= 50 || completionRate >= 40) {
            return { label: 'NEEDS IMPROVEMENT', color: '#ffaa00', bg: 'bg-amber-900/30', border: 'border-amber-500', emoji: 'üìö', message: 'Requires more practice and attention.' };
        } else {
            return { label: 'STRUGGLING', color: '#ff3131', bg: 'bg-red-900/30', border: 'border-red-500', emoji: 'üÜò', message: 'Needs immediate support and intervention.' };
        }
    }

    async function loadSelectedStudentData(studentId, studentName, masteryData) {
        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) return;
        const user = JSON.parse(userStr);

        try {
            const teacherId = user.teacherId || 'teacher-1';
            const response = await fetch(`/api/assignments/teacher/${teacherId}`);
            const data = await response.json();

            if (data.success) {
                const studentAssignments = data.assignments.filter(a => a.studentId === studentId);
                const completed = studentAssignments.filter(a => a.completed);
                const pending = studentAssignments.filter(a => !a.completed);
                const overall = Math.min(100, Math.round(masteryData.overall_mastery * 100));

                // Calculate average score
                const avgScore = completed.length > 0
                    ? Math.round(completed.reduce((sum, a) => sum + (a.score || 0), 0) / completed.length)
                    : 0;
                const completionRate = studentAssignments.length > 0
                    ? Math.round((completed.length / studentAssignments.length) * 100)
                    : 0;

                // Get performance analysis
                const performance = getPerformanceAnalysis(avgScore, completionRate);

                // Update header title
                document.getElementById('center-panel-title').textContent = 'STUDENT: ' + studentName.toUpperCase();
                document.getElementById('back-to-class-btn').classList.remove('hidden');
                document.getElementById('content-section-title').textContent = 'TASK_DETAILS';

                // Show toast to confirm view loaded
                showToast('Student Selected', 'Viewing ' + studentName + ' - ' + completed.length + ' completed, ' + pending.length + ' pending', 'info');

                // Update stats grid for this student
                document.getElementById('stat-tasks-assigned').textContent = studentAssignments.length;
                document.getElementById('stat-tasks-completed').textContent = completed.length;
                document.getElementById('stat-pending-students').textContent = pending.length;
                document.getElementById('stat-avg-score').textContent = avgScore + '%';

                // Show performance badge
                const badgeEl = document.getElementById('performance-badge');
                badgeEl.classList.remove('hidden');
                badgeEl.className = `mt-3 p-3 text-center border ${performance.border} ${performance.bg}`;
                badgeEl.innerHTML = `
                    <div class="text-2xl mb-1">${performance.emoji}</div>
                    <div class="text-sm font-black" style="color: ${performance.color}">${performance.label}</div>
                    <div class="text-[9px] text-gray-400 mt-1">${performance.message}</div>
                    <div class="text-[8px] text-gray-500 mt-2">Mastery: ${overall}% | Completion: ${completionRate}%</div>
                `;

                // Update content area with tasks - LARGER AND MORE READABLE
                const submissionsList = document.getElementById('recent-submissions-list');
                submissionsList.innerHTML = `
                    ${completed.length > 0 ? `
                        <div class="text-sm text-green-400 font-bold mb-3 flex items-center gap-2">
                            <span>COMPLETED TASKS</span>
                            <span class="bg-green-900 px-3 py-1 rounded text-xs">${completed.length}</span>
                        </div>
                        ${completed.map(a => {
                            const scoreColor = a.score >= 90 ? 'text-green-400' : a.score >= 70 ? 'text-teal-400' : a.score >= 50 ? 'text-amber-400' : 'text-red-400';
                            const isPerfect = a.score === 100;
                            const isExcellent = a.score >= 90;
                            const needsRetry = a.score < 70;
                            const borderClass = isPerfect ? 'border-green-500 bg-green-900/20' : needsRetry ? 'border-red-500 bg-red-900/20' : 'border-green-900/50 bg-green-900/10';
                            let html = '<div class="p-4 mb-3 border-2 rounded ' + borderClass + '">';
                            html += '<div class="flex justify-between items-center">';
                            html += '<span class="text-sm text-white font-bold">' + a.topic.replace(/-/g, ' ').toUpperCase() + '</span>';
                            html += '<span class="text-lg font-black ' + scoreColor + '">' + a.score + '%' + (isPerfect ? ' üèÜ' : '') + '</span>';
                            html += '</div>';
                            html += '<div class="text-xs text-gray-400 mt-2">' + new Date(a.completedAt).toLocaleString() + '</div>';
                            html += '<div class="flex gap-2 mt-3">';
                            if (isExcellent) {
                                html += '<button onclick="sendAppreciation(\'' + studentId + '\', \'' + studentName + '\', \'' + a.topic + '\', ' + a.score + ')" class="flex-1 bg-green-600 text-white text-xs font-bold py-2 px-3 rounded hover:bg-green-500 transition">üéâ APPRECIATION</button>';
                            } else {
                                html += '<button onclick="sendEncouragement(\'' + studentId + '\', \'' + studentName + '\', \'' + a.topic + '\', ' + a.score + ')" class="flex-1 bg-blue-600 text-white text-xs font-bold py-2 px-3 rounded hover:bg-blue-500 transition">üí¨ SEND NOTE</button>';
                            }
                            if (needsRetry) {
                                html += '<button onclick="regenerateTestForStudent(\'' + studentId + '\', \'' + studentName + '\', \'' + a.topic + '\')" class="flex-1 bg-red-600 text-white text-xs font-bold py-2 px-3 rounded hover:bg-red-500 transition">üîÑ REGENERATE</button>';
                            }
                            html += '</div>';
                            html += '</div>';
                            return html;
                        }).join('')}
                    ` : '<div class="text-sm text-gray-500 mb-4 p-4 border border-gray-800 rounded">No completed tasks yet</div>'}

                    ${pending.length > 0 ? `
                        <div class="text-sm text-amber-400 font-bold mb-3 mt-6 flex items-center gap-2">
                            <span>PENDING TASKS</span>
                            <span class="bg-amber-900 px-3 py-1 rounded text-xs">${pending.length}</span>
                        </div>
                        ${pending.map(a => {
                            let html = '<div class="p-4 mb-3 border-2 border-amber-900/50 bg-amber-900/10 rounded">';
                            html += '<div class="flex justify-between items-center mb-3">';
                            html += '<span class="text-sm text-white font-bold">' + a.topic.replace(/-/g, ' ').toUpperCase() + '</span>';
                            html += '<span class="text-xs bg-amber-500 text-black px-3 py-1 font-bold rounded">PENDING</span>';
                            html += '</div>';
                            html += '<div class="text-xs text-gray-400 mb-3">Assigned: ' + new Date(a.createdAt).toLocaleDateString() + '</div>';
                            html += '<div class="p-3 bg-black/50 border border-amber-900/30 rounded">';
                            html += '<div class="flex items-center gap-3 mb-3">';
                            html += '<span class="text-xs text-amber-400 font-bold">üìÖ Set Due Date:</span>';
                            html += '<input type="date" id="due-' + a.id + '" class="bg-black border-2 border-amber-500 text-sm text-white px-4 py-2 flex-1 cursor-pointer hover:border-amber-300 rounded" style="color-scheme: dark;">';
                            html += '</div>';
                            html += '<button onclick="sendTaskReminder(\'' + a.id + '\', \'' + studentId + '\', \'' + studentName + '\', \'' + a.topic + '\')" class="w-full bg-amber-500 text-black text-sm font-bold py-3 px-4 hover:bg-amber-400 transition rounded">üìß SEND REMINDER</button>';
                            html += '</div>';
                            html += '</div>';
                            return html;
                        }).join('')}
                    ` : ''}

                    ${studentAssignments.length === 0 ? `
                        <div class="text-center p-6 border border-gray-800 bg-gray-900/20">
                            <div class="text-2xl mb-2">üìã</div>
                            <div class="text-[10px] text-gray-400">No assignments for ${studentName} yet</div>
                            <div class="text-[9px] text-teal-400 mt-2">Assign a practice task from the right panel</div>
                        </div>
                    ` : ''}
                `;
            }
        } catch (err) {
            console.error('Load student data error:', err);
        }
    }

    // Send task reminder to student
    window.sendTaskReminder = async function(assignmentId, studentId, studentName, topic) {
        const dueDateInput = document.getElementById(`due-${assignmentId}`);
        const dueDate = dueDateInput ? dueDateInput.value : null;

        // Require date selection
        if (!dueDate) {
            showToast('‚ö†Ô∏è Date Required', 'Please select a due date before sending the reminder.', 'error', 3000);
            // Highlight the date input
            if (dueDateInput) {
                dueDateInput.style.borderColor = '#ff3131';
                dueDateInput.focus();
                setTimeout(() => {
                    dueDateInput.style.borderColor = '';
                }, 2000);
            }
            return;
        }

        const dueDateText = `Due: ${new Date(dueDate).toLocaleDateString()}`;

        try {
            const response = await fetch('/api/notifications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: studentId,
                    type: 'reminder',
                    title: 'Complete Pending Task',
                    message: `Your teacher wants you to complete "${topic}" ${dueDateText}. Please finish it soon!`,
                    metadata: JSON.stringify({ assignmentId, topic, dueDate })
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Reminder Sent', `${studentName} will be notified to complete ${topic}`, 'success');
            } else {
                showToast('Error', 'Failed to send reminder: ' + data.error, 'error');
            }
        } catch (err) {
            console.error('Send reminder error:', err);
            showToast('Error', 'Failed to send reminder', 'error');
        }
    }

    // Send appreciation to student who scored 90%+
    window.sendAppreciation = async function(studentId, studentName, topic, score) {
        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) return;
        const user = JSON.parse(userStr);
        const teacherId = user.teacherId || user.id;
        const teacherName = user.name || 'Your Teacher';

        try {
            const response = await fetch('/api/notifications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: studentId,
                    type: 'appreciation',
                    title: score === 100 ? 'üèÜ Perfect Score Recognition!' : 'üéâ Excellent Work!',
                    message: score === 100
                        ? `${teacherName} is amazed by your perfect score on ${topic.replace(/-/g, ' ')}! You're a star student! Keep shining! ‚≠ê`
                        : `${teacherName} appreciates your excellent performance (${score}%) on ${topic.replace(/-/g, ' ')}! Keep up the great work!`,
                    metadata: JSON.stringify({ topic, score, teacherId, teacherName })
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Appreciation Sent! üéâ', `${studentName} will receive your appreciation for their ${score}% score!`, 'success');
            } else {
                showToast('Error', 'Failed to send appreciation: ' + data.error, 'error');
            }
        } catch (err) {
            console.error('Send appreciation error:', err);
            showToast('Error', 'Failed to send appreciation', 'error');
        }
    }

    // Send encouragement note to student (for any score)
    window.sendEncouragement = async function(studentId, studentName, topic, score) {
        console.log('[SEND NOTE] Sending to student:', studentId, studentName);

        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) return;
        const user = JSON.parse(userStr);
        const teacherName = user.name || 'Your Teacher';

        // Customize message based on score
        let message;
        if (score >= 70) {
            message = `Good job on ${topic.replace(/-/g, ' ')}! You scored ${score}%. Keep practicing to reach excellence!`;
        } else {
            message = `${teacherName} believes in you! Your ${score}% on ${topic.replace(/-/g, ' ')} is a step forward. Keep trying!`;
        }

        try {
            const notifData = {
                userId: studentId,
                type: 'encouragement',
                title: 'üí¨ Message from Your Teacher',
                message: message,
                metadata: JSON.stringify({ topic, score, teacherName })
            };
            console.log('[SEND NOTE] Creating notification:', notifData);

            const response = await fetch('/api/notifications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(notifData)
            });

            const data = await response.json();
            console.log('[SEND NOTE] Response:', data);

            if (data.success) {
                showToast('Note Sent! üí¨', `${studentName} will receive your encouragement message!`, 'success');
            } else {
                showToast('Error', 'Failed to send note: ' + data.error, 'error');
            }
        } catch (err) {
            console.error('Send encouragement error:', err);
            showToast('Error', 'Failed to send note', 'error');
        }
    }

    // Regenerate test for student who scored below 70%
    window.regenerateTestForStudent = async function(studentId, studentName, topic) {
        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) return;
        const user = JSON.parse(userStr);
        const teacherId = user.teacherId || user.id;

        showToast('Generating...', `Creating new practice test on ${topic} for ${studentName}`, 'info');

        try {
            // Generate new questions via exercise agent (port 8005)
            const exerciseResponse = await fetch(getAgentURL(API_CONFIG.EXERCISE_PORT, '/generate'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query_id: `regen-${Date.now()}`,
                    student_id: studentId,
                    topic: topic,
                    difficulty_level: 'beginner',
                    count: 5
                })
            });

            const exerciseData = await exerciseResponse.json();

            // Exercise agent returns 'exercises' array
            if (exerciseData.exercises && exerciseData.exercises.length > 0) {
                // Create new assignment
                const assignResponse = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        teacherId: teacherId,
                        studentId: studentId,
                        studentName: studentName,
                        topic: topic,
                        level: 'beginner',
                        questions: exerciseData.exercises
                    })
                });

                const assignData = await assignResponse.json();

                if (assignData.success) {
                    showToast('Test Regenerated! üîÑ', `New ${topic} practice sent to ${studentName}. They will be notified!`, 'success');

                    // Refresh the student view
                    const masteryResponse = await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${studentId}`));
                    const masteryData = await masteryResponse.json();
                    loadSelectedStudentData(studentId, studentName, masteryData);
                } else {
                    showToast('Error', 'Failed to create assignment: ' + assignData.error, 'error');
                }
            } else {
                showToast('Error', 'Failed to generate exercises from agent', 'error');
            }
        } catch (err) {
            console.error('Regenerate test error:', err);
            showToast('Error', 'Failed to regenerate test: ' + err.message, 'error');
        }
    }

    // Load teacher stats and recent submissions for center panel
    async function loadTeacherStats() {
        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) return;
        const user = JSON.parse(userStr);
        const teacherId = user.teacherId || user.id;

        try {
            const response = await fetch(`/api/assignments/teacher/${teacherId}`);
            const data = await response.json();

            if (data.success) {
                // Only update stats if in class overview mode (no student selected)
                // This prevents overwriting the individual student view
                if (!selectedStudentId) {
                    // Update stats
                    document.getElementById('stat-tasks-assigned').textContent = data.stats.totalAssigned;
                    document.getElementById('stat-tasks-completed').textContent = data.stats.totalCompleted;
                    document.getElementById('stat-pending-students').textContent = data.stats.totalPending;
                    document.getElementById('stat-avg-score').textContent = data.stats.avgScore + '%';

                    // Update recent submissions
                    const submissionsList = document.getElementById('recent-submissions-list');
                    if (data.recentSubmissions.length === 0) {
                        submissionsList.innerHTML = '<div class="text-[10px] text-gray-500">No submissions yet</div>';
                    } else {
                        submissionsList.innerHTML = data.recentSubmissions.map(s => `
                            <div class="p-2 border border-gray-800 bg-black/50 hover:bg-teal-900/10 transition">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-white">${s.studentName}</span>
                                    <span class="text-[9px] ${s.score >= 70 ? 'text-green-400' : s.score >= 50 ? 'text-amber-400' : 'text-red-400'}">${s.score}%</span>
                                </div>
                                <div class="text-[9px] text-teal-400 mt-1">${s.topic}</div>
                                <div class="text-[8px] text-gray-500 mt-1">${new Date(s.completedAt).toLocaleString()}</div>
                            </div>
                        `).join('');
                    }
                }
            }
        } catch (err) {
            console.error('Load teacher stats error:', err);
        }
    }

    // Generate practice set for struggling student (teacher action)
    function generatePracticeSet() {
        if (!selectedStudentId) {
            showToast('Error', 'No student selected', 'error');
            return;
        }

        // This would call the exercise generation agent
        const logsContainer = document.getElementById('agent-logs');
        const msg = document.createElement('div');
        msg.className = 'text-amber-400';
        msg.textContent = `[TEACHER ACTION] Generating practice set for student ${selectedStudentId}...`;
        logsContainer.appendChild(msg);
        logsContainer.scrollTop = logsContainer.scrollHeight;

        // TODO: Call exercise generation agent
        setTimeout(() => {
            const successMsg = document.createElement('div');
            successMsg.className = 'text-green-400';
            successMsg.textContent = '[SUCCESS] Practice set generated and sent to student';
            logsContainer.appendChild(successMsg);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }, 1500);
    }

    // Stream Agent Logs
    function startAgentLogStream() {
        const logsContainer = document.getElementById('agent-logs');

        // Simulated log stream (replace with WebSocket for real-time)
        const logs = [
            'triage@alishba-k:~$ incoming payload from node',
            '[SUCCESS] Kafka: message acknowledged',
            'triage@alishba-k:~$ classify --topic=python-fundamentals',
            '[SUCCESS] Intent: CONCEPT | Confidence: 0.94',
            '[SUCCESS] Routing to concepts-agent:8002'
        ];

        logs.forEach((log, i) => {
            setTimeout(() => {
                const div = document.createElement('div');
                div.className = log.includes('[SUCCESS]') ? 'text-green-500' : 'text-teal-500';
                div.innerHTML = log.includes('triage@')
                    ? `<span class="text-teal-500">${log.split('$')[0]}$</span> <span class="text-white">${log.split('$')[1]}</span>`
                    : log;
                logsContainer.appendChild(div);
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }, i * 500);
        });
    }

    // Auth mode state
    let isRegisterMode = true;

    // Toggle password visibility
    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('authPassword');
        const eyeIcon = document.getElementById('eyeIcon');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.textContent = 'üôà';
        } else {
            passwordInput.type = 'password';
            eyeIcon.textContent = 'üëÅ';
        }
    }

    function toggleAuthMode() {
        isRegisterMode = !isRegisterMode;
        const nameField = document.getElementById('nameField');
        const toggleButton = document.getElementById('toggleAuthMode');
        const titleEl = document.getElementById('authModeTitle');
        const mainButton = document.getElementById('authButton');

        if (isRegisterMode) {
            nameField.style.display = 'block';
            toggleButton.textContent = 'EXISTING USER? RETURN_TO_LOGIN';
            titleEl.textContent = 'REGISTRATION';
            mainButton.textContent = 'REGISTER_IDENTITY';
        } else {
            nameField.style.display = 'none';
            toggleButton.textContent = 'NEW USER? INITIATE_REGISTRATION';
            titleEl.textContent = 'Identity Check';
            mainButton.textContent = 'ESTABLISH_CONNECTION';
        }
        // Clear error
        document.getElementById('authError').classList.add('hidden');
    }

    // Real authentication function
    async function startHandshake() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        const name = document.getElementById('authName').value;
        const role = document.getElementById('roleToggle').checked ? 'teacher' : 'student';
        const errorEl = document.getElementById('authError');
        const button = document.getElementById('authButton');

        // Validation
        if (!email || !password) {
            errorEl.textContent = '[ERROR] Email and password required';
            errorEl.classList.remove('hidden');
            return;
        }

        if (isRegisterMode && !name) {
            errorEl.textContent = '[ERROR] Name required for registration';
            errorEl.classList.remove('hidden');
            return;
        }

        // Disable button
        button.disabled = true;
        button.textContent = 'AUTHENTICATING...';
        errorEl.classList.add('hidden');

        try {
            // Call appropriate API
            const endpoint = isRegisterMode ? '/api/auth/register' : '/api/auth/login';
            const body = isRegisterMode
                ? { name, email, password, role }
                : { email, password, role };  // CRITICAL: Send role for validation

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            // Handle role mismatch error specially
            if (!response.ok && data.registeredRole) {
                errorEl.innerHTML = `<div class="text-red-400">[ERROR] ${data.error}</div>
                    <div class="text-yellow-400 text-[9px] mt-2">Toggle switch to ${data.registeredRole.toUpperCase()} and try again.</div>`;
                errorEl.classList.remove('hidden');

                // Auto-switch toggle to correct role
                const toggle = document.getElementById('roleToggle');
                toggle.checked = (data.registeredRole === 'teacher');

                button.disabled = false;
                button.textContent = 'ESTABLISH_CONNECTION';
                return;
            }

            if (response.ok && data.success) {
                // Store user info in localStorage for persistence
                localStorage.setItem('learnflow_user', JSON.stringify(data.user));

                // CRITICAL: Set session user for THIS tab - prevents cross-tab pollution
                currentSessionUser = data.user;
                console.log('[Session] User set for this tab:', currentSessionUser.role, currentSessionUser.email);

                // CRITICAL: Clear ALL notification state for new login
                // This prevents mixing notifications from different users/roles
                notificationsData = [];
                notificationsInitialized = false;
                seenNotificationIds.clear();
                stopNotificationPolling();

                // Show handshake animation
                const logs = document.getElementById('handshakeLogs');
                logs.classList.remove('hidden');
                logs.innerHTML = '';

                const roleLabel = role.toUpperCase();
                const lines = [
                    "[SUCCESS] Connecting to LearnFlow Backend...",
                    "[SUCCESS] Triage Agent: HEALTHY (port 8001)",
                    "[SUCCESS] Concepts Agent: HEALTHY (port 8002)",
                    "[SUCCESS] Progress Tracker: HEALTHY (port 8006)",
                    `[SUCCESS] Identity Verified: ${roleLabel}_NODE_${data.user.id.substring(0, 8)}`,
                    `[SUCCESS] Session Token: ${generateFakeToken()}`,
                    "Handshake Complete. Loading HUD..."
                ];

                for (let i = 0; i < lines.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 400));
                    const div = document.createElement('div');
                    div.className = 'text-green-400 text-xs';
                    div.textContent = lines[i];
                    logs.appendChild(div);
                    logs.scrollTop = logs.scrollHeight;
                }

                // Go to dashboard
                await new Promise(resolve => setTimeout(resolve, 1000));
                showPage('dashboard');

                if (role === 'teacher') {
                    document.getElementById('struggleConsole').classList.remove('hidden');
                }

                // Fetch and display mastery data
                await fetchMasteryData();

            } else {
                // Auth failed
                errorEl.textContent = '[ERROR] ' + (data.error || 'Authentication failed');
                errorEl.classList.remove('hidden');
                button.disabled = false;
                button.textContent = isRegisterMode ? 'REGISTER_IDENTITY' : 'ESTABLISH_CONNECTION';
            }

        } catch (error) {
            errorEl.textContent = '[ERROR] Connection failed: ' + error.message;
            errorEl.classList.remove('hidden');
            button.disabled = false;
            button.textContent = isRegisterMode ? 'REGISTER_IDENTITY' : 'ESTABLISH_CONNECTION';
        }
    }

    function generateFakeToken() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let token = '';
        for (let i = 0; i < 16; i++) {
            token += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return token;
    }

    // THREE.JS IMPLEMENTATIONS
    let heroScene, heroCamera, heroRenderer, heroMesh;
    function initHeroThree() {
        heroScene = new THREE.Scene();
        heroCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        heroRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        heroRenderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('three-hero-container').appendChild(heroRenderer.domElement);

        const geometry = new THREE.IcosahedronGeometry(2, 2);
        const material = new THREE.MeshBasicMaterial({
            color: 0x00ffcc,
            wireframe: true,
            transparent: true,
            opacity: 0.3
        });
        heroMesh = new THREE.Mesh(geometry, material);
        heroScene.add(heroMesh);

        const pointsGeom = new THREE.IcosahedronGeometry(2.1, 3);
        const pointsMat = new THREE.PointsMaterial({ color: 0x00ffcc, size: 0.05 });
        const points = new THREE.Points(pointsGeom, pointsMat);
        heroScene.add(points);

        heroCamera.position.z = 5;

        function animate() {
            requestAnimationFrame(animate);
            heroMesh.rotation.y += 0.005;
            heroMesh.rotation.x += 0.002;
            points.rotation.y -= 0.003;
            heroRenderer.render(heroScene, heroCamera);
        }
        animate();
    }

    let dashScene, dashCamera, dashRenderer;
    function initDashboardThree() {
        if (dashRenderer) return;
        const container = document.getElementById('three-dashboard-container');
        dashScene = new THREE.Scene();
        dashCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        dashRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        dashRenderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(dashRenderer.domElement);

        const group = new THREE.Group();
        const colors = [0xff3131, 0xffaa00, 0x39ff14, 0x00f0ff, 0x00ffcc, 0x00f0ff, 0x39ff14, 0x39ff14];

        for (let i = 0; i < 8; i++) {
            const ringGeom = new THREE.TorusGeometry(1.5 + (i * 0.2), 0.01, 16, 100);
            const ringMat = new THREE.MeshBasicMaterial({ color: colors[i], transparent: true, opacity: 0.5 });
            const ring = new THREE.Mesh(ringGeom, ringMat);
            ring.rotation.x = Math.random() * Math.PI;
            ring.rotation.y = Math.random() * Math.PI;
            group.add(ring);
        }

        dashScene.add(group);
        dashCamera.position.z = 5;

        function animate() {
            requestAnimationFrame(animate);
            group.rotation.y += 0.01;
            group.rotation.x += 0.005;
            dashRenderer.render(dashScene, dashCamera);
        }
        animate();
    }

    document.addEventListener('mousemove', (e) => {
        const x = (e.clientX / window.innerWidth - 0.5) * 20;
        const y = (e.clientY / window.innerHeight - 0.5) * 20;
        if (heroMesh) {
            heroMesh.rotation.y = x * 0.1;
            heroMesh.rotation.x = y * 0.1;
        }
    });

    window.onload = () => {
        initHeroThree();
        checkBackendHealth();
        setInterval(checkBackendHealth, 10000);
    };

    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes packetMove {
            0% { left: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 100%; opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // Agent Chat System - CONNECT TO BACKEND!
    async function sendToAgent(query) {
        const logsContainer = document.getElementById('agent-logs');
        const inputField = document.getElementById('agent-input');

        if (!query || query.trim() === '') return;

        // Clear input
        inputField.value = '';

        // Get user info
        const userStr = localStorage.getItem('learnflow_user');
        const user = userStr ? JSON.parse(userStr) : { id: 'demo-user', studentId: 'demo-student-001' };

        // Add user message to logs
        const userMsg = document.createElement('div');
        userMsg.className = 'text-teal-500';
        userMsg.innerHTML = `you@learnflow:~$ <span class="text-white">${query}</span>`;
        logsContainer.appendChild(userMsg);
        logsContainer.scrollTop = logsContainer.scrollHeight;

        // Show loading
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'text-yellow-400';
        loadingMsg.textContent = '[PROCESSING] Sending to Triage Agent...';
        logsContainer.appendChild(loadingMsg);
        logsContainer.scrollTop = logsContainer.scrollHeight;

        try {
            // Call Triage Agent to analyze and route
            const triageResponse = await fetch(getAgentURL(API_CONFIG.TRIAGE_PORT, '/analyze'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query_id: `query-${Date.now()}`,
                    student_id: user.studentId || 'demo-student-001',
                    query_text: query
                })
            });

            const triageData = await triageResponse.json();

            // Remove loading
            loadingMsg.remove();

            // Show triage result (backend returns detected_intent and routed_to_agent)
            const intent = triageData.detected_intent || triageData.intent;
            const targetAgent = triageData.routed_to_agent || triageData.target_agent;

            const triageMsg = document.createElement('div');
            triageMsg.className = 'text-green-400';
            triageMsg.textContent = `[SUCCESS] Intent: ${intent} | Routing to: ${targetAgent}`;
            logsContainer.appendChild(triageMsg);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // Now call the appropriate agent based on routing
            let agentUrl = '';
            let agentName = '';

            if (targetAgent === 'concepts' || targetAgent === 'concepts-agent') {
                agentUrl = getAgentURL(API_CONFIG.CONCEPTS_PORT, '/explain');
                agentName = 'Concepts Agent';
            } else if (targetAgent === 'exercise' || targetAgent === 'exercise-agent') {
                agentUrl = getAgentURL(API_CONFIG.EXERCISE_PORT, '/generate');
                agentName = 'Exercise Agent';
            } else if (targetAgent === 'code_review' || targetAgent === 'code-review-agent') {
                agentUrl = getAgentURL(API_CONFIG.CODE_REVIEW_PORT, '/review');
                agentName = 'Code Review Agent';
            } else if (targetAgent === 'debug' || targetAgent === 'debug-agent') {
                agentUrl = getAgentURL(API_CONFIG.DEBUG_PORT, '/diagnose');
                agentName = 'Debug Agent';
            }

            if (agentUrl) {
                const agentLoadingMsg = document.createElement('div');
                agentLoadingMsg.className = 'text-yellow-400';
                agentLoadingMsg.textContent = `[PROCESSING] ${agentName} thinking...`;
                logsContainer.appendChild(agentLoadingMsg);
                logsContainer.scrollTop = logsContainer.scrollHeight;

                // Call the agent (concepts agent for explanation)
                if (targetAgent === 'concepts' || targetAgent === 'concepts-agent') {
                    try {
                        // Add 30 second timeout for Claude API
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000);

                        const conceptResponse = await fetch(agentUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                query_id: `query-${Date.now()}`,
                                student_id: user.studentId || 'demo-student-001',
                                topic: triageData.extracted_entities?.topic || 'python-basics',
                                concept: query,
                                context: []
                            }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        const conceptData = await conceptResponse.json();

                        agentLoadingMsg.remove();

                        // Show agent response
                        const responseMsg = document.createElement('div');
                        responseMsg.className = 'text-blue-400 text-xs my-2 p-2 border border-blue-900 rounded';
                        responseMsg.innerHTML = `<strong>${agentName}:</strong><br>${conceptData.explanation || conceptData.message || JSON.stringify(conceptData)}`;
                        logsContainer.appendChild(responseMsg);
                        logsContainer.scrollTop = logsContainer.scrollHeight;

                        // Update mastery after interaction
                        await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${user.studentId || 'demo-student-001'}`), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                student_id: user.studentId || 'demo-student-001',
                                topic: triageData.extracted_entities?.topic || 'python-basics',
                                interaction_type: 'concept_query',
                                success: true
                            })
                        }).catch(err => console.error('Failed to update mastery:', err));

                        // Refresh mastery display
                        await fetchMasteryData();

                    } catch (agentError) {
                        agentLoadingMsg.remove();
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'text-red-500 text-xs';
                        errorMsg.textContent = `[ERROR] ${agentName} failed: ${agentError.name === 'AbortError' ? 'Timeout (30s) - Agent is slow, try again' : agentError.message}`;
                        logsContainer.appendChild(errorMsg);
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                }
            }

        } catch (error) {
            loadingMsg.remove();
            const errorMsg = document.createElement('div');
            errorMsg.className = 'text-red-500';
            errorMsg.textContent = '[ERROR] Failed to contact agent: ' + error.message;
            logsContainer.appendChild(errorMsg);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
    }

    // Test all agents health endpoints
    async function testAllAgents() {
        const logsContainer = document.getElementById('agent-logs');
        if (!logsContainer) {
            showToast('Error', 'Please go to dashboard first', 'error');
            return;
        }

        // Clear logs and add header
        logsContainer.innerHTML = '';
        const header = document.createElement('div');
        header.className = 'text-cyan-400 font-bold mb-2';
        header.textContent = '=== TESTING ALL LEARNFLOW AGENTS ===';
        logsContainer.appendChild(header);

        const agents = [
            { name: 'Triage Agent', url: getAgentURL(API_CONFIG.TRIAGE_PORT, '/health') },
            { name: 'Concepts Agent', url: getAgentURL(API_CONFIG.CONCEPTS_PORT, '/health') },
            { name: 'Code Review Agent', url: getAgentURL(API_CONFIG.CODE_REVIEW_PORT, '/health') },
            { name: 'Debug Agent', url: getAgentURL(API_CONFIG.DEBUG_PORT, '/health') },
            { name: 'Exercise Agent', url: getAgentURL(API_CONFIG.EXERCISE_PORT, '/health') },
            { name: 'Progress Tracker', url: getAgentURL(API_CONFIG.PROGRESS_PORT, '/health') }
        ];

        for (const agent of agents) {
            const msg = document.createElement('div');
            try {
                const response = await fetch(agent.url, { timeout: 5000 });
                const data = await response.json();
                // Accept both 'healthy' and 'ok' status
                if (response.ok && (data.status === 'healthy' || data.status === 'ok')) {
                    msg.className = 'text-green-400 text-xs';
                    msg.textContent = `‚úì ${agent.name}: Running successfully`;
                    console.log(`‚úì ${agent.name}: Running successfully`);
                } else {
                    msg.className = 'text-yellow-400 text-xs';
                    msg.textContent = `‚ö† ${agent.name}: UNHEALTHY - ${JSON.stringify(data)}`;
                    console.log(`‚úó ${agent.name}: UNHEALTHY`);
                }
            } catch (error) {
                msg.className = 'text-red-400 text-xs';
                msg.textContent = `‚úó ${agent.name}: OFFLINE - ${error.message}`;
                console.log(`‚úó ${agent.name}: OFFLINE - ${error.message}`);
            }
            logsContainer.appendChild(msg);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        const footer = document.createElement('div');
        footer.className = 'text-cyan-400 font-bold mt-2';
        footer.textContent = '=== TEST COMPLETE ===';
        logsContainer.appendChild(footer);
        console.log('=== TEST COMPLETE ===');
    }

    // Storage for current practice session (used by MCQ system)
    let currentPracticeSession = null;

    // Global variable for generated test (used by MCQ system)
    let generatedTest = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MCQ PRACTICE SYSTEM - EMBEDDED (PRODUCTION FIX)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let assignedTests = [];

    // MCQ Database
    const mcqDatabase = {
        'python-basics': [
            {question: "What is Python?", options: ["A snake", "A programming language", "A database", "An operating system"], correct: 1},
            {question: "Which symbol is used for comments in Python?", options: ["//", "/* */", "#", "<!--"], correct: 2},
            {question: "What is the output of: print(2 + 2)?", options: ["22", "4", "Error", "2+2"], correct: 1}
        ],
        'variables-and-data-types': [
            {question: "Which is NOT a valid variable name in Python?", options: ["my_var", "2nd_var", "_var", "var2"], correct: 1},
            {question: "What type is the value: 3.14?", options: ["int", "float", "string", "boolean"], correct: 1},
            {question: "How do you create a string in Python?", options: ["'text'", "[text]", "{text}", "(text)"], correct: 0}
        ],
        'control-flow': [
            {question: "Which keyword starts a conditional statement?", options: ["while", "for", "if", "def"], correct: 2},
            {question: "What does 'break' do in a loop?", options: ["Pauses the loop", "Exits the loop", "Continues to next iteration", "Crashes the program"], correct: 1},
            {question: "Which loop runs at least once?", options: ["for loop", "while loop", "do-while loop", "if statement"], correct: 2}
        ],
        'functions': [
            {question: "How do you define a function in Python?", options: ["function myFunc()", "def myFunc():", "func myFunc()", "define myFunc()"], correct: 1},
            {question: "What does 'return' do in a function?", options: ["Prints a value", "Exits and sends back a value", "Deletes a variable", "Creates a loop"], correct: 1},
            {question: "Can a function have multiple return statements?", options: ["Yes", "No", "Only in classes", "Only with recursion"], correct: 0}
        ],
        'data-structures': [
            {question: "How do you create an empty list in Python?", options: ["{}", "[]", "()", "<>"], correct: 1},
            {question: "What method adds an item to the end of a list?", options: ["add()", "append()", "insert()", "push()"], correct: 1},
            {question: "What is a tuple in Python?", options: ["Mutable list", "Immutable list", "Dictionary", "Set"], correct: 1}
        ]
    };

    function generateMCQs(topicId, topicName) {
        return mcqDatabase[topicId] || [
            {question: `What is ${topicName}?`, options: ["Option A", "Option B", "Option C", "Option D"], correct: 0},
            {question: `How do you use ${topicName}?`, options: ["Method 1", "Method 2", "Method 3", "Method 4"], correct: 1},
            {question: `Why is ${topicName} important?`, options: ["Reason 1", "Reason 2", "Reason 3", "Reason 4"], correct: 2}
        ];
    }

    function showTopicsList() {
        // Legacy function - now just calls openPracticeTopicsInCenter
        openPracticeTopicsInCenter();
    }

    // Open practice topics in CENTER panel for better visibility
    function openPracticeTopicsInCenter() {
        const overviewView = document.getElementById('student-overview-view');
        const topicsView = document.getElementById('student-topics-view');
        const practiceView = document.getElementById('student-practice-view');

        // Hide other views, show topics
        if (overviewView) overviewView.classList.add('hidden');
        if (practiceView) {
            practiceView.classList.add('hidden');
            practiceView.style.display = 'none';
        }
        if (topicsView) {
            topicsView.classList.remove('hidden');
            topicsView.style.display = 'flex';
        }

        // Load topics into center panel
        loadTopicsInCenter();
    }

    // Close topics view and return to overview
    function closeTopicsView() {
        const overviewView = document.getElementById('student-overview-view');
        const topicsView = document.getElementById('student-topics-view');

        if (topicsView) {
            topicsView.classList.add('hidden');
            topicsView.style.display = 'none';
        }
        if (overviewView) {
            overviewView.classList.remove('hidden');
        }
    }

    // ============ CODE LAB FUNCTIONS ============

    // Open Code Lab in center panel
    function openCodeLabInCenter() {
        const overviewView = document.getElementById('student-overview-view');
        const topicsView = document.getElementById('student-topics-view');
        const practiceView = document.getElementById('student-practice-view');
        const codelabView = document.getElementById('student-codelab-view');

        // Hide all other views
        if (overviewView) overviewView.classList.add('hidden');
        if (topicsView) {
            topicsView.classList.add('hidden');
            topicsView.style.display = 'none';
        }
        if (practiceView) {
            practiceView.classList.add('hidden');
            practiceView.style.display = 'none';
        }

        // Show Code Lab
        if (codelabView) {
            codelabView.classList.remove('hidden');
            codelabView.style.display = 'flex';
        }

        // Clear previous feedback
        const feedbackPanel = document.getElementById('code-feedback-panel');
        if (feedbackPanel) feedbackPanel.classList.add('hidden');

        // Load coding challenges
        loadCodingChallenges();
    }

    // Close Code Lab and return to overview
    function closeCodeLab() {
        const overviewView = document.getElementById('student-overview-view');
        const codelabView = document.getElementById('student-codelab-view');
        const challengeView = document.getElementById('student-code-challenge-view');

        if (codelabView) {
            codelabView.classList.add('hidden');
            codelabView.style.display = 'none';
        }
        if (challengeView) {
            challengeView.classList.add('hidden');
            challengeView.style.display = 'none';
        }
        if (overviewView) {
            overviewView.classList.remove('hidden');
        }
    }

    // Coding challenges database (like W3Schools)
    const codingChallenges = [
        {
            id: 'print-hello',
            title: 'Print Hello World',
            difficulty: 'Beginner',
            category: 'Python Basics',
            description: 'Write a Python program that prints "Hello, World!" to the screen.\n\nThis is the traditional first program for learning any programming language.',
            expected: 'Hello, World!',
            hint: 'Use the print() function with a string inside.',
            starterCode: '# Write your code below\n'
        },
        {
            id: 'add-numbers',
            title: 'Add Two Numbers',
            difficulty: 'Beginner',
            category: 'Python Basics',
            description: 'Create variables x = 5 and y = 10, then print their sum.\n\nLearn how to create variables and perform basic arithmetic.',
            expected: '15',
            hint: 'Create two variables with = and use print() to show x + y',
            starterCode: '# Create variables x and y\nx = 5\ny = 10\n\n# Print the sum\n'
        },
        {
            id: 'string-length',
            title: 'Find String Length',
            difficulty: 'Beginner',
            category: 'Strings',
            description: 'Given the string txt = "Hello World", print the length of the string.\n\nLearn how to use the len() function.',
            expected: '11',
            hint: 'Use the len() function to get the length of a string.',
            starterCode: 'txt = "Hello World"\n\n# Print the length of txt\n'
        },
        {
            id: 'list-access',
            title: 'Access List Item',
            difficulty: 'Beginner',
            category: 'Lists',
            description: 'Given the list fruits = ["apple", "banana", "cherry"], print the second item.\n\nRemember: List indexing starts at 0!',
            expected: 'banana',
            hint: 'Use index [1] to access the second item (indexing starts at 0).',
            starterCode: 'fruits = ["apple", "banana", "cherry"]\n\n# Print the second item\n'
        },
        {
            id: 'for-loop',
            title: 'Loop Through List',
            difficulty: 'Beginner',
            category: 'Loops',
            description: 'Use a for loop to print each fruit in the list fruits = ["apple", "banana", "cherry"].\n\nEach fruit should be on a new line.',
            expected: 'apple\nbanana\ncherry',
            hint: 'Use: for item in list: and then print(item)',
            starterCode: 'fruits = ["apple", "banana", "cherry"]\n\n# Loop through and print each fruit\n'
        },
        {
            id: 'if-statement',
            title: 'Check Number',
            difficulty: 'Beginner',
            category: 'Conditions',
            description: 'Given x = 10, write an if statement that prints "x is positive" if x is greater than 0.',
            expected: 'x is positive',
            hint: 'Use: if x > 0: followed by print()',
            starterCode: 'x = 10\n\n# Check if x is positive\n'
        },
        {
            id: 'function-def',
            title: 'Create a Function',
            difficulty: 'Intermediate',
            category: 'Functions',
            description: 'Create a function called greet that takes a name parameter and returns "Hello, " followed by the name.\n\nThen call greet("Python") and print the result.',
            expected: 'Hello, Python',
            hint: 'Use def greet(name): and return "Hello, " + name',
            starterCode: '# Define the greet function\n\n\n# Call the function and print result\n'
        },
        {
            id: 'list-comprehension',
            title: 'List Comprehension',
            difficulty: 'Intermediate',
            category: 'Lists',
            description: 'Using list comprehension, create a list of squares for numbers 1-5.\n\nPrint the resulting list.',
            expected: '[1, 4, 9, 16, 25]',
            hint: 'Use: [x**2 for x in range(1, 6)]',
            starterCode: '# Create list of squares using list comprehension\n\n\n# Print the list\n'
        },
        {
            id: 'dictionary-access',
            title: 'Dictionary Access',
            difficulty: 'Intermediate',
            category: 'Dictionaries',
            description: 'Given person = {"name": "John", "age": 30}, print the value of the "name" key.',
            expected: 'John',
            hint: 'Use person["name"] or person.get("name")',
            starterCode: 'person = {"name": "John", "age": 30}\n\n# Print the name\n'
        },
        {
            id: 'class-create',
            title: 'Create a Class',
            difficulty: 'Advanced',
            category: 'OOP',
            description: 'Create a class called Dog with an __init__ method that takes name as parameter.\n\nAdd a bark method that returns "Woof!".\n\nCreate an instance my_dog with name "Buddy" and print my_dog.bark().',
            expected: 'Woof!',
            hint: 'Use class Dog: with def __init__(self, name): and def bark(self):',
            starterCode: '# Create the Dog class\n\n\n# Create instance and call bark()\n'
        },
        // More challenges for practice
        {
            id: 'reverse-string',
            title: 'Reverse a String',
            difficulty: 'Easy',
            category: 'Strings',
            description: 'Given txt = "Python", print the string reversed.',
            expected: 'nohtyP',
            hint: 'Use string slicing: txt[::-1]',
            starterCode: 'txt = "Python"\n\n# Print the reversed string\n'
        },
        {
            id: 'sum-list',
            title: 'Sum of List',
            difficulty: 'Easy',
            category: 'Lists',
            description: 'Given numbers = [1, 2, 3, 4, 5], print the sum of all numbers.',
            expected: '15',
            hint: 'Use the sum() function',
            starterCode: 'numbers = [1, 2, 3, 4, 5]\n\n# Print the sum\n'
        },
        {
            id: 'max-value',
            title: 'Find Maximum',
            difficulty: 'Easy',
            category: 'Lists',
            description: 'Given numbers = [3, 7, 2, 9, 1], print the maximum value.',
            expected: '9',
            hint: 'Use the max() function',
            starterCode: 'numbers = [3, 7, 2, 9, 1]\n\n# Print the maximum\n'
        },
        {
            id: 'count-vowels',
            title: 'Count Vowels',
            difficulty: 'Medium',
            category: 'Strings',
            description: 'Count and print the number of vowels (a,e,i,o,u) in "Hello World".',
            expected: '3',
            hint: 'Loop through each character and check if it is in "aeiouAEIOU"',
            starterCode: 'txt = "Hello World"\nvowels = "aeiouAEIOU"\ncount = 0\n\n# Count vowels\n'
        },
        {
            id: 'even-numbers',
            title: 'Filter Even Numbers',
            difficulty: 'Medium',
            category: 'Lists',
            description: 'From numbers = [1,2,3,4,5,6,7,8,9,10], create a list of even numbers and print it.',
            expected: '[2, 4, 6, 8, 10]',
            hint: 'Use list comprehension: [x for x in numbers if x % 2 == 0]',
            starterCode: 'numbers = [1,2,3,4,5,6,7,8,9,10]\n\n# Filter even numbers\n'
        },
        {
            id: 'factorial',
            title: 'Calculate Factorial',
            difficulty: 'Medium',
            category: 'Functions',
            description: 'Create a function factorial(n) that calculates n! (factorial).\n\nPrint factorial(5) which should be 120.',
            expected: '120',
            hint: 'Use a loop or recursion: result = result * i',
            starterCode: 'def factorial(n):\n    # Your code here\n    pass\n\n# Print factorial(5)\n'
        },
        {
            id: 'palindrome',
            title: 'Check Palindrome',
            difficulty: 'Medium',
            category: 'Strings',
            description: 'Check if "radar" is a palindrome (same forwards and backwards).\n\nPrint "Yes" if it is, "No" if not.',
            expected: 'Yes',
            hint: 'Compare word with word[::-1]',
            starterCode: 'word = "radar"\n\n# Check if palindrome and print Yes or No\n'
        },
        {
            id: 'fizzbuzz',
            title: 'FizzBuzz',
            difficulty: 'Medium',
            category: 'Loops',
            description: 'Print numbers 1-15. For multiples of 3 print "Fizz", for 5 print "Buzz", for both print "FizzBuzz".',
            expected: '1\n2\nFizz\n4\nBuzz\nFizz\n7\n8\nFizz\nBuzz\n11\nFizz\n13\n14\nFizzBuzz',
            hint: 'Use if/elif/else with modulo operator %',
            starterCode: '# Print FizzBuzz for 1-15\n'
        },
        {
            id: 'word-frequency',
            title: 'Word Frequency',
            difficulty: 'Hard',
            category: 'Dictionaries',
            description: 'Count word frequency in "apple banana apple cherry banana apple".\n\nPrint the dictionary.',
            expected: "{'apple': 3, 'banana': 2, 'cherry': 1}",
            hint: 'Use a dictionary and loop through words.split()',
            starterCode: 'text = "apple banana apple cherry banana apple"\nword_count = {}\n\n# Count words\n'
        },
        {
            id: 'prime-check',
            title: 'Check Prime Number',
            difficulty: 'Hard',
            category: 'Functions',
            description: 'Create a function is_prime(n) that returns True if n is prime.\n\nPrint is_prime(17).',
            expected: 'True',
            hint: 'Check if n is divisible by any number from 2 to sqrt(n)',
            starterCode: 'def is_prime(n):\n    # Your code here\n    pass\n\n# Print is_prime(17)\n'
        },
        {
            id: 'fibonacci',
            title: 'Fibonacci Sequence',
            difficulty: 'Hard',
            category: 'Functions',
            description: 'Print the first 10 Fibonacci numbers: 0, 1, 1, 2, 3, 5, 8, 13, 21, 34',
            expected: '0\n1\n1\n2\n3\n5\n8\n13\n21\n34',
            hint: 'Each number is sum of previous two: fib(n) = fib(n-1) + fib(n-2)',
            starterCode: '# Print first 10 Fibonacci numbers\n'
        },
        {
            id: 'sort-list',
            title: 'Sort a List',
            difficulty: 'Easy',
            category: 'Lists',
            description: 'Sort the list [5, 2, 8, 1, 9] in ascending order and print it.',
            expected: '[1, 2, 5, 8, 9]',
            hint: 'Use sorted() or list.sort()',
            starterCode: 'numbers = [5, 2, 8, 1, 9]\n\n# Sort and print\n'
        }
    ];

    // Load challenges into Code Lab
    function loadCodingChallenges() {
        const list = document.getElementById('codelab-challenges-list');
        if (!list) return;

        // Define colors for difficulty levels (same style as Practice Topics)
        const difficultyColors = {
            'Beginner': 'from-green-600 to-green-800',
            'Easy': 'from-blue-600 to-blue-800',
            'Medium': 'from-yellow-600 to-orange-800',
            'Hard': 'from-red-600 to-red-800'
        };

        const difficultyIcons = {
            'Beginner': 'üå±',
            'Easy': 'üìò',
            'Medium': 'üî•',
            'Hard': 'üíé'
        };

        // Create cards similar to Practice Topics style (2-column grid)
        list.innerHTML = codingChallenges.map(c => `
            <button onclick="startCodingChallenge('${c.id}')"
                    class="bg-gradient-to-br ${difficultyColors[c.difficulty] || 'from-purple-600 to-purple-800'} p-4 rounded-lg hover:scale-105 transition transform text-left shadow-lg"
                    data-title="${c.title.toLowerCase()}" data-category="${c.category.toLowerCase()}">
                <div class="text-3xl mb-2">${difficultyIcons[c.difficulty] || 'üíª'}</div>
                <div class="text-white font-bold text-sm">${c.title}</div>
                <div class="text-white/60 text-xs mt-1">${c.category}</div>
                <div class="mt-2 inline-block text-[10px] px-2 py-1 bg-black/30 rounded text-white/80">${c.difficulty}</div>
            </button>
        `).join('');
    }

    // Filter coding challenges based on search
    function filterCodingChallenges() {
        const searchInput = document.getElementById('codelab-search');
        const list = document.getElementById('codelab-challenges-list');
        if (!searchInput || !list) return;

        const query = searchInput.value.toLowerCase();
        const buttons = list.querySelectorAll('button');

        buttons.forEach(btn => {
            const title = btn.dataset.title || '';
            const category = btn.dataset.category || '';
            btn.style.display = (title.includes(query) || category.includes(query)) ? 'block' : 'none';
        });
    }

    // Current challenge being worked on
    let currentChallenge = null;

    // Start a specific coding challenge
    function startCodingChallenge(challengeId) {
        const challenge = codingChallenges.find(c => c.id === challengeId);
        if (!challenge) return;

        currentChallenge = challenge;

        // Hide challenges list, show challenge view
        const codelabView = document.getElementById('student-codelab-view');
        const challengeView = document.getElementById('student-code-challenge-view');

        if (codelabView) {
            codelabView.classList.add('hidden');
            codelabView.style.display = 'none';
        }
        if (challengeView) {
            challengeView.classList.remove('hidden');
            challengeView.style.display = 'flex';
        }

        // Populate challenge details
        document.getElementById('challenge-title').textContent = challenge.title;
        document.getElementById('challenge-difficulty').textContent = `Difficulty: ${challenge.difficulty} | Category: ${challenge.category}`;
        document.getElementById('challenge-description').innerHTML = challenge.description.replace(/\n/g, '<br>');
        document.getElementById('challenge-expected').textContent = challenge.expected;
        document.getElementById('challenge-hint').textContent = challenge.hint;
        document.getElementById('code-editor').value = challenge.starterCode;

        // Clear feedback
        const feedbackPanel = document.getElementById('code-feedback-panel');
        if (feedbackPanel) feedbackPanel.classList.add('hidden');
    }

    // Go back to challenges list
    function backToChallengesList() {
        const codelabView = document.getElementById('student-codelab-view');
        const challengeView = document.getElementById('student-code-challenge-view');

        if (challengeView) {
            challengeView.classList.add('hidden');
            challengeView.style.display = 'none';
        }
        if (codelabView) {
            codelabView.classList.remove('hidden');
            codelabView.style.display = 'flex';
        }

        currentChallenge = null;
    }

    // Simple Python code evaluator (simulated for demo)
    async function runPythonCode() {
        const codeEditor = document.getElementById('code-editor');
        const consoleOutput = document.getElementById('code-console-output');

        if (!codeEditor || !codeEditor.value.trim()) {
            consoleOutput.textContent = '>>> Error: No code to run';
            return;
        }

        const code = codeEditor.value;
        consoleOutput.textContent = '>>> Running code...\n';

        // Simulate Python execution for common patterns
        try {
            let output = simulatePython(code);

            // Check if output matches expected (if in a challenge)
            if (currentChallenge && output.trim() === currentChallenge.expected.trim()) {
                // Random encouraging messages
                const encouragements = [
                    "Excellent! You're a coding star! üåü",
                    "Amazing work! Keep it up! üöÄ",
                    "Perfect! You nailed it! üí™",
                    "Brilliant! Your code is spot on! ‚ú®",
                    "Fantastic job! You're mastering Python! üêç",
                    "Outstanding! Keep this momentum! üî•",
                    "Superb! You're on fire! üíØ",
                    "Well done! That's the correct solution! üéØ"
                ];
                const randomMsg = encouragements[Math.floor(Math.random() * encouragements.length)];

                consoleOutput.innerHTML = `<span class="text-green-400">>>> ${output}</span>\n\n<span class="text-green-300 text-lg font-bold">‚úÖ CORRECT!</span>\n<span class="text-yellow-400">${randomMsg}</span>\n\n<button onclick="generateSimilarChallenge()" class="mt-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs font-bold py-2 px-4 rounded hover:from-purple-500 hover:to-pink-500">üîÑ PRACTICE MORE (Similar)</button>`;
                showToast('üéâ Excellent!', randomMsg, 'success', 4000);

                // Update progress stats
                updateStudentProgress('correct');

                // CRITICAL: Update mastery in backend when coding challenge is solved
                try {
                    const userStr = localStorage.getItem('learnflow_user');
                    const user = userStr ? JSON.parse(userStr) : { studentId: 'demo-student-001' };

                    // Map challenge category to curriculum topic (5 topics)
                    const categoryToTopic = {
                        'Python Basics': 'python-basics',
                        'Strings': 'variables-and-data-types',
                        'Variables': 'variables-and-data-types',
                        'Loops': 'control-flow',
                        'Conditions': 'control-flow',
                        'Functions': 'functions',
                        'Lists': 'data-structures',
                        'Dictionaries': 'data-structures',
                        'OOP': 'data-structures'  // Advanced topics contribute to data structures
                    };
                    const rawCategory = currentChallenge.category || 'Python Basics';
                    const challengeTopic = categoryToTopic[rawCategory] || 'python-basics';

                    console.log(`[MASTERY UPDATE] Coding challenge solved! Category: ${rawCategory} ‚Üí Topic: ${challengeTopic}, Score: 100%`);

                    await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${user.studentId}`), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            student_id: user.studentId,
                            topic: challengeTopic,
                            interaction_type: 'success',
                            success: true,
                            score: 100  // Coding challenge solved = 100%
                        })
                    });
                    console.log(`[MASTERY] Updated successfully for topic: ${challengeTopic}`);
                } catch (masteryErr) {
                    console.error('[MASTERY] Failed to update:', masteryErr);
                }

                // Show celebration effect
                showCelebration();

                // Mark coding assignment as complete if from an assignment
                if (activeAssignmentId) {
                    try {
                        const userStr = localStorage.getItem('learnflow_user');
                        const user = userStr ? JSON.parse(userStr) : {};
                        await fetch(`/api/assignments/${activeAssignmentId}/complete`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ score: 100, studentName: user.name || 'Student' })
                        });
                        console.log('[CODING COMPLETE] Assignment marked complete, notifying teacher');
                        activeAssignmentId = null;
                        loadStudentAssignments();
                    } catch (err) {
                        console.error('Assignment completion error:', err);
                    }
                }

                // CRITICAL: Refresh mastery display immediately
                fetchMasteryData();
            } else if (currentChallenge) {
                consoleOutput.innerHTML = `>>> ${output}\n\n<span class="text-red-400">‚ùå Not quite right...</span>\n<span class="text-yellow-400">Expected: ${currentChallenge.expected}</span>\n<span class="text-gray-400">Keep trying! You've got this! üí™</span>`;
                showToast('Try Again', 'Check your code and try again!', 'info');
            } else {
                consoleOutput.textContent = `>>> ${output}`;
            }
        } catch (err) {
            consoleOutput.innerHTML = `<span class="text-red-400">>>> Error: ${err.message}</span>`;
        }
    }

    // Generate custom problem based on user input
    function generateCustomProblem() {
        const topicInput = document.getElementById('custom-topic-input');
        const difficultySelect = document.getElementById('custom-difficulty-select');

        const topic = topicInput ? topicInput.value.trim() : '';
        const difficulty = difficultySelect ? difficultySelect.value : 'Medium';

        if (!topic) {
            showToast('Enter Topic', 'Please type a topic or keyword', 'error');
            return;
        }

        showToast('Generating...', `Creating ${difficulty} problem about "${topic}"`, 'info', 2000);

        // Problem templates based on difficulty
        const problemTemplates = {
            'Beginner': [
                {
                    title: `Print ${topic}`,
                    description: `Write a Python program that prints "${topic}" to the screen.\n\nThis is a simple print exercise to practice basic output.`,
                    expected: topic,
                    hint: `Use print("${topic}")`,
                    starterCode: `# Print ${topic}\n`
                },
                {
                    title: `${topic} Variable`,
                    description: `Create a variable called "item" with the value "${topic}".\n\nThen print the variable.`,
                    expected: topic,
                    hint: `Create: item = "${topic}" then use print(item)`,
                    starterCode: `# Create a variable and print it\n`
                },
                {
                    title: `${topic} Length`,
                    description: `Find and print the length of the string "${topic}".`,
                    expected: String(topic.length),
                    hint: `Use len("${topic}") to get the length`,
                    starterCode: `text = "${topic}"\n\n# Print the length\n`
                }
            ],
            'Easy': [
                {
                    title: `${topic} Counter`,
                    description: `Create a list with 5 items related to ${topic}.\n\nPrint how many items are in the list.`,
                    expected: '5',
                    hint: 'Use len() to count items in a list',
                    starterCode: `# Create a list of 5 ${topic} items\nitems = []\n\n# Print the count\n`
                },
                {
                    title: `Reverse ${topic}`,
                    description: `Given the word "${topic}", print it reversed.`,
                    expected: topic.split('').reverse().join(''),
                    hint: 'Use string slicing: text[::-1]',
                    starterCode: `word = "${topic}"\n\n# Print reversed\n`
                },
                {
                    title: `${topic} in Uppercase`,
                    description: `Convert "${topic}" to uppercase and print it.`,
                    expected: topic.toUpperCase(),
                    hint: 'Use .upper() method on strings',
                    starterCode: `text = "${topic}"\n\n# Convert to uppercase and print\n`
                }
            ],
            'Medium': [
                {
                    title: `${topic} Checker`,
                    description: `Write a function called check_${topic.toLowerCase().replace(/\\s+/g, '_')}(value) that:\n- Returns "Valid" if value is not empty\n- Returns "Invalid" if value is empty\n\nTest with check_${topic.toLowerCase().replace(/\\s+/g, '_')}("${topic}") and print result.`,
                    expected: 'Valid',
                    hint: 'Use if/else to check if value is truthy',
                    starterCode: `def check_${topic.toLowerCase().replace(/\\s+/g, '_')}(value):\n    # Your code here\n    pass\n\n# Test and print\n`
                },
                {
                    title: `Count in ${topic}`,
                    description: `Count how many times the letter "${topic[0]}" appears in "${topic}".\n\nPrint the count.`,
                    expected: String(topic.split('').filter(c => c.toLowerCase() === topic[0].toLowerCase()).length),
                    hint: `Use a loop or .count() method`,
                    starterCode: `text = "${topic}"\nletter = "${topic[0]}"\n\n# Count and print\n`
                },
                {
                    title: `${topic} Dictionary`,
                    description: `Create a dictionary with:\n- "name": "${topic}"\n- "type": "custom"\n- "active": True\n\nPrint the dictionary.`,
                    expected: `{'name': '${topic}', 'type': 'custom', 'active': True}`,
                    hint: 'Use {} to create a dictionary with key: value pairs',
                    starterCode: `# Create the dictionary\ndata = {}\n\n# Print it\n`
                }
            ],
            'Hard': [
                {
                    title: `${topic} Manager Class`,
                    description: `Create a class called ${topic.replace(/\\s+/g, '')}Manager with:\n- __init__ that takes name\n- get_info() that returns "Managing: {name}"\n\nCreate instance with "${topic}" and print get_info().`,
                    expected: `Managing: ${topic}`,
                    hint: 'Use class ClassName: with def __init__(self, name): and def get_info(self):',
                    starterCode: `# Create the class\nclass ${topic.replace(/\\s+/g, '')}Manager:\n    pass\n\n# Create instance and print\n`
                },
                {
                    title: `${topic} Analyzer`,
                    description: `Write a function analyze_${topic.toLowerCase().replace(/\\s+/g, '_')}(text) that returns a dictionary with:\n- "length": length of text\n- "words": number of words\n- "first_char": first character\n\nTest with "${topic}" and print result.`,
                    expected: `{'length': ${topic.length}, 'words': ${topic.split(' ').length}, 'first_char': '${topic[0]}'}`,
                    hint: 'Use len(), split(), and indexing',
                    starterCode: `def analyze_${topic.toLowerCase().replace(/\\s+/g, '_')}(text):\n    # Your code here\n    pass\n\n# Test and print\n`
                },
                {
                    title: `${topic} Validator`,
                    description: `Create a function validate(items) that:\n- Takes a list of strings\n- Returns only items containing "${topic[0].toLowerCase()}"\n- Use list comprehension\n\nTest with ["${topic}", "test", "example"] and print.`,
                    expected: `['${topic}']`,
                    hint: 'Use [x for x in items if condition]',
                    starterCode: `def validate(items):\n    # Filter items containing "${topic[0].toLowerCase()}"\n    pass\n\n# Test\ntest_items = ["${topic}", "test", "example"]\n`
                }
            ]
        };

        // Get random template for selected difficulty
        const templates = problemTemplates[difficulty] || problemTemplates['Medium'];
        const template = templates[Math.floor(Math.random() * templates.length)];

        // Create custom challenge object
        const customChallenge = {
            id: 'custom-' + Date.now(),
            title: template.title,
            difficulty: difficulty,
            category: 'Custom (' + topic + ')',
            description: template.description,
            expected: template.expected,
            hint: template.hint,
            starterCode: template.starterCode
        };

        // Start the custom challenge
        currentChallenge = customChallenge;
        startCustomChallenge(customChallenge);

        // Clear input
        if (topicInput) topicInput.value = '';
    }

    // Start a custom generated challenge
    function startCustomChallenge(challenge) {
        // Hide challenges list, show challenge view
        const codelabView = document.getElementById('student-codelab-view');
        const challengeView = document.getElementById('student-code-challenge-view');

        if (codelabView) {
            codelabView.classList.add('hidden');
            codelabView.style.display = 'none';
        }
        if (challengeView) {
            challengeView.classList.remove('hidden');
            challengeView.style.display = 'flex';
        }

        // Fill in challenge details
        document.getElementById('challenge-title').textContent = challenge.title;
        document.getElementById('challenge-difficulty').textContent = `Difficulty: ${challenge.difficulty} | ${challenge.category}`;
        document.getElementById('challenge-description').textContent = challenge.description;
        document.getElementById('challenge-expected').textContent = challenge.expected;
        document.getElementById('challenge-hint').textContent = challenge.hint;

        // Set starter code
        const codeEditor = document.getElementById('code-editor');
        if (codeEditor) codeEditor.value = challenge.starterCode;

        // Clear console
        const consoleOutput = document.getElementById('code-console-output');
        if (consoleOutput) consoleOutput.textContent = '>>> Ready to run your code...';

        // Clear feedback
        const feedbackPanel = document.getElementById('code-feedback-panel');
        if (feedbackPanel) feedbackPanel.classList.add('hidden');

        showToast('Custom Challenge!', `"${challenge.title}" - ${challenge.difficulty}`, 'success', 3000);
    }

    // Generate similar challenge based on current topic/difficulty
    function generateSimilarChallenge() {
        if (!currentChallenge) {
            showToast('Error', 'No current challenge', 'error');
            return;
        }

        // Find challenges with same category or difficulty
        const similarChallenges = codingChallenges.filter(c =>
            (c.category === currentChallenge.category || c.difficulty === currentChallenge.difficulty)
            && c.id !== currentChallenge.id
        );

        if (similarChallenges.length === 0) {
            showToast('Info', 'No more similar challenges. Try a different topic!', 'info');
            backToChallengesList();
            return;
        }

        // Pick a random similar challenge
        const nextChallenge = similarChallenges[Math.floor(Math.random() * similarChallenges.length)];

        // Show toast
        showToast('New Challenge!', `Loading: ${nextChallenge.title}`, 'success', 2000);

        // Start the new challenge
        startCodingChallenge(nextChallenge.id);
    }

    // Simulate basic Python code execution
    function simulatePython(code) {
        // Python built-in function helpers
        const pyLen = (x) => typeof x === 'string' ? x.length : (Array.isArray(x) ? x.length : 0);
        const pySum = (x) => Array.isArray(x) ? x.reduce((a, b) => a + b, 0) : 0;
        const pyMax = (x) => Array.isArray(x) ? Math.max(...x) : x;
        const pyMin = (x) => Array.isArray(x) ? Math.min(...x) : x;
        const pySorted = (x) => Array.isArray(x) ? JSON.stringify([...x].sort((a, b) => a - b)) : x;
        const pyReversed = (x) => typeof x === 'string' ? x.split('').reverse().join('') : (Array.isArray(x) ? [...x].reverse() : x);

        // Helper to evaluate Python-like expressions
        function evalPyExpr(expr, vars) {
            let result = expr;

            // Replace variables with their values
            for (let v in vars) {
                const val = vars[v];
                const replacement = typeof val === 'string' ? `"${val}"` : JSON.stringify(val);
                result = result.replace(new RegExp('\\b' + v + '\\b', 'g'), replacement);
            }

            // Handle len(x)
            result = result.replace(/len\s*\(\s*([^)]+)\s*\)/g, (match, arg) => {
                try {
                    const val = eval(arg);
                    return pyLen(val);
                } catch { return '0'; }
            });

            // Handle .upper()
            result = result.replace(/("[^"]*"|'[^']*'|\w+)\.upper\s*\(\s*\)/g, (match, arg) => {
                try {
                    const val = eval(arg);
                    return `"${String(val).toUpperCase()}"`;
                } catch { return match; }
            });

            // Handle .lower()
            result = result.replace(/("[^"]*"|'[^']*'|\w+)\.lower\s*\(\s*\)/g, (match, arg) => {
                try {
                    const val = eval(arg);
                    return `"${String(val).toLowerCase()}"`;
                } catch { return match; }
            });

            // Handle sum(x)
            result = result.replace(/sum\s*\(\s*([^)]+)\s*\)/g, (match, arg) => {
                try { return pySum(eval(arg)); } catch { return '0'; }
            });

            // Handle max(x)
            result = result.replace(/max\s*\(\s*([^)]+)\s*\)/g, (match, arg) => {
                try { return pyMax(eval(arg)); } catch { return '0'; }
            });

            // Handle min(x)
            result = result.replace(/min\s*\(\s*([^)]+)\s*\)/g, (match, arg) => {
                try { return pyMin(eval(arg)); } catch { return '0'; }
            });

            // Handle sorted(x)
            result = result.replace(/sorted\s*\(\s*([^)]+)\s*\)/g, (match, arg) => {
                try { return pySorted(eval(arg)); } catch { return '[]'; }
            });

            // Handle string slicing [::-1] for reverse
            result = result.replace(/("[^"]*"|'[^']*'|\w+)\s*\[\s*:\s*:\s*-1\s*\]/g, (match, arg) => {
                try {
                    const val = eval(arg);
                    return `"${pyReversed(val)}"`;
                } catch { return match; }
            });

            // Handle .count(char)
            result = result.replace(/("[^"]*"|'[^']*'|\w+)\.count\s*\(\s*("[^"]*"|'[^']*')\s*\)/g, (match, str, char) => {
                try {
                    const s = eval(str);
                    const c = eval(char);
                    return (s.split(c).length - 1);
                } catch { return '0'; }
            });

            return result;
        }

        const lines = code.split('\n');
        let outputs = [];
        let variables = {};

        for (let line of lines) {
            line = line.trim();

            // Skip comments and empty lines
            if (line.startsWith('#') || line === '') continue;

            // Variable assignment: x = 5
            const assignMatch = line.match(/^(\w+)\s*=\s*(.+)$/);
            if (assignMatch) {
                const varName = assignMatch[1];
                let value = assignMatch[2].trim();

                // Evaluate expression with Python functions
                try {
                    value = evalPyExpr(value, variables);
                    variables[varName] = eval(value);
                } catch {
                    // Store as string if eval fails
                    variables[varName] = value.replace(/^["']|["']$/g, '');
                }
                continue;
            }

            // Print statement: print(...)
            const printMatch = line.match(/^print\s*\(\s*(.+)\s*\)$/);
            if (printMatch) {
                let content = printMatch[1];

                // Evaluate with Python functions
                content = evalPyExpr(content, variables);

                // Handle f-strings
                content = content.replace(/f["'](.+?)["']/g, (match, str) => {
                    return '"' + str.replace(/\{(\w+)\}/g, (m, varName) => {
                        return variables[varName] !== undefined ? variables[varName] : m;
                    }) + '"';
                });

                try {
                    let result = eval(content);
                    outputs.push(String(result));
                } catch {
                    content = content.replace(/^["']|["']$/g, '');
                    outputs.push(content);
                }
                continue;
            }

            // For loop simulation (basic)
            const forMatch = line.match(/^for\s+(\w+)\s+in\s+(\w+)\s*:$/);
            if (forMatch) {
                const loopVar = forMatch[1];
                const listVar = forMatch[2];
                const list = variables[listVar];

                if (Array.isArray(list)) {
                    const nextLineIdx = lines.indexOf(line) + 1;
                    if (nextLineIdx < lines.length) {
                        const nextLine = lines[nextLineIdx].trim();
                        if (nextLine.match(/print\s*\(\s*(\w+)\s*\)/)) {
                            list.forEach(item => outputs.push(String(item)));
                        }
                    }
                }
                continue;
            }
        }

        return outputs.length > 0 ? outputs.join('\n') : 'No output';
    }

    // Clear console output
    function clearConsole() {
        const consoleOutput = document.getElementById('code-console-output');
        if (consoleOutput) {
            consoleOutput.textContent = '>>> Ready to run your code...';
        }
    }

    // Local code analysis helper (helps without giving exact answers)
    function analyzeCodeLocally(code, mode) {
        const lines = code.split('\n').filter(l => l.trim() && !l.trim().startsWith('#'));
        const tips = [];
        const challenge = currentChallenge;

        // Check for common issues
        if (!code.includes('print')) {
            tips.push('üí° <strong>Missing Output:</strong> Remember to use print() to display your result.');
        }

        if (code.includes('pass') && lines.length < 3) {
            tips.push('üí° <strong>Incomplete Code:</strong> Replace "pass" with your actual code logic.');
        }

        // Check if they're using the right approach based on challenge
        if (challenge) {
            if (challenge.expected && challenge.expected.includes('[') && !code.includes('[')) {
                tips.push('üí° <strong>Data Structure:</strong> This challenge expects a list. Consider using square brackets [].');
            }

            if (challenge.title.toLowerCase().includes('len') && !code.includes('len(')) {
                tips.push('üí° <strong>Hint:</strong> Think about which Python function gives you the size/length of something.');
            }

            if (challenge.title.toLowerCase().includes('reverse') && !code.includes('[::-1]') && !code.includes('reverse')) {
                tips.push('üí° <strong>Hint:</strong> Python has a simple way to reverse strings using slicing.');
            }

            if (challenge.title.toLowerCase().includes('upper') && !code.includes('.upper()')) {
                tips.push('üí° <strong>Hint:</strong> Strings have methods to change their case. Check string methods.');
            }

            if (challenge.title.toLowerCase().includes('sum') && !code.includes('sum(') && !code.includes('+')) {
                tips.push('üí° <strong>Hint:</strong> Python has a built-in function to add up list items.');
            }

            if (challenge.title.toLowerCase().includes('max') && !code.includes('max(')) {
                tips.push('üí° <strong>Hint:</strong> Python has a built-in function to find the largest value.');
            }

            if (challenge.title.toLowerCase().includes('loop') && !code.includes('for ')) {
                tips.push('üí° <strong>Hint:</strong> Use a "for" loop to iterate through items.');
            }

            if (challenge.title.toLowerCase().includes('function') && !code.includes('def ')) {
                tips.push('üí° <strong>Hint:</strong> Functions are defined using the "def" keyword.');
            }

            if (challenge.title.toLowerCase().includes('class') && !code.includes('class ')) {
                tips.push('üí° <strong>Hint:</strong> Classes are defined using the "class" keyword.');
            }
        }

        // General code quality tips
        if (lines.length > 0 && !code.match(/\w+\s*=/)) {
            tips.push('üí° <strong>Variables:</strong> Consider storing values in variables for clearer code.');
        }

        // Check indentation issues
        const indentLines = code.split('\n').filter(l => l.startsWith(' ') || l.startsWith('\t'));
        if (code.includes('def ') && indentLines.length === 0) {
            tips.push('‚ö†Ô∏è <strong>Indentation:</strong> Code inside functions needs to be indented.');
        }

        if (tips.length === 0) {
            tips.push('‚úÖ <strong>Code Structure:</strong> Your code structure looks good!');
            tips.push('üîç <strong>Check Output:</strong> Run your code and compare the output with the expected result.');
            if (challenge) {
                tips.push(`üìã <strong>Expected:</strong> The output should be: <code>${challenge.expected}</code>`);
            }
        }

        const title = mode === 'debug' ? 'üêõ DEBUG HELPER' : 'üîç CODE REVIEW';
        const color = mode === 'debug' ? 'text-orange-400' : 'text-blue-400';

        return `
            <div class="mb-2">
                <span class="${color} font-bold">${title}</span>
            </div>
            <div class="space-y-2 text-sm">
                ${tips.map(t => `<div class="text-gray-300">${t}</div>`).join('')}
            </div>
        `;
    }

    // Submit code to Code Review Agent (port 8003)
    async function submitCodeForReview() {
        const codeEditor = document.getElementById('code-editor');
        const feedbackPanel = document.getElementById('code-feedback-panel');
        const feedbackContent = document.getElementById('code-feedback-content');

        if (!codeEditor || !codeEditor.value.trim()) {
            showToast('Error', 'Please write some code first', 'error');
            return;
        }

        const code = codeEditor.value;

        // Show loading
        feedbackPanel.classList.remove('hidden');
        feedbackContent.innerHTML = '<div class="text-blue-400 animate-pulse">üîç Analyzing your code...</div>';

        try {
            const response = await fetch(getAgentURL(API_CONFIG.CODE_REVIEW_PORT || '8003', '/review'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query_id: `review-${Date.now()}`,
                    code: code,
                    language: 'python',
                    context: 'Student learning exercise'
                })
            });

            const data = await response.json();

            if (data.review || data.feedback) {
                const feedback = data.review || data.feedback;
                feedbackContent.innerHTML = `
                    <div class="mb-3">
                        <span class="text-blue-400 font-bold">üîç CODE REVIEW</span>
                    </div>
                    <div class="text-gray-300 whitespace-pre-wrap">${feedback}</div>
                    ${data.suggestions ? `
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <span class="text-yellow-400 font-bold">üí° Suggestions:</span>
                            <div class="text-gray-300 mt-1">${Array.isArray(data.suggestions) ? data.suggestions.join('<br>') : data.suggestions}</div>
                        </div>
                    ` : ''}
                `;
                showToast('Review Complete', 'Check the feedback panel below', 'success');
            } else {
                // Provide helpful local feedback
                const localReview = analyzeCodeLocally(code, 'review');
                feedbackContent.innerHTML = localReview;
            }
        } catch (err) {
            console.error('Code review error:', err);
            feedbackContent.innerHTML = `<div class="text-red-400">‚ùå Failed to connect to Code Review agent. Make sure it's running on port 8003.</div>`;
            showToast('Error', 'Code Review agent not available', 'error');
        }
    }

    // Submit code to Debug Agent (port 8004)
    async function submitCodeForDebug() {
        const codeEditor = document.getElementById('code-editor');
        const feedbackPanel = document.getElementById('code-feedback-panel');
        const feedbackContent = document.getElementById('code-feedback-content');

        if (!codeEditor || !codeEditor.value.trim()) {
            showToast('Error', 'Please write some code first', 'error');
            return;
        }

        const code = codeEditor.value;

        // Show loading
        feedbackPanel.classList.remove('hidden');
        feedbackContent.innerHTML = '<div class="text-orange-400 animate-pulse">üêõ Analyzing your code...</div>';

        // First do local analysis for immediate feedback
        const localAnalysis = analyzeCodeForDebugging(code);

        try {
            const response = await fetch(getAgentURL(API_CONFIG.DEBUG_PORT || '8004', '/diagnose'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query_id: `debug-${Date.now()}`,
                    student_id: 'student-debug',
                    code_snippet: code,
                    error_message: localAnalysis.issues.length > 0 ? localAnalysis.issues.join('; ') : 'Student needs debugging help',
                    language: 'python'
                })
            });

            const data = await response.json();
            console.log('[Debug Agent] Response:', data);

            // Handle Debug Agent response (root_cause, explanation, diagnostic_steps)
            if (data.root_cause || data.explanation || data.diagnostic_steps) {
                let stepsHtml = '';
                if (data.diagnostic_steps && data.diagnostic_steps.length > 0) {
                    stepsHtml = '<div class="mt-3"><strong class="text-yellow-400">Steps to Debug:</strong><ol class="list-decimal list-inside mt-1 text-gray-300 text-xs space-y-1">';
                    data.diagnostic_steps.forEach(step => {
                        stepsHtml += `<li>${step.description || step}</li>`;
                    });
                    stepsHtml += '</ol></div>';
                }

                feedbackContent.innerHTML = `
                    <div class="mb-3"><span class="text-orange-400 font-bold">üêõ DEBUG ANALYSIS</span></div>
                    ${data.root_cause ? `<div class="text-red-400 mb-2"><strong>Issue:</strong> ${data.root_cause}</div>` : ''}
                    ${data.explanation ? `<div class="text-gray-300 mb-2"><strong>Explanation:</strong> ${data.explanation}</div>` : ''}
                    ${stepsHtml}
                    ${data.suggested_fix ? `<div class="mt-3 pt-3 border-t border-gray-700"><span class="text-yellow-400 font-bold">üí° Hint:</span><div class="text-gray-300 text-xs mt-1">${data.suggested_fix}</div></div>` : ''}
                `;
                showToast('Debug Complete', 'Check the hints below', 'success');
            } else {
                // Use local analysis as fallback
                feedbackContent.innerHTML = localAnalysis.html;
                showToast('Analysis Complete', 'Check the hints below', 'info');
            }
        } catch (err) {
            console.error('Debug error:', err);
            // Use local analysis when agent is unavailable
            feedbackContent.innerHTML = localAnalysis.html;
            showToast('Local Analysis', 'Check the debugging hints', 'info');
        }
    }

    // Local code analysis for debugging hints (guides without giving exact answers)
    function analyzeCodeForDebugging(code) {
        const issues = [];
        const hints = [];
        const lines = code.split('\n');

        // Check for common Python issues
        if (!code.includes('print')) {
            hints.push('üí° <strong>Tip:</strong> Use <code>print()</code> to see what your code produces');
        }

        // Check for incomplete code
        if (code.trim().endsWith(':')) {
            issues.push('Code block appears incomplete');
            hints.push('üîç <strong>Check:</strong> You started a block (if/for/def) but it needs code inside');
        }

        // Check for missing colons
        const blockKeywords = ['if ', 'for ', 'while ', 'def ', 'class ', 'elif ', 'else'];
        lines.forEach((line, idx) => {
            const trimmed = line.trim();
            blockKeywords.forEach(kw => {
                if (trimmed.startsWith(kw) && !trimmed.endsWith(':') && !trimmed.includes('#')) {
                    hints.push(`üîç <strong>Line ${idx + 1}:</strong> ${kw.trim()} statements need a colon at the end`);
                }
            });
        });

        // Check for = vs == confusion
        lines.forEach((line, idx) => {
            const trimmed = line.trim();
            if (trimmed.startsWith('if ') && trimmed.includes('=') && !trimmed.includes('==') && !trimmed.includes('!=') && !trimmed.includes('<=') && !trimmed.includes('>=')) {
                hints.push(`üîç <strong>Line ${idx + 1}:</strong> For comparison, use <code>==</code> not <code>=</code>`);
            }
        });

        // Check for string method calls
        if (code.includes('.upper') && !code.includes('.upper()')) {
            hints.push('üí° <strong>Tip:</strong> String methods need parentheses: <code>.upper()</code>');
        }
        if (code.includes('.lower') && !code.includes('.lower()')) {
            hints.push('üí° <strong>Tip:</strong> String methods need parentheses: <code>.lower()</code>');
        }
        if (code.includes('len') && !code.includes('len(')) {
            hints.push('üí° <strong>Tip:</strong> <code>len</code> is a function: use <code>len(variable)</code>');
        }

        // Check for range usage
        if (code.includes('range') && code.includes('for')) {
            hints.push('üí° <strong>Remember:</strong> <code>range(5)</code> gives 0,1,2,3,4 (not including 5)');
        }

        // Build response HTML
        let html = '<div class="mb-3"><span class="text-orange-400 font-bold">üêõ CODE ANALYSIS</span></div>';

        if (issues.length > 0) {
            html += '<div class="text-red-400 mb-2"><strong>Issues Found:</strong></div>';
            html += '<ul class="list-disc list-inside text-xs text-gray-300 mb-3">';
            issues.forEach(issue => { html += `<li>${issue}</li>`; });
            html += '</ul>';
        }

        if (hints.length > 0) {
            html += '<div class="text-yellow-400 mb-2"><strong>Debugging Hints:</strong></div>';
            html += '<div class="space-y-2 text-xs">';
            hints.forEach(hint => { html += `<div class="bg-gray-800/50 p-2 rounded">${hint}</div>`; });
            html += '</div>';
        }

        if (issues.length === 0 && hints.length === 0) {
            html += `
                <div class="text-gray-300 mb-2">Your code syntax looks okay! Debugging tips:</div>
                <div class="space-y-2 text-xs">
                    <div class="bg-gray-800/50 p-2 rounded">üí° <strong>Add print statements</strong> to see variable values</div>
                    <div class="bg-gray-800/50 p-2 rounded">üí° <strong>Check your logic:</strong> Does each step do what you expect?</div>
                    <div class="bg-gray-800/50 p-2 rounded">üí° <strong>Test with simple input:</strong> Try easy test cases first</div>
                    <div class="bg-gray-800/50 p-2 rounded">üí° <strong>Read error messages:</strong> They tell you the line number</div>
                </div>
            `;
        }

        return { issues, hints, html };
    }

    // Load topics into center panel grid
    function loadTopicsInCenter() {
        const topicsList = document.getElementById('center-topics-list');
        if (!topicsList) return;

        // MUST match backend curriculum topics (5 topics, each worth 20% max mastery)
        const topics = [
            {id: 'python-basics', name: 'Python Basics', icon: 'üêç', color: 'from-blue-600 to-blue-800', level: 1},
            {id: 'variables-and-data-types', name: 'Variables & Data Types', icon: 'üìä', color: 'from-purple-600 to-purple-800', level: 2},
            {id: 'control-flow', name: 'Control Flow (if/else/loops)', icon: 'üîÑ', color: 'from-yellow-600 to-yellow-800', level: 3},
            {id: 'functions', name: 'Functions', icon: '‚ö°', color: 'from-green-600 to-green-800', level: 4},
            {id: 'data-structures', name: 'Data Structures (Lists/Dicts)', icon: 'üóÑÔ∏è', color: 'from-cyan-600 to-cyan-800', level: 5}
        ];

        topicsList.innerHTML = topics.map(topic => `
            <button onclick="startPractice('${topic.id}', '${topic.name}')"
                    class="bg-gradient-to-br ${topic.color} p-4 rounded-lg hover:scale-105 transition transform text-left shadow-lg">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-3xl">${topic.icon}</span>
                    <span class="text-white/80 text-xs font-bold bg-black/30 px-2 py-1 rounded">LVL ${topic.level}</span>
                </div>
                <div class="text-white font-bold text-sm">${topic.name}</div>
                <div class="text-white/60 text-xs mt-1">3 MCQs ‚Üí +20% mastery</div>
            </button>
        `).join('');

        // Setup search
        const searchInput = document.getElementById('center-topic-search');
        if (searchInput) {
            searchInput.oninput = function() {
                const query = this.value.toLowerCase();
                const buttons = topicsList.querySelectorAll('button');
                buttons.forEach(btn => {
                    const name = btn.querySelector('.font-bold').textContent.toLowerCase();
                    btn.style.display = name.includes(query) ? 'block' : 'none';
                });
            };
        }
    }

    async function startPractice(topicId, topicName) {
        console.log('startPractice called:', topicId, topicName);
        const userStr = localStorage.getItem('learnflow_user');
        const user = userStr ? JSON.parse(userStr) : { studentId: 'demo-student-001' };

        // Use CENTER PANEL for practice (more space)
        const overviewView = document.getElementById('student-overview-view');
        const topicsView = document.getElementById('student-topics-view');
        const practiceView = document.getElementById('student-practice-view');

        // Hide topics view first
        if (topicsView) {
            topicsView.classList.add('hidden');
            topicsView.style.display = 'none';
        }
        const titleEl = document.getElementById('center-practice-topic');
        const subtitleEl = document.getElementById('center-practice-subtitle');
        const questionsContainer = document.getElementById('center-practice-questions');

        if (!practiceView || !questionsContainer) {
            console.error('Center practice elements not found');
            return;
        }

        // Hide overview, show practice view in CENTER
        if (overviewView) overviewView.classList.add('hidden');
        practiceView.classList.remove('hidden');
        practiceView.style.display = 'flex';

        if (titleEl) titleEl.textContent = `PRACTICE: ${topicName.toUpperCase()}`;
        if (subtitleEl) subtitleEl.textContent = 'Answer all questions below. Select one option per question.';

        const mcqs = generateMCQs(topicId, topicName);
        currentPracticeSession = {topicId, topicName, questions: mcqs, answers: {}};

        // Render questions in CENTER panel with better sizing
        questionsContainer.innerHTML = '';
        mcqs.forEach((mcq, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'p-4 bg-gray-900/50 border border-teal-900/30 rounded';
            let optionsHTML = '';
            mcq.options.forEach((option, optionIndex) => {
                optionsHTML += `
                    <label class="flex items-start gap-3 mb-2 p-2 cursor-pointer hover:bg-teal-900/20 rounded transition">
                        <input type="radio" name="center-question-${index}" value="${optionIndex}" class="mt-1 text-teal-500">
                        <span class="text-sm text-white">${String.fromCharCode(65 + optionIndex)}. ${option}</span>
                    </label>
                `;
            });
            questionDiv.innerHTML = `
                <div class="text-teal-400 font-bold text-sm mb-3">Question ${index + 1}:</div>
                <div class="text-white text-sm mb-4 leading-relaxed">${mcq.question}</div>
                <div class="ml-2">${optionsHTML}</div>
            `;
            questionsContainer.appendChild(questionDiv);
        });
    }

    async function submitAnswers() {
        if (!currentPracticeSession) {
            showToast('Error', 'No active practice session', 'error');
            return;
        }
        const userStr = localStorage.getItem('learnflow_user');
        const user = userStr ? JSON.parse(userStr) : { studentId: 'demo-student-001' };

        let correctCount = 0;
        const totalQuestions = currentPracticeSession.questions.length;

        // Check center panel radio buttons (center-question-X)
        for (let i = 0; i < totalQuestions; i++) {
            const selected = document.querySelector(`input[name="center-question-${i}"]:checked`);
            if (selected && parseInt(selected.value) === currentPracticeSession.questions[i].correct) {
                correctCount++;
            }
        }

        const score = Math.round((correctCount / totalQuestions) * 100);
        const passed = correctCount >= (totalQuestions / 2);

        try {
            // Send score directly to backend
            await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${user.studentId}`), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: user.studentId,
                    topic: currentPracticeSession.topicId,
                    interaction_type: 'success',
                    success: true,
                    score: score
                })
            });

            showToast('Practice Complete!', `Score: ${correctCount}/${totalQuestions} (${score}%) - Your mastery has been updated!`, 'success', 5000);

            // Close center practice view and show overview
            closeCenterPractice();
            await fetchMasteryData();
        } catch (error) {
            showToast('Error', 'Failed to update mastery: ' + error.message, 'error');
        }
    }

    async function teacherGeneratePractice() {
        console.log('teacherGeneratePractice called');
        const topic = document.getElementById('practice-topic');
        const difficulty = document.getElementById('practice-difficulty');
        const count = document.getElementById('practice-count');
        const consoleContent = document.getElementById('console-content');

        if (!topic || !difficulty || !count || !consoleContent) {
            showToast('Error', 'Form elements not found', 'error');
            return;
        }

        const topicValue = topic.value;
        const difficultyValue = difficulty.value;
        const countValue = parseInt(count.value);

        consoleContent.innerHTML = '<div class="text-yellow-400 text-[9px]">[GENERATING] Creating practice test...</div>';

        const mcqs = generateMCQs(topicValue, topicValue.replace(/-/g, ' '));
        generatedTest = {topic: topicValue, difficulty: difficultyValue, questions: mcqs.slice(0, countValue)};

        consoleContent.innerHTML = '';
        const header = document.createElement('div');
        header.className = 'text-cyan-400 font-bold text-[9px] mb-2';
        header.textContent = `‚úÖ GENERATED TEST: ${topicValue.toUpperCase()}`;
        consoleContent.appendChild(header);

        generatedTest.questions.forEach((q, index) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'mb-2 pb-2 border-b border-gray-800 text-[8px]';
            qDiv.innerHTML = `
                <div class="text-green-400 font-bold">Q${index + 1}: ${q.question}</div>
                ${q.options.map((opt, i) => `<div class="text-gray-400 ml-2">${String.fromCharCode(65 + i)}. ${opt}</div>`).join('')}
                <div class="text-yellow-400 text-[7px] mt-1">Correct: ${String.fromCharCode(65 + q.correct)}</div>
            `;
            consoleContent.appendChild(qDiv);
        });

        await loadStudentsForAssignment();

        const readyMsg = document.createElement('div');
        readyMsg.className = 'text-green-400 text-[8px] mt-2 font-bold border border-green-900 p-2';
        readyMsg.textContent = '‚úì Ready to assign! Select students below.';
        consoleContent.appendChild(readyMsg);
    }

    // Load students into assignment lists (MCQ and Coding separate)
    async function loadStudentsForAssignment() {
        console.log('[loadStudentsForAssignment] Starting...');
        try {
            const response = await fetch('/api/auth/students');
            const data = await response.json();
            console.log('[loadStudentsForAssignment] API response:', data);

            if (!data.success || !data.students) {
                console.log('[loadStudentsForAssignment] No students data');
                return;
            }

            // Build HTML for student checkboxes
            let mcqHtml = '';
            let codeHtml = '';

            data.students.forEach(student => {
                mcqHtml += `
                    <div class="mb-1 text-white">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-teal-400 transition">
                            <input type="checkbox" class="assign-checkbox" value="${student.studentId}" data-name="${student.name}">
                            <span class="text-[9px]">${student.name}</span>
                        </label>
                    </div>
                `;
                codeHtml += `
                    <div class="mb-1 text-white">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-purple-400 transition">
                            <input type="checkbox" class="code-assign-checkbox" value="${student.studentId}" data-name="${student.name}">
                            <span class="text-[9px]">${student.name}</span>
                        </label>
                    </div>
                `;
            });

            if (data.students.length === 0) {
                mcqHtml = '<div class="text-gray-500">No students registered</div>';
                codeHtml = '<div class="text-gray-500">No students registered</div>';
            }

            // Store HTML globally for retry
            window._studentMcqHtml = mcqHtml;
            window._studentCodeHtml = codeHtml;

            // Populate both lists immediately
            const mcqList = document.getElementById('assign-student-list');
            const codeList = document.getElementById('code-assign-student-list');

            console.log('[loadStudentsForAssignment] MCQ list:', mcqList ? 'FOUND' : 'NOT FOUND');
            console.log('[loadStudentsForAssignment] Code list:', codeList ? 'FOUND' : 'NOT FOUND');

            if (mcqList) mcqList.innerHTML = mcqHtml;
            if (codeList) codeList.innerHTML = codeHtml;

            // Retry both after delay if not found
            if (!mcqList || !codeList) {
                setTimeout(() => {
                    const retryMcq = document.getElementById('assign-student-list');
                    const retryCode = document.getElementById('code-assign-student-list');
                    if (retryMcq && !retryMcq.innerHTML.includes('checkbox')) {
                        retryMcq.innerHTML = window._studentMcqHtml;
                        console.log('[loadStudentsForAssignment] MCQ populated on retry');
                    }
                    if (retryCode && !retryCode.innerHTML.includes('checkbox')) {
                        retryCode.innerHTML = window._studentCodeHtml;
                        console.log('[loadStudentsForAssignment] Code populated on retry');
                    }
                }, 300);
            }

        } catch (error) {
            console.error('Failed to load students:', error);
        }
    }

    async function assignPracticeToSelected() {
        if (!generatedTest) {
            showToast('Error', 'Please generate a practice test first', 'error');
            return;
        }
        const checkboxes = document.querySelectorAll('.assign-checkbox:checked');
        if (checkboxes.length === 0) {
            showToast('Error', 'Please select at least one student', 'error');
            return;
        }

        const userStr = localStorage.getItem('learnflow_user');
        const teacher = userStr ? JSON.parse(userStr) : { name: 'Teacher' };
        const consoleContent = document.getElementById('console-content');
        const assigned = [];
        let successCount = 0;

        // Create assignments in database via API
        for (const cb of checkboxes) {
            try {
                const response = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        teacherId: teacher.teacherId || teacher.id,
                        studentId: cb.value,
                        studentName: cb.dataset.name,
                        topic: generatedTest.topic,
                        level: generatedTest.difficulty,
                        questions: generatedTest.questions
                    })
                });
                const data = await response.json();
                if (data.success) {
                    assigned.push(cb.dataset.name);
                    successCount++;
                } else {
                    console.error('Failed to assign to', cb.dataset.name, data.error);
                }
            } catch (err) {
                console.error('API error assigning to', cb.dataset.name, err);
            }
        }

        if (successCount > 0) {
            const successMsg = document.createElement('div');
            successMsg.className = 'text-green-400 font-bold text-[9px] mt-3 p-2 border border-green-900';
            successMsg.innerHTML = `
                <div>‚úÖ Test Assigned Successfully!</div>
                <div class="text-white font-normal mt-1">Assigned to: ${assigned.join(', ')}</div>
                <div class="text-[7px] text-gray-400 mt-1">Students will see notification and task when they login</div>
            `;
            consoleContent.appendChild(successMsg);
            showToast('Test Assigned', `Assigned to: ${assigned.join(', ')}`, 'success', 5000);
        } else {
            showToast('Error', 'Failed to assign test. Check console for errors.', 'error');
        }
    }

    async function autoAssignPractice() {
        console.log('autoAssignPractice called');
        const studentsResponse = await fetch('/api/auth/students');
        const studentsData = await studentsResponse.json();
        if (!studentsData.success) return;

        const strugglingStudents = [];
        for (const student of studentsData.students) {
            try {
                const masteryResponse = await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${student.studentId}`));
                const masteryData = await masteryResponse.json();
                if (masteryData.overall_mastery < 0.4) {
                    strugglingStudents.push(student);
                }
            } catch (err) {
                console.error('Error checking student:', err);
            }
        }

        if (strugglingStudents.length === 0) {
            showToast('Info', 'No struggling students found!', 'info');
            return;
        }

        const topic = 'python-basics';
        const mcqs = generateMCQs(topic, 'Python Basics');
        const test = {topic, difficulty: 'easy', questions: mcqs};

        const userStr = localStorage.getItem('learnflow_user');
        const teacher = userStr ? JSON.parse(userStr) : { name: 'Teacher' };
        const assigned = [];

        // Create assignments in database via API
        for (const student of strugglingStudents) {
            try {
                const response = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        teacherId: teacher.teacherId || teacher.id,
                        studentId: student.studentId,
                        studentName: student.name,
                        topic: topic,
                        level: 'easy',
                        questions: mcqs
                    })
                });
                const data = await response.json();
                if (data.success) {
                    assigned.push(student.name);
                }
            } catch (err) {
                console.error('Error assigning to', student.name, err);
            }
        }

        const names = assigned.join(', ');
        if (assigned.length > 0) {
            showToast('Auto-Assigned', `Practice assigned to: ${names}`, 'success', 5000);
        } else {
            showToast('Error', 'Failed to auto-assign practice. Check console.', 'error');
        }

        const consoleContent = document.getElementById('console-content');
        consoleContent.innerHTML = `
            <div class="text-green-400 font-bold text-[9px] p-2 border border-green-900">
                ‚úÖ Auto-Assigned Practice
                <div class="text-white font-normal mt-2">Assigned to: ${names}</div>
                <div class="text-[7px] text-gray-400 mt-1">Topic: Python Basics (Easy)</div>
            </div>
        `;
    }

    function checkAssignedTests() {
        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) return;
        const user = JSON.parse(userStr);
        if (user.role !== 'student') return;

        const assignedTestsStr = localStorage.getItem('learnflow_assigned_tests');
        if (!assignedTestsStr) return;

        const tests = JSON.parse(assignedTestsStr);
        const myTests = tests.filter(t => t.studentId === user.studentId && !t.completed);

        if (myTests.length > 0) {
            setTimeout(() => {
                const count = myTests.length;
                showToast('New Assignments', `You have ${count} new assignment${count > 1 ? 's' : ''}!`, 'info', 5000);
            }, 2000);
        }
    }

    // ============ ASSIGN CODING CHALLENGE ============
    async function assignCodingChallenge() {
        const challengeSelect = document.getElementById('coding-challenge-select');
        const challengeId = challengeSelect ? challengeSelect.value : '';

        if (!challengeId) {
            showToast('Error', 'Please select a coding challenge', 'error');
            return;
        }

        // Get selected students from CODING student list (separate from MCQ)
        const checkboxes = document.querySelectorAll('.code-assign-checkbox:checked');
        if (checkboxes.length === 0) {
            showToast('Error', 'Please select at least one student for coding task', 'error');
            return;
        }

        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) {
            showToast('Error', 'Not logged in', 'error');
            return;
        }
        const teacher = JSON.parse(userStr);

        // Find the challenge details
        const challenge = codingChallenges.find(c => c.id === challengeId);
        if (!challenge) {
            showToast('Error', 'Challenge not found', 'error');
            return;
        }

        const assigned = [];
        const consoleContent = document.getElementById('console-content');

        for (const checkbox of checkboxes) {
            // checkbox.value contains studentId, data-name contains student name
            const studentId = checkbox.value || checkbox.dataset.studentId;
            const studentName = checkbox.dataset.name || checkbox.dataset.studentName || 'Student';

            try {
                console.log('[Coding Assignment] Assigning to:', studentId, studentName);

                // Create assignment in database (API also creates notification automatically)
                const assignResponse = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: studentId,
                        studentName: studentName,
                        teacherId: teacher.teacherId || teacher.id,
                        topic: challenge.title,
                        type: 'coding',
                        difficulty: challenge.difficulty.toLowerCase(),
                        questions: [{
                            id: challenge.id,
                            type: 'coding',
                            title: challenge.title,
                            description: challenge.description,
                            expected: challenge.expected,
                            hint: challenge.hint,
                            starterCode: challenge.starterCode
                        }]
                    })
                });

                const data = await assignResponse.json();
                console.log('[Coding Assignment] Response:', data);

                if (data.success) {
                    assigned.push(studentName);
                } else {
                    console.error('[Coding Assignment] Failed:', data.error);
                }
            } catch (err) {
                console.error('Error assigning to student:', err);
            }
        }

        if (assigned.length > 0) {
            // Show success in console
            if (consoleContent) {
                const successMsg = document.createElement('div');
                successMsg.className = 'text-purple-400 text-xs my-2 p-2 border border-purple-900 rounded';
                successMsg.innerHTML = `
                    <div>üíª Coding Challenge Assigned!</div>
                    <div class="text-white font-normal mt-1">Challenge: ${challenge.title}</div>
                    <div class="text-white font-normal">Assigned to: ${assigned.join(', ')}</div>
                    <div class="text-[7px] text-gray-400 mt-1">Students will receive notification instantly</div>
                `;
                consoleContent.appendChild(successMsg);
            }
            showToast('Code Task Assigned!', `"${challenge.title}" sent to ${assigned.join(', ')}`, 'success', 5000);

            // Clear selection
            challengeSelect.value = '';
            checkboxes.forEach(cb => cb.checked = false);
        } else {
            showToast('Error', 'Failed to assign coding challenge', 'error');
        }
    }

    // Initialize auth form and chat
    window.addEventListener('DOMContentLoaded', () => {
        // Add enter key support to all input fields
        ['authName', 'authEmail', 'authPassword'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        startHandshake();
                    }
                });
            }
        });

        // Add enter key support to agent chat
        const agentInput = document.getElementById('agent-input');
        if (agentInput) {
            agentInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendToAgent(agentInput.value);
                }
            });
        }

        // Set initial state (register mode)
        toggleAuthMode(); // Call once to set to register mode

        // Check for assigned tests on student login
        checkAssignedTests();

        // Load notifications on dashboard load
        loadNotifications();
    });

    // ============ NOTIFICATION SYSTEM ============
    let notificationsData = [];
    let notificationsInitialized = false;
    let seenNotificationIds = new Set();  // Track notification IDs we've already processed
    // NOTE: currentSessionUser is declared at top of script (line ~812)

    async function loadNotifications() {
        // CRITICAL: Use cached session user, NOT localStorage
        // This prevents cross-tab pollution when different users login in different tabs
        if (!currentSessionUser) {
            const userStr = localStorage.getItem('learnflow_user');
            if (!userStr) return;
            currentSessionUser = JSON.parse(userStr);
            console.log('[Session] Cached user for this tab:', currentSessionUser.role, currentSessionUser.email);
        }
        const user = currentSessionUser;

        // Use role-based ID selection
        const notifyId = user.role === 'teacher' ? user.teacherId : user.studentId;

        // CRITICAL DEBUG: Log exact user and notifyId being used
        console.log('[Notifications] ====== FETCH DEBUG ======');
        console.log('[Notifications] User role:', user.role);
        console.log('[Notifications] User teacherId:', user.teacherId);
        console.log('[Notifications] User studentId:', user.studentId);
        console.log('[Notifications] Using notifyId:', notifyId);

        if (!notifyId) {
            console.log('[Notifications] ERROR: No notifyId found for user:', user);
            return;
        }

        // Don't load notifications if not on dashboard
        const dashboardPage = document.getElementById('dashboard');
        if (!dashboardPage || !dashboardPage.classList.contains('active')) {
            return;
        }

        try {
            const res = await fetch(`/api/notifications/${notifyId}`);
            const data = await res.json();

            console.log('[Notifications] API Response - count:', data.notifications?.length, 'unread:', data.unreadCount);
            if (data.notifications?.length > 0) {
                console.log('[Notifications] First notification:', data.notifications[0]);
            }

            if (data.success) {
                // CRITICAL: Client-side role filtering as additional safeguard
                // This ensures wrong role notifications NEVER display even if API returns them
                const allowedTypes = user.role === 'teacher'
                    ? ['completion', 'confirmation', 'registration']
                    : ['assignment', 'reminder', 'appreciation', 'encouragement', 'achievement'];

                const filteredNotifications = data.notifications.filter(n => allowedTypes.includes(n.type));
                console.log(`[Notifications] Role=${user.role}, Filtered ${data.notifications.length} -> ${filteredNotifications.length}`);

                notificationsData = filteredNotifications;
                const filteredUnread = filteredNotifications.filter(n => !n.read).length;
                updateNotificationBadge(filteredUnread);

                // FIRST LOAD: Just mark all existing notifications as "seen" - NO POPUPS
                // This prevents all old notifications from showing as popups on login
                if (!notificationsInitialized) {
                    console.log(`[Notifications] First load - marking ${filteredNotifications.length} ${user.role} notifications as seen (no popups)`);
                    filteredNotifications.forEach(n => seenNotificationIds.add(n.id));
                    notificationsInitialized = true;

                    // Just show badge count, no popups
                    if (filteredUnread > 0) {
                        console.log(`[Notifications] ${filteredUnread} unread - check bell icon`);
                    }
                    return;
                }

                // SUBSEQUENT LOADS: Only show popups for TRULY NEW notifications
                // (notifications that arrived AFTER we logged in AND match our role)
                const newNotifications = filteredNotifications.filter(n =>
                    !n.read && !seenNotificationIds.has(n.id)
                );

                if (newNotifications.length > 0) {
                    console.log(`[Notifications] üîî NEW ${user.role} notification arrived:`, newNotifications.map(n => ({ type: n.type, title: n.title })));

                    // Mark as seen immediately
                    newNotifications.forEach(n => seenNotificationIds.add(n.id));

                    // Show popup for each NEW notification - INSTANT like Facebook
                    newNotifications.forEach((n, i) => {
                        setTimeout(() => {
                            // Different toast styles for different notification types
                            const isAssignment = n.type === 'assignment';
                            const isEncouragement = n.type === 'encouragement' || n.type === 'appreciation';
                            const toastType = isAssignment ? 'info' : isEncouragement ? 'success' : 'success';
                            showToast('üîî ' + n.title, n.message, toastType, 8000);
                        }, i * 500);
                    });

                    // For students: also refresh assignments list to show new tasks immediately
                    if (user.role === 'student') {
                        loadStudentAssignments();
                    }
                }
            }
        } catch (err) {
            console.error('Load notifications error:', err);
        }
    }

    // ============ NOTIFICATION POLLING ============
    let notificationPollInterval = null;

    function startNotificationPolling() {
        // Stop any existing polling
        stopNotificationPolling();

        // Poll every 3 seconds for near real-time notifications
        notificationPollInterval = setInterval(async () => {
            try {
                await loadNotifications();

                // CRITICAL: Use cached session user - NOT localStorage
                const user = currentSessionUser;
                if (user) {
                    if (user.role === 'teacher') {
                        // For teachers: only refresh stats (not full dashboard to avoid resetting view)
                        await loadTeacherStats();
                        // Also ensure no student panel exists
                        const studentPanel = document.getElementById('student-assignments-panel');
                        if (studentPanel) studentPanel.remove();
                    } else if (user.role === 'student') {
                        // For students: refresh assignments list to see new tasks
                        await loadStudentAssignments();
                    }
                }
            } catch (err) {
                console.error('Polling error:', err);
            }
        }, 1000);  // 1 second for INSTANT notification delivery like Facebook

        console.log('Notification polling started (3s interval)');
    }

    function stopNotificationPolling() {
        if (notificationPollInterval) {
            clearInterval(notificationPollInterval);
            notificationPollInterval = null;
            console.log('Notification polling stopped');
        }
    }

    function updateNotificationBadge(count) {
        const badge = document.getElementById('notification-badge');
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }
    }

    function toggleNotifications() {
        const panel = document.getElementById('notification-panel');
        if (panel) {
            panel.classList.toggle('hidden');

            // Show current user ID for debugging - use cached session user
            const user = currentSessionUser;
            const userIdDisplay = document.getElementById('notification-user-id');
            if (userIdDisplay && user) {
                const notifyId = user.role === 'teacher' ? user.teacherId : user.studentId;
                userIdDisplay.textContent = `üì° ${user.role.toUpperCase()}: ${notifyId}`;
                userIdDisplay.style.color = user.role === 'teacher' ? '#00ff9f' : '#00d4ff';
            }

            renderNotifications();
        }
    }

    function renderNotifications() {
        const list = document.getElementById('notification-list');
        if (!list) return;

        // CRITICAL: Final safeguard - filter by role before rendering
        const user = currentSessionUser;
        if (!user) {
            list.innerHTML = '<div class="p-4 text-xs text-gray-500">Not logged in</div>';
            return;
        }

        const allowedTypes = user.role === 'teacher'
            ? ['completion', 'confirmation', 'registration']
            : ['assignment', 'reminder', 'appreciation', 'encouragement', 'achievement'];

        const roleFilteredData = notificationsData.filter(n => allowedTypes.includes(n.type));
        console.log(`[RenderNotifs] Role=${user.role}, showing ${roleFilteredData.length}/${notificationsData.length} notifications`);

        if (roleFilteredData.length === 0) {
            list.innerHTML = '<div class="p-4 text-xs text-gray-500">No notifications</div>';
            return;
        }

        list.innerHTML = roleFilteredData.map(n => `
            <div class="p-3 border-b border-gray-800 ${n.read ? 'opacity-60' : ''} hover:bg-teal-900/10 cursor-pointer" onclick="handleNotificationClick('${n.id}', '${n.type}', '${n.metadata || ''}')">
                <div class="text-xs font-bold text-teal-400">${n.title}</div>
                <div class="text-[10px] text-white mt-1">${n.message}</div>
                <div class="text-[8px] text-gray-500 mt-1">${new Date(n.createdAt).toLocaleString()}</div>
            </div>
        `).join('');
    }

    async function handleNotificationClick(notificationId, type, metadata) {
        // Mark as read - use cached session user
        const user = currentSessionUser;
        if (!user) return;

        try {
            const notifyId = user.role === 'teacher' ? user.teacherId : user.studentId;
            await fetch(`/api/notifications/${notifyId}/mark-read`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notificationId })
            });

            // If assignment notification, load assignments
            if (type === 'assignment') {
                loadStudentAssignments();
            }

            // Reload notifications
            loadNotifications();
        } catch (err) {
            console.error('Mark notification read error:', err);
        }
    }

    // ============ ASSIGNMENT SYSTEM ============
    async function loadStudentAssignments() {
        console.log('loadStudentAssignments called');
        // CRITICAL: Use cached session user to prevent cross-tab pollution
        if (!currentSessionUser) {
            const userStr = localStorage.getItem('learnflow_user');
            if (!userStr) {
                console.log('No user found');
                return;
            }
            currentSessionUser = JSON.parse(userStr);
        }
        const user = currentSessionUser;
        console.log('User:', user.role, user.studentId);
        // STRICT: Only students can load assignments
        if (user.role !== 'student') {
            console.log('[BLOCKED] Teacher cannot load student assignments panel');
            return;
        }

        try {
            console.log('Fetching assignments for:', user.studentId);
            const res = await fetch(`/api/assignments/student/${user.studentId}`);
            const data = await res.json();
            console.log('Assignments response:', data);
            if (data.success && data.assignments) {
                displayStudentAssignments(data.assignments);
            }
        } catch (err) {
            console.error('Load assignments error:', err);
        }
    }

    // Store assignments globally for state management
    let studentAssignments = [];
    let activeAssignmentId = null;

    function displayStudentAssignments(assignments) {
        // CRITICAL: Use cached session user - teachers should NEVER see this panel
        if (currentSessionUser && currentSessionUser.role === 'teacher') {
            console.log('[BLOCKED] Skipping student assignments panel for teacher');
            // Also remove if it somehow exists
            const existingPanel = document.getElementById('student-assignments-panel');
            if (existingPanel) existingPanel.remove();
            return;
        }

        studentAssignments = assignments; // Store for state management

        // Find or create assignments panel
        let panel = document.getElementById('student-assignments-panel');
        if (!panel) {
            const container = document.getElementById('studentAgentPanel');
            if (container) {
                container.insertAdjacentHTML('afterend', `
                    <div id="student-assignments-panel" class="glass-card p-4">
                        <h3 class="text-xs font-bold mb-4 tracking-widest border-b border-teal-900 pb-2">YOUR_ASSIGNMENTS</h3>
                        <div id="assignments-list" class="space-y-2"></div>
                        <div id="completed-assignments-section" class="mt-4 hidden">
                            <h4 class="text-[10px] font-bold mb-2 tracking-widest text-gray-500 border-t border-gray-800 pt-2">COMPLETED</h4>
                            <div id="completed-assignments-list" class="space-y-2"></div>
                        </div>
                    </div>
                `);
                panel = document.getElementById('student-assignments-panel');
            }
        }

        const list = document.getElementById('assignments-list');
        const completedSection = document.getElementById('completed-assignments-section');
        const completedList = document.getElementById('completed-assignments-list');
        if (!list) return;

        const pending = assignments.filter(a => !a.completed);
        const completed = assignments.filter(a => a.completed);

        // Render pending assignments (both MCQ and Coding)
        if (pending.length === 0) {
            list.innerHTML = '<div class="text-xs text-gray-500">No pending assignments</div>';
        } else {
            list.innerHTML = pending.map(a => {
                const isCoding = a.type === 'coding';
                const bgColor = isCoding ? 'border-purple-900/50 bg-purple-900/10 hover:bg-purple-900/20' : 'border-teal-900/50 bg-teal-900/10 hover:bg-teal-900/20';
                const activeColor = isCoding ? 'border-purple-500 bg-purple-900/20' : 'border-green-500 bg-green-900/20';
                const titleColor = isCoding ? 'text-purple-400' : 'text-teal-400';
                const icon = isCoding ? 'üíª' : 'üìù';
                const typeText = isCoding ? 'Coding Challenge' : '3 fresh MCQs';
                const clickHint = isCoding ? 'Click to open in Code Lab' : 'Click to start';

                return `
                <div id="assignment-${a.id}" class="assignment-item p-3 border cursor-pointer transition-all ${activeAssignmentId === a.id ? activeColor : bgColor}" onclick="${isCoding ? `startCodingAssignment('${a.id}', '${a.topic}')` : `startAssignment('${a.id}', '${a.topic}', ${JSON.stringify(a.questions || []).replace(/"/g, '&quot;')}, '${a.level || 'easy'}')`}">
                    <div class="flex justify-between items-center">
                        <div class="text-xs font-bold ${titleColor}">${icon} ${a.topic.toUpperCase()}</div>
                        ${activeAssignmentId === a.id ? '<span class="text-[8px] text-green-400">ACTIVE</span>' : ''}
                    </div>
                    <div class="text-[10px] text-white mt-1">${typeText} ‚Ä¢ ${a.level || a.difficulty || 'medium'}</div>
                    <div class="text-[8px] text-gray-500 mt-1">${clickHint}</div>
                </div>
            `;
            }).join('');
        }

        // Render completed assignments
        if (completed.length > 0 && completedSection && completedList) {
            completedSection.classList.remove('hidden');
            completedList.innerHTML = completed.map(a => `
                <div class="p-2 border border-gray-800 bg-gray-900/50 opacity-60">
                    <div class="flex justify-between items-center">
                        <div class="text-[10px] font-bold text-gray-400">${a.topic.toUpperCase()}</div>
                        <span class="text-[8px] text-green-400">‚úì ${a.score}%</span>
                    </div>
                </div>
            `).join('');
        } else if (completedSection) {
            completedSection.classList.add('hidden');
        }
    }

    let currentAssignment = null;

    // Start a coding assignment - opens Code Lab with the challenge
    function startCodingAssignment(assignmentId, topic) {
        console.log('startCodingAssignment called:', { assignmentId, topic });

        // Find the challenge by topic name
        const challenge = codingChallenges.find(c =>
            c.title.toLowerCase() === topic.toLowerCase() ||
            c.id === topic.toLowerCase().replace(/\s+/g, '-')
        );

        if (challenge) {
            // Open Code Lab and start the challenge
            activeAssignmentId = assignmentId;
            displayStudentAssignments(studentAssignments);

            showToast('Coding Assignment!', `Opening: ${challenge.title}`, 'success', 2000);
            startCodingChallenge(challenge.id);
        } else {
            // If challenge not found in predefined list, create custom one
            showToast('Coding Assignment!', `Opening: ${topic}`, 'success', 2000);

            // Create a custom challenge from assignment
            const customChallenge = {
                id: 'assigned-' + assignmentId,
                title: topic,
                difficulty: 'Medium',
                category: 'Assigned',
                description: `Complete this coding challenge: ${topic}`,
                expected: '',
                hint: 'Follow the problem description carefully',
                starterCode: '# Write your code here\n'
            };

            currentChallenge = customChallenge;
            startCustomChallenge(customChallenge);
        }
    }

    async function startAssignment(assignmentId, topic, originalQuestions, difficulty = 'easy') {
        console.log('startAssignment called:', { assignmentId, topic, questionsCount: originalQuestions?.length, difficulty });

        try {
            // Set active assignment
            activeAssignmentId = assignmentId;
            displayStudentAssignments(studentAssignments);

            // Show CENTER PANEL practice view (more space for questions)
            const overviewView = document.getElementById('student-overview-view');
            const practiceView = document.getElementById('student-practice-view');
            const titleEl = document.getElementById('center-practice-topic');
            const subtitleEl = document.getElementById('center-practice-subtitle');
            const questionsContainer = document.getElementById('center-practice-questions');

            if (overviewView) overviewView.classList.add('hidden');
            if (practiceView) {
                practiceView.classList.remove('hidden');
                practiceView.style.display = 'flex';
            }
            if (titleEl) titleEl.textContent = `ASSIGNMENT: ${topic.toUpperCase()}`;
            if (subtitleEl) subtitleEl.textContent = 'Answer all questions below. Select one option per question.';

            // Show loading state
            if (questionsContainer) {
                questionsContainer.innerHTML = '<div class="text-teal-400 text-sm animate-pulse p-4">Generating fresh questions via AI...</div>';
            }

            // Generate NEW MCQs via concepts-agent
            let questions = originalQuestions;
            try {
                showToast('Generating Questions', 'Creating fresh MCQs via AI...', 'info', 2000);

                const response = await fetch(getAgentURL(API_CONFIG.CONCEPTS_PORT, '/generate-mcqs'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        difficulty: difficulty,
                        count: 3
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.questions && data.questions.length > 0) {
                        questions = data.questions;
                        showToast('Questions Ready', `${questions.length} fresh MCQs generated!`, 'success', 2000);
                    }
                }
            } catch (err) {
                console.error('MCQ generation error:', err);
                showToast('Using Stored Questions', 'AI unavailable, using assignment questions', 'info', 2000);
            }

            // Store current assignment and session
            currentAssignment = { id: assignmentId, topic, questions };
            currentPracticeSession = { topicId: topic, topicName: topic, questions, answers: {}, assignmentId };

            // Render questions in CENTER panel with better sizing
            if (questionsContainer) {
                questionsContainer.innerHTML = '';
                questions.forEach((mcq, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'p-4 bg-gray-900/50 border border-teal-900/30 rounded';
                    let optionsHTML = '';
                    mcq.options.forEach((option, optionIndex) => {
                        optionsHTML += `
                            <label class="flex items-start gap-3 mb-2 p-2 cursor-pointer hover:bg-teal-900/20 rounded transition">
                                <input type="radio" name="center-question-${index}" value="${optionIndex}" class="mt-1 text-teal-500">
                                <span class="text-sm text-white">${String.fromCharCode(65 + optionIndex)}. ${option}</span>
                            </label>
                        `;
                    });
                    questionDiv.innerHTML = `
                        <div class="text-teal-400 font-bold text-sm mb-3">Question ${index + 1}:</div>
                        <div class="text-white text-sm mb-4 leading-relaxed">${mcq.question}</div>
                        <div class="ml-2">${optionsHTML}</div>
                    `;
                    questionsContainer.appendChild(questionDiv);
                });
            }
        } catch (err) {
            console.error('startAssignment error:', err);
            showToast('Error', 'Failed to load assignment: ' + err.message, 'error');
        }
    }

    // Close center practice view
    function closeCenterPractice() {
        const overviewView = document.getElementById('student-overview-view');
        const practiceView = document.getElementById('student-practice-view');
        if (overviewView) overviewView.classList.remove('hidden');
        if (practiceView) {
            practiceView.classList.add('hidden');
            practiceView.style.display = 'none';
        }
        activeAssignmentId = null;
        currentPracticeSession = null;
    }

    // Submit answers from center panel
    async function submitCenterAnswers() {
        if (!currentPracticeSession) {
            showToast('Error', 'No active practice session', 'error');
            return;
        }

        const questions = currentPracticeSession.questions;
        let correctCount = 0;
        const totalQuestions = questions.length;

        // Collect and grade answers
        questions.forEach((mcq, index) => {
            const selectedRadio = document.querySelector(`input[name="center-question-${index}"]:checked`);
            if (selectedRadio) {
                const selectedIndex = parseInt(selectedRadio.value);
                // MCQ object uses .correct (not .correctIndex)
                const correctAnswer = mcq.correct !== undefined ? mcq.correct : mcq.correctIndex;
                console.log(`[GRADING] Q${index}: selected=${selectedIndex}, correct=${correctAnswer}`);
                if (selectedIndex === correctAnswer) {
                    correctCount++;
                }
            }
        });
        console.log(`[SCORE] ${correctCount}/${totalQuestions} correct`);

        const score = Math.round((correctCount / totalQuestions) * 100);

        // Update mastery via API
        try {
            const userStr = localStorage.getItem('learnflow_user');
            if (userStr) {
                const user = JSON.parse(userStr);
                const studentId = user.studentId || 'demo-student-001';

                // Call the correct endpoint: /mastery/{student_id}
                await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${studentId}`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: currentPracticeSession.topicId || 'python-basics',
                        score: score / 100,  // API expects 0-1 range
                        questions_answered: totalQuestions,
                        correct_answers: correctCount
                    })
                });
                console.log(`[MASTERY] Updated: ${score}% on ${currentPracticeSession.topicId}`);
            }
        } catch (err) {
            console.error('Mastery update error:', err);
        }

        // Mark assignment complete and NOTIFY TEACHER INSTANTLY
        if (currentPracticeSession.assignmentId) {
            try {
                const userStr = localStorage.getItem('learnflow_user');
                const user = userStr ? JSON.parse(userStr) : {};

                console.log('[TASK COMPLETE] Notifying teacher of completion, score:', score);

                await fetch(`/api/assignments/${currentPracticeSession.assignmentId}/complete`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        score,
                        studentName: user.name || 'Student'
                    })
                });

                console.log('[TASK COMPLETE] Teacher notification sent!');
            } catch (err) {
                console.error('Assignment completion error:', err);
            }
        }

        // Show results
        showToast(
            'Practice Complete!',
            `Score: ${correctCount}/${totalQuestions} (${score}%) - Your mastery has been updated!`,
            score >= 70 ? 'success' : 'info',
            5000
        );

        // Close practice view and refresh
        closeCenterPractice();
        loadStudentAssignments();

        // CRITICAL: Refresh mastery display immediately after completion
        await fetchMasteryData();
    }

    window.closeCenterPractice = closeCenterPractice;
    window.submitCenterAnswers = submitCenterAnswers;

    // Override assignPracticeToSelected to use API
    window.assignPracticeToSelected = async function() {
        console.log('assignPracticeToSelected called');
        if (!generatedTest) {
            showToast('Error', 'Please generate a practice test first', 'error');
            return;
        }

        const userStr = localStorage.getItem('learnflow_user');
        if (!userStr) {
            showToast('Error', 'Not logged in', 'error');
            return;
        }
        const teacher = JSON.parse(userStr);
        console.log('Teacher:', teacher);

        const checkboxes = document.querySelectorAll('.assign-checkbox:checked');
        if (checkboxes.length === 0) {
            showToast('Error', 'Please select at least one student', 'error');
            return;
        }

        const topic = document.getElementById('practice-topic').value;
        const difficulty = document.getElementById('practice-difficulty').value;
        let successCount = 0;
        const assignedNames = [];

        for (const cb of checkboxes) {
            try {
                console.log('Assigning to student:', cb.value, cb.dataset.name);
                const res = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        teacherId: teacher.teacherId || teacher.id,
                        studentId: cb.value,
                        studentName: cb.dataset.name,
                        topic,
                        level: difficulty,
                        questions: generatedTest.questions
                    })
                });
                const data = await res.json();
                console.log('Assignment response:', data);
                if (data.success) {
                    successCount++;
                    assignedNames.push(cb.dataset.name);
                }
            } catch (err) {
                console.error('Assign error:', err);
            }
        }

        showToast('Practice Assigned', `Assigned to ${successCount} student(s): ${assignedNames.join(', ')}`, 'success', 5000);
        loadNotifications();
    };

    // Override submitAnswers to handle assignment completion
    const originalSubmitAnswers = window.submitAnswers;
    window.submitAnswers = async function() {
        if (!currentPracticeSession) {
            showToast('Error', 'No active practice session', 'error');
            return;
        }

        const userStr = localStorage.getItem('learnflow_user');
        const user = userStr ? JSON.parse(userStr) : { studentId: 'demo-student-001' };

        let correctCount = 0;
        const totalQuestions = currentPracticeSession.questions.length;

        for (let i = 0; i < totalQuestions; i++) {
            const selected = document.querySelector(`input[name="question-${i}"]:checked`);
            if (selected && parseInt(selected.value) === currentPracticeSession.questions[i].correct) {
                correctCount++;
            }
        }

        const score = Math.round((correctCount / totalQuestions) * 100);
        const passed = correctCount >= (totalQuestions / 2);
        const topicName = currentPracticeSession.topicName || currentPracticeSession.topicId;
        const wasAssignment = !!currentPracticeSession.assignmentId;

        // If this is an assignment, complete it via API (creates teacher notification)
        if (currentPracticeSession.assignmentId) {
            try {
                await fetch(`/api/assignments/${currentPracticeSession.assignmentId}/complete`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        score,
                        studentName: user.name
                    })
                });
            } catch (err) {
                console.error('Complete assignment error:', err);
            }
        }

        // Show results as toast (NOT browser alert)
        showToast(
            passed ? 'Practice Complete!' : 'Keep Practicing!',
            `Score: ${correctCount}/${totalQuestions} (${score}%) - ${topicName.toUpperCase()}`,
            passed ? 'success' : 'info',
            6000
        );

        // Always update mastery with actual score
        try {
            await fetch(getAgentURL(API_CONFIG.PROGRESS_PORT, `/mastery/${user.studentId}`), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: user.studentId,
                    topic: currentPracticeSession.topicId,
                    interaction_type: 'success',
                    success: true,
                    score: score  // Direct score: 100% topic = 20% global
                })
            });

            // Refresh mastery display
            setTimeout(() => loadStudentMastery(user.studentId), 500);
        } catch (err) {
            console.error('Update mastery error:', err);
        }

        // Go back to topics
        showTopicsList();

        // Clear active assignment state and reload assignments
        activeAssignmentId = null;
        if (wasAssignment) {
            loadStudentAssignments();
        }

        currentPracticeSession = null;
        currentAssignment = null;
    };

    // Logout function
    function logout() {
        localStorage.removeItem('learnflow_user');
        localStorage.removeItem('learnflow_assigned_tests');
        // CRITICAL: Clear session user to prevent stale data
        currentSessionUser = null;
        notificationsInitialized = false;
        seenNotificationIds.clear();  // Reset seen notifications
        notificationsData = [];  // Clear notification data
        stopNotificationPolling();  // Stop polling
        // Remove student assignments panel if exists
        const assignPanel = document.getElementById('student-assignments-panel');
        if (assignPanel) assignPanel.remove();
        document.getElementById('dashboard-header')?.classList.add('hidden');
        showPage('auth');
        showToast('Logged Out', 'You have been logged out successfully', 'info');
    }

    // Clear all session data (for debugging)
    function clearSession() {
        localStorage.clear();
        currentSessionUser = null;  // Clear session user
        notificationsInitialized = false;
        seenNotificationIds.clear();
        notificationsData = [];
        stopNotificationPolling();
        isRegisterMode = true;
        document.getElementById('nameField').style.display = 'block';
        document.getElementById('toggleAuthMode').textContent = 'EXISTING USER? RETURN_TO_LOGIN';
        document.getElementById('authModeTitle').textContent = 'REGISTRATION';
        document.getElementById('authButton').textContent = 'REGISTER_IDENTITY';
        document.getElementById('authError').classList.add('hidden');
        document.getElementById('authEmail').value = '';
        document.getElementById('authPassword').value = '';
        document.getElementById('authName').value = '';
        showToast('Session Cleared', 'All data cleared. Please register fresh.', 'info');
    }

    // Update user role badge in header
    function updateHeaderBadge() {
        const userStr = localStorage.getItem('learnflow_user');
        if (userStr) {
            const user = JSON.parse(userStr);
            const badge = document.getElementById('user-role-badge');
            if (badge) {
                badge.textContent = user.role?.toUpperCase() || 'USER';
                badge.className = user.role === 'teacher'
                    ? 'text-[10px] px-2 py-1 bg-amber-600/50 rounded text-white'
                    : 'text-[10px] px-2 py-1 bg-teal-600/50 rounded text-white';
            }
        }
    }

    // Validate stored user on page load
    async function validateStoredUser() {
        const userStr = localStorage.getItem('learnflow_user');
        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                // Try to verify user exists by making a simple API call
                const response = await fetch(`/api/notifications/${user.studentId || user.teacherId}`);
                if (!response.ok) {
                    // User might not exist anymore, clear storage
                    console.log('Stored user invalid, clearing session');
                    localStorage.removeItem('learnflow_user');
                }
            } catch (e) {
                console.log('Error validating user, clearing session');
                localStorage.removeItem('learnflow_user');
            }
        }
    }

    // Show header when on dashboard
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STUDENT PROGRESS TRACKING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Daily tips rotation
    const dailyTips = [
        "Practice coding daily to build muscle memory!",
        "Read error messages carefully - they tell you what's wrong!",
        "Break complex problems into smaller steps.",
        "Use print() to debug your code step by step.",
        "Don't be afraid to make mistakes - that's how you learn!",
        "Try explaining your code out loud - it helps you understand it!",
        "Take breaks when stuck - fresh eyes see solutions!",
        "Comment your code to remember what it does later."
    ];

    // Update student progress panel
    function updateStudentProgress(type) {
        const completedEl = document.getElementById('student-completed-count');
        const streakEl = document.getElementById('student-streak-count');
        const levelEl = document.getElementById('student-level');
        const progressEl = document.getElementById('student-level-progress');
        const xpEl = document.getElementById('student-xp-text');
        const achievementsEl = document.getElementById('student-achievements');

        // Get stored progress or initialize
        let progress = JSON.parse(localStorage.getItem('student_progress') || '{"completed": 0, "streak": 1, "xp": 200, "achievements": ["first-steps"]}');

        if (type === 'correct') {
            progress.completed++;
            progress.xp += 50;

            // Check for level ups
            const levels = [
                { name: 'Beginner', maxXp: 500 },
                { name: 'Novice', maxXp: 1000 },
                { name: 'Apprentice', maxXp: 2000 },
                { name: 'Intermediate', maxXp: 4000 },
                { name: 'Advanced', maxXp: 8000 },
                { name: 'Expert', maxXp: 15000 },
                { name: 'Master', maxXp: 999999 }
            ];

            let currentLevel = levels[0];
            let prevLevel = 0;
            for (let i = 0; i < levels.length; i++) {
                if (progress.xp < levels[i].maxXp) {
                    currentLevel = levels[i];
                    prevLevel = i > 0 ? levels[i-1].maxXp : 0;
                    break;
                }
            }

            // Update UI
            if (completedEl) completedEl.textContent = progress.completed;
            if (streakEl) streakEl.textContent = 'üî• ' + progress.streak;
            if (levelEl) levelEl.textContent = currentLevel.name;

            const levelProgress = ((progress.xp - prevLevel) / (currentLevel.maxXp - prevLevel)) * 100;
            if (progressEl) progressEl.style.width = Math.min(levelProgress, 100) + '%';
            if (xpEl) xpEl.textContent = `${progress.xp}/${currentLevel.maxXp} XP`;

            // Check for new achievements
            if (progress.completed === 1 && !progress.achievements.includes('first-code')) {
                progress.achievements.push('first-code');
                addAchievement('first-code', 'üíª', 'Code Rookie', 'Complete your first coding challenge');
            }
            if (progress.completed === 5 && !progress.achievements.includes('five-star')) {
                progress.achievements.push('five-star');
                addAchievement('five-star', '‚≠ê', 'Rising Star', 'Complete 5 coding challenges');
            }
            if (progress.completed === 10 && !progress.achievements.includes('ten-complete')) {
                progress.achievements.push('ten-complete');
                addAchievement('ten-complete', 'üèÖ', 'Code Warrior', 'Complete 10 coding challenges');
            }

            // Save progress
            localStorage.setItem('student_progress', JSON.stringify(progress));
        }
    }

    // Add achievement to UI
    function addAchievement(id, icon, title, description) {
        const achievementsEl = document.getElementById('student-achievements');
        if (!achievementsEl) return;

        const achDiv = document.createElement('div');
        achDiv.className = 'flex items-center gap-2 p-2 bg-gradient-to-r from-yellow-900/30 to-orange-900/30 rounded border border-yellow-700/50 animate-pulse';
        achDiv.innerHTML = `
            <span class="text-lg">${icon}</span>
            <div>
                <div class="text-[10px] font-bold text-yellow-300">${title}</div>
                <div class="text-[8px] text-gray-400">${description}</div>
            </div>
        `;
        achievementsEl.insertBefore(achDiv, achievementsEl.firstChild);

        showToast('üèÜ Achievement Unlocked!', title, 'success', 5000);
    }

    // Celebration effect for correct answers
    function showCelebration() {
        // Create confetti effect
        const colors = ['#22c55e', '#eab308', '#3b82f6', '#ec4899', '#8b5cf6'];

        for (let i = 0; i < 30; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: fixed;
                    top: -10px;
                    left: ${Math.random() * 100}%;
                    width: 10px;
                    height: 10px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    pointer-events: none;
                    z-index: 9999;
                    animation: confettiFall 3s forwards;
                `;
                document.body.appendChild(confetti);

                setTimeout(() => confetti.remove(), 3000);
            }, i * 50);
        }
    }

    // Add confetti animation CSS
    const celebrationStyle = document.createElement('style');
    celebrationStyle.textContent = `
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    `;
    document.head.appendChild(celebrationStyle);

    // Initialize student progress on load
    function initStudentProgress() {
        const progress = JSON.parse(localStorage.getItem('student_progress') || '{"completed": 0, "streak": 1, "xp": 200, "achievements": ["first-steps"]}');

        const completedEl = document.getElementById('student-completed-count');
        const streakEl = document.getElementById('student-streak-count');

        if (completedEl) completedEl.textContent = progress.completed;
        if (streakEl) streakEl.textContent = 'üî• ' + progress.streak;

        // Set random daily tip
        const tipEl = document.getElementById('daily-tip');
        if (tipEl) {
            tipEl.textContent = dailyTips[Math.floor(Math.random() * dailyTips.length)];
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        // Validate stored user first
        validateStoredUser();
        // Update header badge when page loads
        updateHeaderBadge();
        // Initialize student progress panel
        initStudentProgress();
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GLOBAL EXPORTS - Make onclick handler functions globally accessible
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.togglePasswordVisibility = togglePasswordVisibility;
    window.toggleAuthMode = toggleAuthMode;
    window.startHandshake = startHandshake;
    window.toggleNotifications = toggleNotifications;
    window.logout = logout;
    window.clearSession = clearSession;
    window.refreshTeacherData = refreshTeacherData;
    window.testAllAgents = testAllAgents;
    window.showTopicsList = showTopicsList;
    window.openPracticeTopicsInCenter = openPracticeTopicsInCenter;
    window.closeTopicsView = closeTopicsView;
    window.openCodeLabInCenter = openCodeLabInCenter;
    window.closeCodeLab = closeCodeLab;
    window.submitCodeForReview = submitCodeForReview;
    window.submitCodeForDebug = submitCodeForDebug;
    window.loadCodingChallenges = loadCodingChallenges;
    window.startCodingChallenge = startCodingChallenge;
    window.backToChallengesList = backToChallengesList;
    window.runPythonCode = runPythonCode;
    window.clearConsole = clearConsole;
    window.loadTopicsInCenter = loadTopicsInCenter;
    window.teacherGeneratePractice = teacherGeneratePractice;
    window.autoAssignPractice = autoAssignPractice;
    window.handleNotificationClick = handleNotificationClick;
    window.startAssignment = startAssignment;
    window.sendEncouragement = sendEncouragement;
    window.assignCodingChallenge = assignCodingChallenge;
    window.filterCodingChallenges = filterCodingChallenges;
    window.generateSimilarChallenge = generateSimilarChallenge;
    window.generateCustomProblem = generateCustomProblem;
    window.startCustomChallenge = startCustomChallenge;
    window.startCodingAssignment = startCodingAssignment;
</script>
</body>
</html>
