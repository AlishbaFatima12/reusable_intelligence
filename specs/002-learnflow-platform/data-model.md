# Data Model: LearnFlow Multi-Agent Learning Platform

**Feature Branch**: `002-learnflow-platform`
**Created**: 2026-01-02
**Status**: Complete
**Related Documents**: [spec.md](./spec.md), [plan.md](./plan.md), [research.md](./research.md)

---

## 1. Entity Overview

This document defines all data entities, their storage mechanisms, relationships, and validation rules for the LearnFlow platform. The system uses a hybrid storage approach:

- **PostgreSQL (via Dapr State Store)**: Persistent relational data (student progress, query history)
- **Kafka**: Event streams (inter-agent messages, logs)
- **Dapr State Store (Ephemeral)**: Agent health metrics (in-memory state)

---

## 2. Core Entities

### 2.1 StudentQuery

**Purpose**: Represents a question or request submitted by a student.

**Storage**: PostgreSQL (`query_history` table)

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `query_id` | UUID | PRIMARY KEY, NOT NULL, DEFAULT gen_random_uuid() | Unique identifier for the query |
| `student_id` | VARCHAR(255) | NOT NULL, REFERENCES student_progress(student_id) | Student who submitted the query |
| `query_text` | TEXT | NOT NULL, MIN LENGTH 1, MAX LENGTH 5000 | The actual question or code submitted |
| `query_vector` | tsvector | INDEXED (GIN) | Full-text search vector for query text |
| `timestamp` | TIMESTAMP | NOT NULL, DEFAULT NOW() | When the query was submitted |
| `detected_intent` | VARCHAR(50) | CHECK IN ('concepts', 'code_review', 'debug', 'exercise', 'progress') | Intent detected by Triage Agent |
| `routed_to_agent` | VARCHAR(50) | NOT NULL, CHECK IN ('concepts', 'code-review', 'debug', 'exercise', 'progress') | Which specialist agent handled this |
| `status` | VARCHAR(20) | NOT NULL, DEFAULT 'pending', CHECK IN ('pending', 'processing', 'completed', 'failed') | Current processing state |
| `triage_confidence` | DECIMAL(3,2) | CHECK BETWEEN 0.0 AND 1.0 | Confidence score from Triage Agent (0.0-1.0) |
| `code_snippet` | TEXT | NULLABLE, MAX LENGTH 10000 | Code included in query (if applicable) |
| `language` | VARCHAR(50) | NULLABLE, CHECK IN ('python', 'javascript', 'java', 'cpp', 'go', 'rust') | Programming language of code snippet |
| `context` | JSONB | NULLABLE | Additional context (skill level, previous topics) |

**Relationships**:
- One-to-one with `AgentResponse` (each query gets one response)
- Many-to-one with `Student` (via `student_id`)
- One-to-many with `MessageFlow` (a query generates multiple inter-agent messages)

**State Transitions**:
```
pending → processing → completed
                    ↓
                  failed
```

**Validation Rules**:
- `query_text` must not be empty after trimming whitespace
- If `code_snippet` is provided, `language` must be specified
- `triage_confidence` required when `status` transitions to 'processing'
- `routed_to_agent` must be set before marking 'processing'

**Indexes**:
```sql
CREATE INDEX idx_student_queries ON query_history(student_id, timestamp DESC);
CREATE INDEX idx_query_status ON query_history(status, timestamp DESC);
CREATE INDEX idx_query_vector ON query_history USING GIN(query_vector);
CREATE INDEX idx_query_agent ON query_history(routed_to_agent, timestamp DESC);
```

**Example**:
```json
{
  "query_id": "550e8400-e29b-41d4-a716-446655440000",
  "student_id": "student-123",
  "query_text": "Why does my code throw IndexError?",
  "timestamp": "2026-01-02T14:23:45Z",
  "detected_intent": "debug",
  "routed_to_agent": "debug",
  "status": "processing",
  "triage_confidence": 0.95,
  "code_snippet": "arr = [1, 2, 3]\nprint(arr[5])",
  "language": "python",
  "context": {
    "skill_level": "beginner",
    "topics_covered": ["variables", "loops"]
  }
}
```

---

### 2.2 AgentResponse

**Purpose**: The output generated by a specialist agent in response to a student query.

**Storage**: PostgreSQL (`agent_responses` table)

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `response_id` | UUID | PRIMARY KEY, NOT NULL, DEFAULT gen_random_uuid() | Unique identifier for the response |
| `query_id` | UUID | NOT NULL, UNIQUE, REFERENCES query_history(query_id) | The query this response answers |
| `agent_type` | VARCHAR(50) | NOT NULL, CHECK IN ('concepts', 'code-review', 'debug', 'exercise', 'progress') | Which agent generated this response |
| `response_text` | TEXT | NOT NULL, MIN LENGTH 10 | The main response content |
| `response_type` | VARCHAR(50) | NOT NULL, CHECK IN ('explanation', 'code_review', 'debug_solution', 'exercise', 'progress_report') | Type of response |
| `processing_time_ms` | INTEGER | NOT NULL, CHECK > 0 | Time taken to generate response (milliseconds) |
| `confidence_score` | DECIMAL(3,2) | CHECK BETWEEN 0.0 AND 1.0 | Agent's confidence in response quality |
| `code_examples` | TEXT[] | NULLABLE | Array of code snippets included in response |
| `metadata` | JSONB | NULLABLE | Additional data (hints, test cases, insights) |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT NOW() | When the response was generated |
| `claude_model` | VARCHAR(100) | NOT NULL | Claude model used (e.g., 'claude-sonnet-4-20250514') |
| `token_count` | INTEGER | CHECK > 0 | Total tokens used (input + output) |

**Relationships**:
- One-to-one with `StudentQuery` (via `query_id`)
- Triggers update to `LearningProgress` (Progress Tracker processes all responses)

**Validation Rules**:
- `response_text` must be substantive (>10 characters after trimming)
- `confidence_score` required for all responses
- `processing_time_ms` must reflect actual Claude API latency
- `code_examples` must be valid code snippets (syntax-checked in agent)

**Indexes**:
```sql
CREATE INDEX idx_response_query ON agent_responses(query_id);
CREATE INDEX idx_response_agent ON agent_responses(agent_type, created_at DESC);
CREATE INDEX idx_response_time ON agent_responses(processing_time_ms);
```

**Example**:
```json
{
  "response_id": "650e8400-e29b-41d4-a716-446655440001",
  "query_id": "550e8400-e29b-41d4-a716-446655440000",
  "agent_type": "debug",
  "response_text": "The IndexError occurs because you're trying to access index 5, but your array only has 3 elements (indices 0-2). Arrays in Python are zero-indexed...",
  "response_type": "debug_solution",
  "processing_time_ms": 4823,
  "confidence_score": 0.98,
  "code_examples": [
    "arr = [1, 2, 3]\nprint(arr[2])  # ✓ Valid: accesses last element",
    "arr = [1, 2, 3]\nprint(arr[len(arr) - 1])  # ✓ Safe: always gets last element"
  ],
  "metadata": {
    "error_type": "IndexError",
    "fix_applied": true,
    "suggested_topic": "list-indexing"
  },
  "created_at": "2026-01-02T14:23:50Z",
  "claude_model": "claude-sonnet-4-20250514",
  "token_count": 1250
}
```

---

### 2.3 Student

**Purpose**: Represents a learner using the platform.

**Storage**: PostgreSQL (`students` table)

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `student_id` | VARCHAR(255) | PRIMARY KEY, NOT NULL | Unique identifier (from external auth system) |
| `name` | VARCHAR(255) | NOT NULL | Student's full name |
| `email` | VARCHAR(255) | UNIQUE, NOT NULL, CHECK LIKE '%@%.%' | Student's email address |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT NOW() | When student account was created |
| `learning_style` | VARCHAR(50) | DEFAULT 'step-by-step', CHECK IN ('visual', 'auditory', 'kinesthetic', 'step-by-step', 'example-driven') | Preferred learning approach |
| `skill_level` | VARCHAR(50) | DEFAULT 'beginner', CHECK IN ('beginner', 'intermediate', 'advanced') | Current skill level |
| `active` | BOOLEAN | DEFAULT TRUE | Is student account active? |

**Relationships**:
- One-to-many with `StudentQuery`
- One-to-one with `LearningProgress`

**Validation Rules**:
- `email` must be valid email format
- `name` must not be empty after trimming
- `skill_level` auto-upgraded when mastery thresholds reached

**Indexes**:
```sql
CREATE UNIQUE INDEX idx_student_email ON students(email);
CREATE INDEX idx_student_active ON students(active, created_at DESC);
```

**Example**:
```json
{
  "student_id": "student-123",
  "name": "Jane Doe",
  "email": "jane.doe@example.com",
  "created_at": "2026-01-01T10:00:00Z",
  "learning_style": "example-driven",
  "skill_level": "intermediate",
  "active": true
}
```

---

### 2.4 LearningProgress

**Purpose**: Tracks a student's learning journey, mastery levels, and progress metrics.

**Storage**:
- PostgreSQL (`student_progress` table) for persistent history
- Dapr State Store (`progress:student:<id>`) for fast access

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `student_id` | VARCHAR(255) | PRIMARY KEY, REFERENCES students(student_id) | Student identifier |
| `python_mastery_levels` | JSONB | NOT NULL, DEFAULT '{}' | Mastery scores per topic (0.0-1.0) |
| `completed_exercises` | INTEGER | DEFAULT 0, CHECK >= 0 | Total exercises completed |
| `topics_mastered` | TEXT[] | DEFAULT '{}' | Array of mastered topics (mastery >= 0.85) |
| `topics_covered` | TEXT[] | DEFAULT '{}' | Array of all topics encountered |
| `strengths` | TEXT[] | NULLABLE | Top 3 mastered topics |
| `weaknesses` | TEXT[] | NULLABLE | Topics with mastery < 0.6 |
| `learning_velocity` | DECIMAL(3,2) | NULLABLE, CHECK >= 0 | Questions per day (rolling 7-day average) |
| `total_queries` | INTEGER | DEFAULT 0, CHECK >= 0 | Total questions submitted |
| `queries_by_type` | JSONB | DEFAULT '{}' | Breakdown by intent (concepts, debug, etc.) |
| `last_activity` | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last query submitted |
| `struggle_topics` | TEXT[] | NULLABLE | Topics where student asked 3+ similar questions |
| `achievements` | TEXT[] | DEFAULT '{}' | Badges earned (e.g., "mastered-loops") |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT NOW() | When progress tracking started |
| `updated_at` | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last updated |

**Relationships**:
- One-to-one with `Student` (via `student_id`)
- Updated by `Progress Tracker` agent based on all `AgentResponse` records

**State Transitions**:
- Mastery levels: 0.0 → 0.5 (learning) → 0.85 (mastered) → 1.0 (expert)
- Topics move from `topics_covered` → `topics_mastered` when mastery >= 0.85

**Validation Rules**:
- `python_mastery_levels` keys must be valid topic names (lowercase, hyphens)
- `python_mastery_levels` values must be between 0.0 and 1.0
- `strengths` updated when topic mastery >= 0.85
- `weaknesses` updated when topic mastery < 0.6 after 5+ queries
- `struggle_topics` added when 3+ similar queries on same topic within 24 hours

**Indexes**:
```sql
CREATE INDEX idx_progress_updated ON student_progress(updated_at DESC);
CREATE INDEX idx_mastery_levels ON student_progress USING GIN(python_mastery_levels);
CREATE INDEX idx_topics_covered ON student_progress USING GIN(topics_covered);
```

**Example**:
```json
{
  "student_id": "student-123",
  "python_mastery_levels": {
    "variables": 0.95,
    "loops": 0.88,
    "functions": 0.82,
    "lists": 0.75,
    "recursion": 0.60,
    "object-oriented-programming": 0.45
  },
  "completed_exercises": 23,
  "topics_mastered": ["variables", "loops"],
  "topics_covered": ["variables", "loops", "functions", "lists", "recursion", "object-oriented-programming"],
  "strengths": ["variables", "loops", "functions"],
  "weaknesses": ["recursion", "object-oriented-programming"],
  "learning_velocity": 4.2,
  "total_queries": 47,
  "queries_by_type": {
    "concepts": 20,
    "debug": 15,
    "code_review": 8,
    "exercise": 4
  },
  "last_activity": "2026-01-02T14:23:45Z",
  "struggle_topics": ["recursion"],
  "achievements": ["mastered-loops", "completed-10-exercises", "7-day-streak"],
  "created_at": "2026-01-01T10:00:00Z",
  "updated_at": "2026-01-02T14:23:45Z"
}
```

---

### 2.5 AgentHealthMetrics

**Purpose**: Real-time monitoring data for each of the 6 agents.

**Storage**: Dapr State Store (ephemeral, in-memory)

**State Key**: `agents:health:<agent_name>`

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `agent_name` | STRING | NOT NULL, CHECK IN ('triage', 'concepts', 'code-review', 'debug', 'exercise', 'progress') | Agent identifier |
| `status` | STRING | NOT NULL, CHECK IN ('active', 'idle', 'error', 'starting', 'stopping') | Current status |
| `uptime_seconds` | INTEGER | CHECK >= 0 | Time since agent started |
| `total_queries_processed` | INTEGER | CHECK >= 0 | Lifetime query count |
| `queries_last_hour` | INTEGER | CHECK >= 0 | Queries processed in last 60 minutes |
| `error_count` | INTEGER | CHECK >= 0 | Total errors encountered |
| `error_count_last_hour` | INTEGER | CHECK >= 0 | Errors in last 60 minutes |
| `avg_response_time_ms` | INTEGER | CHECK > 0 | Average response time (milliseconds) |
| `p95_response_time_ms` | INTEGER | CHECK > 0 | 95th percentile response time |
| `current_queue_depth` | INTEGER | CHECK >= 0 | Messages waiting in Kafka partition |
| `last_heartbeat` | TIMESTAMP | NOT NULL | Last health check timestamp |
| `replica_count` | INTEGER | DEFAULT 1, CHECK > 0 | Number of running replicas |
| `version` | STRING | NOT NULL | Agent version (e.g., "v1.0.0") |

**State Transitions**:
```
starting → active → idle
              ↓      ↓
            error ←--
              ↓
          stopping
```

**Validation Rules**:
- `last_heartbeat` must be within last 30 seconds (else status = 'error')
- `status` = 'active' only when `queries_last_hour` > 0
- `status` = 'idle' when `queries_last_hour` = 0 and no errors
- `status` = 'error' when `error_count_last_hour` > 10

**Update Frequency**: Every 10 seconds (heartbeat from each agent)

**Example**:
```json
{
  "agent_name": "triage",
  "status": "active",
  "uptime_seconds": 345600,
  "total_queries_processed": 12456,
  "queries_last_hour": 234,
  "error_count": 47,
  "error_count_last_hour": 2,
  "avg_response_time_ms": 1823,
  "p95_response_time_ms": 3450,
  "current_queue_depth": 12,
  "last_heartbeat": "2026-01-02T14:23:45Z",
  "replica_count": 3,
  "version": "v1.0.0"
}
```

---

### 2.6 MessageFlow

**Purpose**: Trace of inter-agent communication for a single student query (audit trail).

**Storage**: PostgreSQL (`message_flow` table)

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `trace_id` | UUID | NOT NULL | Unique identifier for the entire message flow |
| `query_id` | UUID | NOT NULL, REFERENCES query_history(query_id) | The query this message relates to |
| `message_id` | UUID | PRIMARY KEY, NOT NULL, DEFAULT gen_random_uuid() | Unique message identifier |
| `source_agent` | VARCHAR(50) | NOT NULL | Agent that sent this message |
| `destination_agent` | VARCHAR(50) | NOT NULL | Agent that received this message |
| `message_content` | TEXT | NOT NULL | Message payload (summary, not full content) |
| `message_type` | VARCHAR(50) | NOT NULL, CHECK IN ('routing_decision', 'request', 'response', 'collaboration') | Type of message |
| `timestamp` | TIMESTAMP | NOT NULL, DEFAULT NOW() | When message was sent |
| `sequence_order` | INTEGER | NOT NULL, CHECK > 0 | Order in the message chain (1, 2, 3...) |

**Relationships**:
- Many-to-one with `StudentQuery` (via `query_id`)
- Grouped by `trace_id` to reconstruct full message flow

**Validation Rules**:
- `source_agent` and `destination_agent` must be different
- `sequence_order` must be sequential within same `trace_id`
- `message_type` = 'routing_decision' only valid when `source_agent` = 'triage'

**Indexes**:
```sql
CREATE INDEX idx_message_trace ON message_flow(trace_id, sequence_order);
CREATE INDEX idx_message_query ON message_flow(query_id, timestamp);
CREATE INDEX idx_message_agents ON message_flow(source_agent, destination_agent);
```

**Example**:
```json
[
  {
    "trace_id": "trace-abc-123",
    "query_id": "550e8400-e29b-41d4-a716-446655440000",
    "message_id": "msg-001",
    "source_agent": "triage",
    "destination_agent": "debug",
    "message_content": "Routing query to Debug Agent (intent: debug, confidence: 0.95)",
    "message_type": "routing_decision",
    "timestamp": "2026-01-02T14:23:45Z",
    "sequence_order": 1
  },
  {
    "trace_id": "trace-abc-123",
    "query_id": "550e8400-e29b-41d4-a716-446655440000",
    "message_id": "msg-002",
    "source_agent": "debug",
    "destination_agent": "concepts",
    "message_content": "Request concept explanation for IndexError",
    "message_type": "collaboration",
    "timestamp": "2026-01-02T14:23:47Z",
    "sequence_order": 2
  },
  {
    "trace_id": "trace-abc-123",
    "query_id": "550e8400-e29b-41d4-a716-446655440000",
    "message_id": "msg-003",
    "source_agent": "concepts",
    "destination_agent": "debug",
    "message_content": "IndexError explanation provided",
    "message_type": "response",
    "timestamp": "2026-01-02T14:23:50Z",
    "sequence_order": 3
  }
]
```

---

### 2.7 Exercise

**Purpose**: A practice problem generated by the Exercise Generator agent.

**Storage**: PostgreSQL (`exercises` table)

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `exercise_id` | UUID | PRIMARY KEY, NOT NULL, DEFAULT gen_random_uuid() | Unique identifier |
| `topic` | VARCHAR(100) | NOT NULL | Programming topic (e.g., "loops", "recursion") |
| `difficulty` | VARCHAR(20) | NOT NULL, CHECK IN ('beginner', 'intermediate', 'advanced') | Difficulty level |
| `problem_text` | TEXT | NOT NULL | The exercise problem statement |
| `solution_code` | TEXT | NOT NULL | Reference solution |
| `starter_code` | TEXT | NULLABLE | Initial code template for student |
| `test_cases` | JSONB | NOT NULL | Array of test inputs/outputs |
| `hints` | TEXT[] | NULLABLE | Progressive hints (hidden by default) |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT NOW() | When exercise was generated |
| `created_by_agent` | VARCHAR(50) | DEFAULT 'exercise' | Agent that created this |
| `language` | VARCHAR(50) | NOT NULL, CHECK IN ('python', 'javascript', 'java') | Programming language |
| `tags` | TEXT[] | NULLABLE | Additional tags (e.g., ["loops", "arrays"]) |

**Relationships**:
- Can be assigned to students (many-to-many via `student_exercises` join table)

**Validation Rules**:
- `problem_text` must be clear and concise (< 1000 characters)
- `test_cases` must have at least 3 test cases
- `solution_code` must pass all test cases
- `difficulty` must match topic complexity

**Indexes**:
```sql
CREATE INDEX idx_exercise_topic ON exercises(topic, difficulty);
CREATE INDEX idx_exercise_tags ON exercises USING GIN(tags);
```

**Example**:
```json
{
  "exercise_id": "750e8400-e29b-41d4-a716-446655440002",
  "topic": "loops",
  "difficulty": "beginner",
  "problem_text": "Write a function that prints numbers from 1 to N using a for loop.",
  "solution_code": "def print_numbers(n):\n    for i in range(1, n + 1):\n        print(i)",
  "starter_code": "def print_numbers(n):\n    # Your code here\n    pass",
  "test_cases": [
    {"input": 3, "output": "1\n2\n3"},
    {"input": 5, "output": "1\n2\n3\n4\n5"},
    {"input": 1, "output": "1"}
  ],
  "hints": [
    "Use a for loop with range()",
    "range(1, n+1) generates numbers from 1 to n",
    "Use print(i) inside the loop"
  ],
  "created_at": "2026-01-02T14:30:00Z",
  "created_by_agent": "exercise",
  "language": "python",
  "tags": ["loops", "range", "printing"]
}
```

---

### 2.8 KafkaMessage (Standard Envelope)

**Purpose**: Unified message structure for all Kafka topics.

**Storage**: Kafka topics (ephemeral, retained per topic policy)

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `schema_version` | STRING | NOT NULL, DEFAULT "1.0" | Schema version for compatibility |
| `message_id` | UUID | NOT NULL | Unique message identifier |
| `timestamp` | TIMESTAMP | NOT NULL | When message was created (ISO 8601) |
| `student_id` | STRING | NULLABLE | Student this message relates to (for routing) |
| `trace_id` | UUID | NOT NULL | Distributed tracing ID |
| `event_type` | STRING | NOT NULL | Event category (see event types below) |
| `payload` | JSON | NOT NULL | Event-specific data |
| `metadata` | JSON | NULLABLE | Additional context (agent version, etc.) |

**Event Types** (by topic):

**`student-queries` topic**:
```json
{
  "event_type": "student.query.submitted",
  "payload": {
    "query_text": "Explain recursion",
    "query_type": "text",
    "code_snippet": null,
    "context": {"skill_level": "beginner"}
  }
}
```

**`triage-routing` topic**:
```json
{
  "event_type": "triage.routing.decision",
  "payload": {
    "query_id": "550e8400-...",
    "target_agent": "concepts",
    "confidence": 0.95,
    "reasoning": "Question asks for concept explanation"
  }
}
```

**`agent-responses` topic**:
```json
{
  "event_type": "agent.response.completed",
  "payload": {
    "query_id": "550e8400-...",
    "agent_name": "concepts",
    "response_text": "Recursion is...",
    "processing_time_ms": 4823,
    "confidence": 0.98
  }
}
```

**`student-struggle` topic**:
```json
{
  "event_type": "student.struggle.detected",
  "payload": {
    "topic": "recursion",
    "struggle_level": "high",
    "query_count": 4,
    "time_window_minutes": 15,
    "recommendation": "Suggest 1-on-1 session"
  }
}
```

**`mastery-level-updated` topic**:
```json
{
  "event_type": "mastery.level.updated",
  "payload": {
    "topic": "loops",
    "old_level": 0.75,
    "new_level": 0.88,
    "reason": "Successfully completed 3 loop exercises"
  }
}
```

**Validation Rules**:
- `message_id` and `trace_id` must be valid UUIDs
- `timestamp` must be ISO 8601 format
- `payload` must match event_type schema
- `schema_version` allows backward compatibility checks

**Partition Key**: `student_id` (ensures ordering per student)

---

## 3. Database Schema (PostgreSQL)

### 3.1 Schema Definition

```sql
-- Students table
CREATE TABLE students (
    student_id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL CHECK (email LIKE '%@%.%'),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    learning_style VARCHAR(50) DEFAULT 'step-by-step' CHECK (learning_style IN ('visual', 'auditory', 'kinesthetic', 'step-by-step', 'example-driven')),
    skill_level VARCHAR(50) DEFAULT 'beginner' CHECK (skill_level IN ('beginner', 'intermediate', 'advanced')),
    active BOOLEAN DEFAULT TRUE
);

-- Query history table
CREATE TABLE query_history (
    query_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id VARCHAR(255) NOT NULL REFERENCES students(student_id) ON DELETE CASCADE,
    query_text TEXT NOT NULL CHECK (LENGTH(TRIM(query_text)) >= 1 AND LENGTH(query_text) <= 5000),
    query_vector tsvector,
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    detected_intent VARCHAR(50) CHECK (detected_intent IN ('concepts', 'code_review', 'debug', 'exercise', 'progress')),
    routed_to_agent VARCHAR(50) NOT NULL CHECK (routed_to_agent IN ('concepts', 'code-review', 'debug', 'exercise', 'progress')),
    status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
    triage_confidence DECIMAL(3,2) CHECK (triage_confidence BETWEEN 0.0 AND 1.0),
    code_snippet TEXT CHECK (LENGTH(code_snippet) <= 10000),
    language VARCHAR(50) CHECK (language IN ('python', 'javascript', 'java', 'cpp', 'go', 'rust')),
    context JSONB
);

-- Agent responses table
CREATE TABLE agent_responses (
    response_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    query_id UUID NOT NULL UNIQUE REFERENCES query_history(query_id) ON DELETE CASCADE,
    agent_type VARCHAR(50) NOT NULL CHECK (agent_type IN ('concepts', 'code-review', 'debug', 'exercise', 'progress')),
    response_text TEXT NOT NULL CHECK (LENGTH(TRIM(response_text)) >= 10),
    response_type VARCHAR(50) NOT NULL CHECK (response_type IN ('explanation', 'code_review', 'debug_solution', 'exercise', 'progress_report')),
    processing_time_ms INTEGER NOT NULL CHECK (processing_time_ms > 0),
    confidence_score DECIMAL(3,2) CHECK (confidence_score BETWEEN 0.0 AND 1.0),
    code_examples TEXT[],
    metadata JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    claude_model VARCHAR(100) NOT NULL,
    token_count INTEGER CHECK (token_count > 0)
);

-- Student progress table
CREATE TABLE student_progress (
    student_id VARCHAR(255) PRIMARY KEY REFERENCES students(student_id) ON DELETE CASCADE,
    python_mastery_levels JSONB NOT NULL DEFAULT '{}',
    completed_exercises INTEGER DEFAULT 0 CHECK (completed_exercises >= 0),
    topics_mastered TEXT[] DEFAULT '{}',
    topics_covered TEXT[] DEFAULT '{}',
    strengths TEXT[],
    weaknesses TEXT[],
    learning_velocity DECIMAL(3,2) CHECK (learning_velocity >= 0),
    total_queries INTEGER DEFAULT 0 CHECK (total_queries >= 0),
    queries_by_type JSONB DEFAULT '{}',
    last_activity TIMESTAMP NOT NULL DEFAULT NOW(),
    struggle_topics TEXT[],
    achievements TEXT[] DEFAULT '{}',
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Message flow table
CREATE TABLE message_flow (
    message_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    trace_id UUID NOT NULL,
    query_id UUID NOT NULL REFERENCES query_history(query_id) ON DELETE CASCADE,
    source_agent VARCHAR(50) NOT NULL,
    destination_agent VARCHAR(50) NOT NULL,
    message_content TEXT NOT NULL,
    message_type VARCHAR(50) NOT NULL CHECK (message_type IN ('routing_decision', 'request', 'response', 'collaboration')),
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    sequence_order INTEGER NOT NULL CHECK (sequence_order > 0),
    CHECK (source_agent <> destination_agent)
);

-- Exercises table
CREATE TABLE exercises (
    exercise_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    topic VARCHAR(100) NOT NULL,
    difficulty VARCHAR(20) NOT NULL CHECK (difficulty IN ('beginner', 'intermediate', 'advanced')),
    problem_text TEXT NOT NULL CHECK (LENGTH(problem_text) <= 1000),
    solution_code TEXT NOT NULL,
    starter_code TEXT,
    test_cases JSONB NOT NULL,
    hints TEXT[],
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    created_by_agent VARCHAR(50) DEFAULT 'exercise',
    language VARCHAR(50) NOT NULL CHECK (language IN ('python', 'javascript', 'java')),
    tags TEXT[]
);

-- Indexes
CREATE UNIQUE INDEX idx_student_email ON students(email);
CREATE INDEX idx_student_active ON students(active, created_at DESC);

CREATE INDEX idx_student_queries ON query_history(student_id, timestamp DESC);
CREATE INDEX idx_query_status ON query_history(status, timestamp DESC);
CREATE INDEX idx_query_vector ON query_history USING GIN(query_vector);
CREATE INDEX idx_query_agent ON query_history(routed_to_agent, timestamp DESC);

CREATE INDEX idx_response_query ON agent_responses(query_id);
CREATE INDEX idx_response_agent ON agent_responses(agent_type, created_at DESC);
CREATE INDEX idx_response_time ON agent_responses(processing_time_ms);

CREATE INDEX idx_progress_updated ON student_progress(updated_at DESC);
CREATE INDEX idx_mastery_levels ON student_progress USING GIN(python_mastery_levels);
CREATE INDEX idx_topics_covered ON student_progress USING GIN(topics_covered);

CREATE INDEX idx_message_trace ON message_flow(trace_id, sequence_order);
CREATE INDEX idx_message_query ON message_flow(query_id, timestamp);
CREATE INDEX idx_message_agents ON message_flow(source_agent, destination_agent);

CREATE INDEX idx_exercise_topic ON exercises(topic, difficulty);
CREATE INDEX idx_exercise_tags ON exercises USING GIN(tags);

-- Trigger to update query_vector on insert/update
CREATE OR REPLACE FUNCTION update_query_vector() RETURNS TRIGGER AS $$
BEGIN
    NEW.query_vector := to_tsvector('english', NEW.query_text);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER query_vector_update
    BEFORE INSERT OR UPDATE ON query_history
    FOR EACH ROW
    EXECUTE FUNCTION update_query_vector();

-- Trigger to update student_progress.updated_at
CREATE OR REPLACE FUNCTION update_progress_timestamp() RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at := NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER progress_timestamp_update
    BEFORE UPDATE ON student_progress
    FOR EACH ROW
    EXECUTE FUNCTION update_progress_timestamp();
```

---

## 4. Dapr State Store Keys

### 4.1 Key Patterns

| Key Pattern | Example | Purpose | TTL |
|-------------|---------|---------|-----|
| `progress:student:<id>` | `progress:student:student-123` | Student learning progress | No expiry |
| `progress:query:<id>` | `progress:query:550e8400-...` | Query metadata | 90 days |
| `concepts:cache:<hash>` | `concepts:cache:sha256abc123` | Cached concept explanations | 7 days |
| `agents:health:<name>` | `agents:health:triage` | Agent health metrics | No expiry (ephemeral) |
| `triage:metrics` | `triage:metrics` | Triage agent metrics | No expiry |

### 4.2 Access Patterns

**Save State**:
```python
from dapr.clients import DaprClient

with DaprClient() as client:
    client.save_state(
        store_name="learnflow-state",
        key=f"progress:student:{student_id}",
        value=json.dumps(progress_data),
        state_metadata={"ttlInSeconds": "7776000"}  # 90 days
    )
```

**Get State**:
```python
with DaprClient() as client:
    state = client.get_state(
        store_name="learnflow-state",
        key=f"progress:student:{student_id}"
    )
    return json.loads(state.data) if state.data else {}
```

---

## 5. Kafka Topic Schemas

### 5.1 Topic Configuration

| Topic | Partitions | Replication | Retention | Purpose |
|-------|------------|-------------|-----------|---------|
| `student-queries` | 12 | 3 | 7 days | Student query submissions |
| `triage-routing` | 12 | 3 | 24 hours | Triage routing decisions |
| `concepts-requests` | 6 | 3 | 24 hours | Requests to Concepts Agent |
| `code-review-requests` | 6 | 3 | 24 hours | Requests to Code Review Agent |
| `debug-requests` | 6 | 3 | 24 hours | Requests to Debug Agent |
| `exercise-requests` | 6 | 3 | 24 hours | Requests to Exercise Generator |
| `progress-requests` | 6 | 3 | 24 hours | Requests to Progress Tracker |
| `agent-responses` | 12 | 3 | 7 days | All agent responses |
| `agent-logs` | 6 | 2 | 24 hours | Real-time agent activity logs |
| `student-struggle` | 6 | 2 | 24 hours | Struggle detection alerts |
| `mastery-level-updated` | 6 | 2 | 24 hours | Mastery level changes |

### 5.2 Message Schemas

See section 2.8 (KafkaMessage) for detailed schemas per event type.

---

## 6. Entity Relationships (ERD)

```
┌─────────────┐
│  Student    │
└──────┬──────┘
       │ 1
       │
       │ *
┌──────▼──────────┐      1:1      ┌──────────────────┐
│ StudentQuery    ├───────────────►│ AgentResponse    │
└──────┬──────────┘                └──────────────────┘
       │ *
       │
       │ 1
┌──────▼──────────┐
│ MessageFlow     │
└─────────────────┘

       │ 1
       │
       │ 1
┌──────▼──────────┐
│LearningProgress │
└─────────────────┘

┌─────────────────┐
│   Exercise      │ (Generated by Exercise Generator)
└─────────────────┘

┌─────────────────┐
│AgentHealthMetrics│ (Ephemeral, Dapr State)
└─────────────────┘
```

---

## 7. Data Validation Summary

| Entity | Key Validations |
|--------|----------------|
| StudentQuery | `query_text` not empty, `routed_to_agent` valid, `triage_confidence` 0.0-1.0 |
| AgentResponse | `response_text` min 10 chars, `confidence_score` 0.0-1.0, `processing_time_ms` > 0 |
| Student | `email` valid format, `name` not empty |
| LearningProgress | `mastery_levels` values 0.0-1.0, `total_queries` >= 0 |
| AgentHealthMetrics | `last_heartbeat` within 30s, `status` valid enum |
| MessageFlow | `source_agent` ≠ `destination_agent`, `sequence_order` sequential |
| Exercise | `test_cases` min 3, `solution_code` passes all tests |
| KafkaMessage | `message_id` and `trace_id` valid UUIDs, `payload` matches event schema |

---

## 8. Performance Considerations

### 8.1 Database Indexes

All high-traffic queries are indexed:
- Student queries by `student_id` + `timestamp` (dashboard query history)
- Responses by `agent_type` + `created_at` (agent performance metrics)
- Progress by `updated_at` (recent activity tracking)
- Full-text search on `query_text` via GIN index

### 8.2 Kafka Partitioning

Partitioning by `student_id` ensures:
- Ordering: All messages from a student processed sequentially
- Load balancing: Students evenly distributed across partitions
- Scalability: Add more consumer replicas without code changes

### 8.3 Dapr State Caching

- Student progress cached in Dapr State Store for fast access
- PostgreSQL acts as source of truth
- Cache invalidation on progress updates

---

## Conclusion

This data model defines all entities, storage mechanisms, relationships, and validation rules for the LearnFlow platform. The hybrid storage approach (PostgreSQL for persistent data, Kafka for events, Dapr State for ephemeral data) balances consistency, scalability, and performance.

**Next Steps**:
- Generate API contracts (OpenAPI specs) in `contracts/` directory
- Validate schemas with sample data
- Create database migration scripts
